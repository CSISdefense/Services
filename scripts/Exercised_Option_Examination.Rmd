---
title: "Exercised Option Exaination"
author: "Greg Sanders"
date: "July 7, 2019"
output: 
  html_document: 
    fig_caption: yes
    keep_md: yes
    number_sections: yes
    toc: yes
---


#Setup
```{r Libraries, echo = FALSE, message=FALSE,warning=FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(knitr)



source("https://raw.githubusercontent.com/CSISdefense/Vendor/master/Scripts/DIIGstat.r")

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40
memory.limit()

```

# Before Cleaning
```{r vargraphs: SteadyScopeOptionGrowthAlone, echo = FALSE}
#load("../data/clean/transformed_def_serv.Rdata")

load(file="../data/clean/defense_services_complete.Rdata")

load(file="..\\data\\semi_clean\\opt_pre_clean.rdata")
  
opt_preclean<-def_serv %>% filter(SteadyScopeOptionGrowthAlone>0 &
                                     AnyUnmodifiedUnexercisedOptions ==1 &
                                       MinOfSignedDate>=as.Date("2008-01-01") &
                                       MinOfSignedDate<=as.Date("2015-12-31"))


summary(opt_preclean$SteadyScopeOptionGrowthAlone)

opt_preclean$p_SteadyScopeOptionGrowthAlone<-((opt_preclean$SteadyScopeOptionGrowthAlone-1)/
                          opt_preclean$UnmodifiedBase)+1
# opt_preclean$qp_OptGrowth<-Hmisc::cut2(opt_preclean$p_SteadyScopeOptionGrowthAlone-1,c(1,10))
# summary(opt_preclean$qp_OptGrowth)
opt_preclean$qp_OptGrowth<-Hmisc::cut2(opt_preclean$p_SteadyScopeOptionGrowthAlone-1,c(1,10))


highroundedcutoffs<-c(15000,100000,1000000,10000000,75000000)
    
opt_preclean$qHighBase <- Hmisc::cut2(opt_preclean$UnmodifiedBase,cuts=highroundedcutoffs)
rm(highroundedcutoffs)#lowroundedcutoffs,


if (all(levels(opt_preclean$qHighBase)[1:5]==c("[0.00e+00,1.50e+04)",
                                               "[1.50e+04,1.00e+05)",
                                               "[1.00e+05,1.00e+06)",
                                               "[1.00e+06,1.00e+07)",
                                               "[1.00e+07,7.50e+07)"))|
    all(levels(opt_preclean$qHighBase)[1:5]==c("[0.0e+00,1.5e+04)",
                                               "[1.5e+04,1.0e+05)",
                                               "[1.0e+05,1.0e+06)",
                                               "[1.0e+06,1.0e+07)",
                                               "[1.0e+07,7.5e+07)"))
){
  opt_preclean$qHighBase<-factor(opt_preclean$qHighBase,
                                 
                                 levels=levels(opt_preclean$qHighBase),
                                 labels=c("[0,15k)",
                                          "[15k,100k)",
                                          "[100k,1m)",
                                          "[1m,10m)",
                                          "[10m,75m)",
                                          "[75m+]"),
                                 ordered=TRUE
  )
}

summary(opt_preclean$qHighBase)
```



## Examining Base and Exercised Modifications

### Outlier Labeling

```{r OptionsOutlier_pre}
summary(Hmisc::cut2(opt_preclean$p_SteadyScopeOptionGrowthAlone-1,c(1,
                                                 5,
                                          10,
                                          100
                                          )))

summary(opt_preclean$qHighBase[(opt_preclean$p_SteadyScopeOptionGrowthAlone-1)>10 & opt_preclean$UnmodifiedBase>0 &
                            !is.na(opt_preclean$UnmodifiedBase)])
summary(opt_preclean$qHighBase[(opt_preclean$p_SteadyScopeOptionGrowthAlone-1)>100 & opt_preclean$UnmodifiedBase>0&
                            !is.na(opt_preclean$UnmodifiedBase)])


nrow(opt_preclean %>% filter((p_SteadyScopeOptionGrowthAlone-1)>100 & UnmodifiedBase<=0))

opt_preclean$Why_Outlier<-NA
opt_preclean$Why_Outlier[opt_preclean$UnmodifiedBase<=0 |
                           is.na(opt_preclean$UnmodifiedBase<=0 )]<-"No Unmodified Base"
opt_preclean$Why_Outlier[is.na(opt_preclean$Why_Outlier)&
                            opt_preclean$Action_Obligation*2>=opt_preclean$UnmodifiedBase+
                            opt_preclean$SteadyScopeOptionGrowthAlone]<-
  "Obligations at least half Base+Opt"
opt_preclean$Why_Outlier[is.na(opt_preclean$Why_Outlier)&
                            opt_preclean$Action_Obligation*2>=
                            (opt_preclean$UnmodifiedBase+
                               opt_preclean$SteadyScopeOptionGrowthAlone+opt_preclean$AdminOptionModification)]<-
  "At Least 1/2 After Admin Rescision"
opt_preclean$Why_Outlier[is.na(opt_preclean$Why_Outlier)&
                            opt_preclean$Action_Obligation*2>=
                            (opt_preclean$UnmodifiedBase+
                               opt_preclean$SteadyScopeOptionGrowthAlone+opt_preclean$ChangeOrderOptionModification)]<-
  "At Least 1/2 After Steady Scope Rescision"
opt_preclean$Why_Outlier[is.na(opt_preclean$Why_Outlier)&
                            opt_preclean$Action_Obligation*2>=
                            (opt_preclean$UnmodifiedBase+
                               opt_preclean$SteadyScopeOptionGrowthAlone+opt_preclean$SteadyScopeOptionRescision)]<-
  "At Least 1/2 After Change Order Rescision"
opt_preclean$Why_Outlier[is.na(opt_preclean$Why_Outlier)&
                            opt_preclean$Action_Obligation*2>=
                            (opt_preclean$UnmodifiedBase+
                               opt_preclean$SteadyScopeOptionGrowthAlone+opt_preclean$OtherOptionModification)]<-
  "At Least 1/2 After Other Rescision"
opt_preclean$Why_Outlier[is.na(opt_preclean$Why_Outlier)&
                            opt_preclean$Action_Obligation*2>=
                            (opt_preclean$UnmodifiedBase+
                               opt_preclean$SteadyScopeOptionGrowthAlone+opt_preclean$EndingOptionModification)]<-
  "At Least 1/2 After Ending Rescision"
opt_preclean$Why_Outlier[is.na(opt_preclean$Why_Outlier)&
                            opt_preclean$Office=="W912UM"]<-
  "Korean Office W912UM"
# opt_preclean$Why_Outlier[is.na(opt_preclean$Why_Outlier)&
#                            ((opt_preclean$UnmodifiedBase + opt_preclean$SteadyScopeOptionGrowthAlone) <
#                               opt_preclean$UnmodifiedqHighBase)] <- "Base + Growth < Unmodified Ceil"
opt_preclean$Why_Outlier[is.na(opt_preclean$Why_Outlier)&
                            opt_preclean$SteadyScopeOptionGrowthAlone>=2.5e8]<-
  ">=$250M, Inspect"
opt_preclean$Why_Outlier[is.na(opt_preclean$Why_Outlier)&
                   opt_preclean$p_SteadyScopeOptionGrowthAlone-1<=5]<-
  "<= 5x Options Growth"
opt_preclean$Why_Outlier[is.na(opt_preclean$Why_Outlier)&
                   opt_preclean$p_SteadyScopeOptionGrowthAlone-1>=5 & opt_preclean$p_SteadyScopeOptionGrowthAlone-1<10]<-
  "5x < Options Growth <=10x"
opt_preclean$Why_Outlier[is.na(opt_preclean$Why_Outlier)&
                            opt_preclean$p_SteadyScopeOptionGrowthAlone-1>10]<-
  "Other Unexplained 10x Options Growth"

opt_preclean$Why_Outlier<-factor(opt_preclean$Why_Outlier,
                                  levels=c(
                                    "No Unmodified Base",
                                    "Obligations at least half Base+Opt",
                                    "At Least 1/2 After Admin Rescision",
                                    "At Least 1/2 After Ending Rescision",
                                    "At Least 1/2 After Steady Scope Rescision",
                                    "At Least 1/2 After Change Order Rescision",
                                    "At Least 1/2 After Other Rescision",
                                    "Korean Office W912UM",
                                    "Base + Growth < Unmodified Ceil",
                                    "<= 5x Options Growth",
                                    "5x < Options Growth <=10x",
                                    "Other Unexplained 10x Options Growth",
                                    ">=$250M, Inspect"
                                                                      ))

nrow(opt_preclean[is.na(opt_preclean$Why_Outlier),])
summary(opt_preclean$Why_Outlier)

p_outlier_summary<-opt_preclean %>% filter(p_SteadyScopeOptionGrowthAlone-1>10) %>% group_by(Why_Outlier) %>%
  dplyr::summarise(nContract=length(SteadyScopeOptionGrowthAlone),
                   SumOfExercisedOptions=sum(SteadyScopeOptionGrowthAlone),
                   MaxOfExercisedOptions=max(SteadyScopeOptionGrowthAlone),
                   Action_Obligation=sum(Action_Obligation))


n_outlier_summary<-opt_preclean %>% filter(SteadyScopeOptionGrowthAlone>2.5e8) %>% group_by(Why_Outlier) %>%
  dplyr::summarise(nContract=length(SteadyScopeOptionGrowthAlone),
                   SumOfExercisedOptions=sum(SteadyScopeOptionGrowthAlone),
                   MaxOfExercisedOptions=max(SteadyScopeOptionGrowthAlone),
                   Action_Obligation=sum(Action_Obligation))


summary(Hmisc::cut2(opt_preclean$SteadyScopeOptionGrowthAlone,c(1e3,
                                           1e6,
                                           1e7,
                                           1e8,
                                           2.5e8,
                                           1e9,
                                           1e10,
                                           2e10
)))
summary(opt_preclean$qHighBase[opt_preclean$SteadyScopeOptionGrowthAlone>=1e6])
summary(opt_preclean$qHighBase[opt_preclean$SteadyScopeOptionGrowthAlone>=1e9])

write.csv(file="..\\Data\\semi_clean\\p_opt_outliers.csv",opt_preclean %>% filter((p_SteadyScopeOptionGrowthAlone-1)>10 & Why_Outlier != "Obligations at least half Base+Opt"),row.names = FALSE)
write.csv(file="..\\Data\\semi_clean\\n_opt_outliers.csv",opt_preclean %>% filter(SteadyScopeOptionGrowthAlone>=2.5e8 & Why_Outlier != "Obligations at least half Base+Opt"),row.names = FALSE)

```
Examining cases of large options growth, `r nrow(opt_preclean %>% filter(p_SteadyScopeOptionGrowthAlone-1>10))` contracts experienced greater than 10 fold growth. An increase of that side strains credulity, even in high risk defense contracting. While by no means impossible, the more likely explaination is a misrecorded base.

The study team broke down the outliers into 6 categories:
`r knitr::kable(p_outlier_summary)`
* No Unmodified Base: Contracts with an base <=0. These are eliminated from the sample as missing data.
* Obligations at least half Base+Opt: For this category, total obligations of the contract were at least half the value of the base plus options growth under exercised options. These contracts have had spending that massively exceeded their original base, so the growth in absolute terrms seems plausible. This category accounts for the majority of outlier spending and an overwhelming majority of all exercised options growth amongst outliers (but less than 10% of total exercised options growth when compared to the full sample).
* Later Deobligated: The change order growth metrics only counts increases. These may simply have been mistaken increases, as when including deobligation the growth no longer exceeded 10x the original base. The number, obligations, and change order growth of these contracts are comparatively small, and thus should not distort the overall data.
* Korean Office W912UM refers to a contracting office that sometimes records base and all options values in Korean Won, approximate exchange rate 1,000 Won : 1 USD. 
* There are `r nrow(opt_preclean %>% dplyr::filter(Why_Outlier ==">=$250M, Inspect" & (p_SteadyScopeOptionGrowthAlone-1)>10))` contracts with options growth of over $250 million that account for hundreds of billions in change order growth. These merit manual inspection.
* Finally a few score contrats have unexplained growth, but remain below the $10M threshold. The quantity and magnitude of these contracts is not sufficient to risk the overall model.

This examination left the study team less confident in percentage growth as a metric, especially in extreme cases, while increasing the study team's confidence in measures of growth in absoute term. In the worst case, simply removing all of the unexplained over  10 million contracts from the sample would reduce the number of contracts by a tiny amount and reduce the spending accounted for by  `r sum(opt_preclean$Action_Obligation_Then_Year[opt_preclean$Why_Outlier ==">=$250M, Inspect"& (opt_preclean$p_SteadyScopeOptionGrowthAlone-1)>10] ,na.rm=TRUE)`.

Shifting the focus to all contracts with absolute growth of at least 250 million, there are far fewer contracts and they all have spent at least half their base+exercised growth value.
`r knitr::kable(n_outlier_summary)`

Inspecting W912UM, either to remove or fix its oversized growth, is an imperative as it accounts for the majority of these contracts or task orders. Even so, there are still `r nrow(opt_preclean %>% filter(Why_Outlier ==">=$250M, Inspect"))` that merit special inspection for given that there growth far outpaces their spending.

### Options Growth
```{r OptionsGrowthGraphs}

(
  ggplot(opt_preclean, aes(x=UnmodifiedBase,y=p_SteadyScopeOptionGrowthAlone-1)) +#,color=qp_OptGrowth
    geom_point(alpha=0.25,shape=".")+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()+
    #+
    geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
    # facet_wrap(~qHighBase,scales="free_y")+#+, space="free_y"
    labs(title="Distribution of Exercised Options",
         y="Percent of Growth in Exercised Options",
         x="Unmodified Contract Base")#,
  # fill="Termination Completion"
)

(
  ggplot(opt_preclean, aes(x=UnmodifiedBase,y=SteadyScopeOptionGrowthAlone)) +#,color=qp_OptGrowth
    geom_point(alpha=0.25,shape=".")+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()+
    #+
    geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
    # facet_wrap(~qHighBase,scales="free_y")+#+, space="free_y"
    labs(title="Distribution of Exercised Options",
         y="Absolute Options Growth",
         x="Unmodified Contract Base")#,
  # fill="Termination Completion"
)


(
  ggplot(opt_preclean, aes(x=UnmodifiedBase+SteadyScopeOptionGrowthAlone,y=Action_Obligation)) +#,color=qp_OptGrowth
    geom_point(alpha=0.25,shape=".")+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()#+
  #+
  #   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
  # # facet_wrap(~qHighBase,scales="free_y")+#+, space="free_y"
  #   labs(title="Distribution of Exercised Options",
  #        y="Percent of Growth in Exercised Options",
  #        x="Unmodified Contract Base")#,
  #        # fill="Termination Completion"
)






(
  ggplot(opt_preclean, aes(x=SteadyScopeOptionGrowthAlone,y=Action_Obligation-UnmodifiedBase)) +#,color=qp_OptGrowth
    geom_point(alpha=0.25,shape=".")+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()#+
  #+
  #   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
  # # facet_wrap(~qHighBase,scales="free_y")+#+, space="free_y"
  #   labs(title="Distribution of Exercised Options",
  #        y="Percent of Growth in Exercised Options",
  #        x="Unmodified Contract Base")#,
  #        # fill="Termination Completion"
)

(
  ggplot(opt_preclean, aes(x=p_SteadyScopeOptionGrowthAlone,y=Action_Obligation/UnmodifiedBase)) +#,color=qp_OptGrowth
    geom_point(alpha=0.25,shape=".")+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()#+
  #+
  #   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
  # # facet_wrap(~qHighBase,scales="free_y")+#+, space="free_y"
  #   labs(title="Distribution of Exercised Options",
  #        y="Percent of Growth in Exercised Options",
  #        x="Unmodified Contract Base")#,
  #        # fill="Termination Completion"
)


(
  ggplot(opt_preclean, aes(x=p_SteadyScopeOptionGrowthAlone-1,fill=qp_OptGrowth)) +
    geom_histogram(bins=100)+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+
    #+
    geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
    facet_wrap(~qHighBase,scales="free_y")+#+, space="free_y"
    labs(title="Distribution of Exercised Options",
         y="Contract Count",
         x="Percent of Growth in Exercised Options")#,
  # fill="Termination Completion"
)



(
  ggplot(opt_preclean, aes(x=SteadyScopeOptionGrowthAlone,fill=qp_OptGrowth)) +
    geom_histogram(bins=100)+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+
    #+
    geom_vline(xintercept = 1)#+geom_vline(xintercept = 0.1)+
  #facet_grid(NoPreTermObl~.,scales="free_y", space="free_y")+
  # labs(title="Distribution of Contracts with Obligations After Last termination",
  #      y="Contract Count",
  #      x="Percent of Obligations After Day of Termination",
  #      fill="Termination Completion"
)

(
  ggplot(opt_preclean, aes(x=SteadyScopeOptionGrowthAlone,fill=qp_OptGrowth)) +
    geom_histogram(bins=100)+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+
    #+
    geom_vline(xintercept = 1)+
    facet_wrap(~qHighBase,scales="free_y")#+, space="free_y"
  #+geom_vline(xintercept = 0.1)+
  #facet_grid(NoPreTermObl~.,scales="free_y", space="free_y")+
  # labs(title="Distribution of Contracts with Obligations After Last termination",
  #      y="Contract Count",
  #      x="Percent of Obligations After Day of Termination",
  #      fill="Termination Completion"
)


```





## Adjusting options growth
### Inspections 
#### >250 Inspect
```{r gt250m, echo=FALSE}
inspect250<-opt_preclean %>% filter(!Why_Outlier %in% 
                                       c("Obligations at least half Base+Opt","Korean Office W912UM") &
                                       SteadyScopeOptionGrowthAlone >= 2.5e8)


override<-read.delim(file="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/contract/CSIS_contract_inspection.csv", sep=",") 
inspect250<-left_join(inspect250,override,by="CSIScontractID")
if(any(is.na(inspect250$CSIS_inspection))) stop(paste("Contract without CSIS_inspection label:",
                                                paste((unique(inspect250$CSIScontractID[is.na(inspect250$CSIS_inspection)])),
                                                      collapse=", ")))


summary(inspect250$Why_Outlier)

inspect250trans<-read.delim(file="..\\data\\semi_clean\\exercised_opt_outliers.txt", sep="\t")

inspect250trans %>% group_by(CSIScontractID)

inspect250trans<-left_join(inspect250  %>% 
                             dplyr::select(CSIScontractID,
                                           Why_Outlier),
                           inspect250trans, 
                           by="CSIScontractID")


if(any(is.na(inspect250trans$piid))) stop(paste("Missing CSIScontractIDs in exercised_opt_outliers.txt:",
                                                paste((unique(inspect250trans$CSIScontractID[is.na(inspect250trans$piid)])),
                                                      collapse=", ")))

write.csv(file="..\\data\\semi_clean\\gt250m_exercised_opt_outliers_why_origin.csv", 
          inspect250trans,
          row.names = FALSE)

```
Iniitial criteria involved only 4 contracts demonstrate absolute growth >=\$250M, but are coded instead as 'Obligations at least half Base+Opt.'  Manual inspection of these makes clear that the growth identified is legitimate, and should be included in the dataset. Updated criteria included slightly more contracts.

**Contract (CSIScontractID):** 8496476
**PIID:** W912UM10C0004 - Firm Fixed Price Federal Contract Award to LG TELECOM CO., LTD.
**Product/Service Code (ProdServ):** R699
**NAICS Code (NAICS):** 519190
This one won't end up in the sample because of a ceiling in Won,  though the base appears to have been in USD and both options growth and ceiling growth are adjusted to reasonable levels thanks to an other administrative modification. No detail is given on that specific mod aside from the description of COMMERCIAL DATA CIRCUIT CONNECTIVITY-3RD OPTION YEAR EXERCISE that applies to most of  the contract.



**Contract (CSIScontractID):** 
**PIID:** 
**Product/Service Code (ProdServ):** 
**NAICS Code (NAICS):** 

#### Other Unexplained x10 Inspect
The contracts coded as 'other unexplained' above were inspected manually given their relative scarcity.  Several were found to contain suspect transactions that were later corrected, meaning the option growth value will be set as NA in the datasets and the contracts excluded from our sample, which will occur through use of the CSIS360 repository, and the lookup table "contract/override_lookup.csv" in contract folder of the CSISdefense/Lookup-Tables repository.


```{r gt10x}
summary(opt_preclean$Why_Outlier)
inspect10x<-opt_preclean %>% filter(!Why_Outlier %in% c("Obligations at least half Base+Opt",
                                                        "Korean Office W912UM",
                                                        "No Unmodified Base")&
                                      (p_SteadyScopeOptionGrowthAlone-1)>10)
colnames(inspect10x)[colnames(inspect10x)=="UnmodifiedBase"]<-"Base"

summary(inspect10x$Why_Outlier)



override<-read.delim(file="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/contract/CSIS_contract_inspection.csv", sep=",")
inspect10x<-left_join(inspect10x,override,by="CSIScontractID")
# if(any(is.na(inspect10x$CSIS_inspection))) stop(paste("Contract without CSIS_inspection label:",
#                                                 paste((unique(inspect10x$CSIScontractID[is.na(inspect10x$CSIS_inspection)])),
#                                                       collapse=", ")))


knitr::kable(inspect10x%>% group_by(CSIScontractID) %>% dplyr::select(CSIScontractID,
                                         Base,
                                         SteadyScopeOptionGrowthAlone,
                                         SteadyScopeOptionGrowthMixed,
                                         SteadyScopeOptionRescision,
                                         ChangeOrderOptionModification,
                                         EndingOptionModification,
                                         OtherOptionModification,
                                         # Action_Obligation,
                                         # Deobligations
                                         CSIS_inspection
                                         ),format.args = list(big.mark=","))




inspect10xtrans<-read.delim(file="..\\data\\semi_clean\\exercised_opt_outliers.txt", sep="\t",quote="")
inspect10xtrans<-inspect10xtrans %>% filter(CSIScontractID %in% inspect10x$CSIScontractID)
inspect10xtrans<-left_join(inspect10x %>% dplyr::select(CSIScontractID,CSIS_inspection,Why_Outlier),inspect10xtrans,
                           by="CSIScontractID")
# if(any(is.na(inspect10xtrans$CSIS_inspection))) stop("Transaction without CSIS_inspection label")
if(any(is.na(inspect10xtrans$piid))) stop(paste("Missing CSIScontractIDs in exercised_opt_outliers.txt:",
                                                paste((unique(inspect10xtrans$CSIScontractID[is.na(inspect10xtrans$piid)])),
                                                      collapse=", ")))

write.csv(file="..\\data\\semi_clean\\gt10x_exercised_opt_outliers_why_origin.csv", 
          inspect10xtrans,
          row.names = FALSE)


#Bi kibger becessary thanks to updated queries.
# transk<-inspect10xtrans %>% group_by(CSIScontractID) %>%
#   dplyr::summarise(nTransaction=length(CSIStransactionID),
#     SumOfBaseAndExercisedOptions=sum(baseandexercisedoptionsvalue,na.rm=TRUE),
#     GrossBaseAndExercisedOptions=sum(ifelse(baseandexercisedoptionsvalue>0,baseandexercisedoptionsvalue,0),na.rm=TRUE),
#     SteadyScopeOptionRescinded=sum(ifelse(baseandexercisedoptionsvalue<0 & reasonformodification %in% 
#                                       c('B','C','G','M'),baseandexercisedoptionsvalue,0),na.rm=TRUE),
#     EndingOptionModification=sum(ifelse(baseandexercisedoptionsvalue<0 & reasonformodification %in% c('K','E','F','X'),
#                                     baseandexercisedoptionsvalue,0),na.rm=TRUE),
#     OtherOptionReduction=sum(ifelse(baseandexercisedoptionsvalue<0 & !reasonformodification %in% c('B','C','G','M','K','E','F','X'),
#                                     baseandexercisedoptionsvalue,0),na.rm=TRUE),
#                    Deobligations=sum(ifelse(obligatedamount<0,obligatedamount,0),na.rm=TRUE))
# 
# 
# inspect10x<-left_join(inspect10x,transk, by="Why_Outlier")
# rm(transk)

# p_inspect_summary<-inspect10x %>% group_by(CSIS_inspection) %>%
#   dplyr::summarise(nContract=length(CSIScontractID),
#                    # nTransaction=sum(nTransaction),
#                    Base=sum(Base),
#     SteadyScopeOptionGrowthAlone=sum(SteadyScopeOptionGrowthAlone),
#     SteadyScopeOptionGrowthAlone=sum(SteadyScopeOptionGrowthAlone),
#     SteadyScopeOptionRescision=sum(SteadyScopeOptionRescision),
#     EndingOptionModification=sum(EndingOptionModification),
#     OtherOptionReduction=sum(OtherOptionReduction),
#     Action_Obligation=sum(Action_Obligation,na.rm=TRUE),
#     Deobligations=sum(Deobligations,na.rm=TRUE)  )
# 
# knitr::kable(p_inspect_summary,format.args = list(big.mark=","))





```


### Considering Alternate Labeling Systems

```{r Alternate_Label}

summary(opt_preclean$Why_Outlier)
# Step 1, Steady Scope Option Growth
opt_preclean$n_OptGrowth_test <- opt_preclean$SteadyScopeOptionGrowthAlone
opt_preclean$p_OptGrowth_test <- opt_preclean$n_OptGrowth_test/opt_preclean$UnmodifiedBase


#File Pre-processed and Loaded
opt_preclean$qp_OptGrowth<-Hmisc::cut2(opt_preclean$p_SteadyScopeOptionGrowthAlone-1,c(0,1e-10,1,10))
summary(opt_preclean$qp_OptGrowth)
#save(W912UM,W912UMtrans,opt_preclean,file="..\\data\\semi_clean\\opt_pre_clean.rdata")


# Step 2, No non-whole number base
opt_preclean$p_OptGrowth_test <- opt_preclean$n_OptGrowth_test/ifelse(opt_preclean$UnmodifiedBase>0,
                                                    opt_preclean$UnmodifiedBase,NA)
opt_preclean$qp_OptGrowth <-Hmisc::cut2(opt_preclean$p_OptGrowth_test,c(0,1,5,10))
opt_preclean$qp_OptGrowth<-factor(opt_preclean$qp_OptGrowth,levels=c(levels(opt_preclean$qp_OptGrowth),"W912UM"))
opt_preclean$qp_OptGrowth[opt_preclean$Office=="W912UM"]<-"W912UM"
summary(opt_preclean$qp_OptGrowth)

opt_preclean %>% group_by(qp_OptGrowth) %>% dplyr::summarise(
  nContract=length(CSIScontractID),
  OblOverBase=sum(ifelse(Action_Obligation>UnmodifiedBase,1,0)/length(CSIScontractID)),
  AvgOblToBase=mean(Action_Obligation/UnmodifiedBase,na.rm=TRUE),
  # MaxOfSteadyScopeOptionGrowthAlone=max(SteadyScopeOptionGrowthAlone),
  OblM=sum(Action_Obligation)/1000000,
  SumOfn_OptGrowthM=sum(n_OptGrowth_test)/1000000,
  SumOfCOCGM=sum(SteadyScopeOptionGrowthAlone)/1000000,
  AvgOfp_OptGrowth=mean(p_OptGrowth_test,na.rm=TRUE),
  AvgOfp_COCG=mean(p_SteadyScopeOptionGrowthAlone,na.rm=TRUE))
  

#Step 3 Rescinding Net-Negative Admin Adjustments

opt_preclean$n_OptGrowth_test <- opt_preclean$SteadyScopeOptionGrowthAlone + ifelse(opt_preclean$AdminOptionModification<0,
                                                      opt_preclean$AdminOptionModification,0)

opt_preclean$p_OptGrowth_test <- opt_preclean$n_OptGrowth_test/ifelse(opt_preclean$UnmodifiedBase>0,
                                                    opt_preclean$UnmodifiedBase,NA)
opt_preclean$qp_OptGrowth <-Hmisc::cut2(opt_preclean$p_OptGrowth_test,c(0,1,5,10))
opt_preclean$qp_OptGrowth<-factor(opt_preclean$qp_OptGrowth,levels=c(levels(opt_preclean$qp_OptGrowth),"W912UM"))
opt_preclean$qp_OptGrowth[opt_preclean$Office=="W912UM"]<-"W912UM"

opt_preclean %>% group_by(qp_OptGrowth) %>% dplyr::summarise(
  nContract=length(CSIScontractID),
  OblOverBase=sum(ifelse(Action_Obligation>UnmodifiedBase,1,0)/length(CSIScontractID)),
  AvgOblToBase=mean(Action_Obligation/UnmodifiedBase,na.rm=TRUE),
  # MaxOfSteadyScopeOptionGrowthAlone=max(SteadyScopeOptionGrowthAlone),
  OblM=sum(Action_Obligation)/1000000,
  SumOfn_OptGrowthM=sum(n_OptGrowth_test)/1000000,
  SumOfCOCGM=sum(SteadyScopeOptionGrowthAlone)/1000000,
  AvgOfp_OptGrowth=mean(p_OptGrowth_test,na.rm=TRUE),
  AvgOfp_COCG=mean(p_SteadyScopeOptionGrowthAlone,na.rm=TRUE))




#Step 4 Rescinding Net-Negative Steady Scope Adjustments
opt_preclean$n_OptGrowth_test <- opt_preclean$SteadyScopeOptionGrowthAlone +
  ifelse(opt_preclean$SteadyScopeOptionRescision+opt_preclean$AdminOptionModification<0,
         opt_preclean$SteadyScopeOptionRescision+opt_preclean$AdminOptionModification,0)

opt_preclean$p_OptGrowth_test <- opt_preclean$n_OptGrowth_test/ifelse(opt_preclean$UnmodifiedBase>0,
                                                    opt_preclean$UnmodifiedBase,NA)

opt_preclean$qp_OptGrowth <-Hmisc::cut2(opt_preclean$p_OptGrowth_test,c(0,1,5,10))
opt_preclean$qp_OptGrowth<-factor(opt_preclean$qp_OptGrowth,levels=c(levels(opt_preclean$qp_OptGrowth),"W912UM"))
opt_preclean$qp_OptGrowth[opt_preclean$Office=="W912UM"]<-"W912UM"

opt_preclean %>% group_by(qp_OptGrowth) %>% dplyr::summarise(
  nContract=length(CSIScontractID),
  OblOverBase=sum(ifelse(Action_Obligation>UnmodifiedBase,1,0)/length(CSIScontractID)),
  AvgOblToBase=mean(Action_Obligation/UnmodifiedBase,na.rm=TRUE),
  # MaxOfSteadyScopeOptionGrowthAlone=max(SteadyScopeOptionGrowthAlone),
  OblM=sum(Action_Obligation)/1000000,
  SumOfn_OptGrowthM=sum(n_OptGrowth_test)/1000000,
  SumOfCOCGM=sum(SteadyScopeOptionGrowthAlone)/1000000,
  AvgOfp_OptGrowth=mean(p_OptGrowth_test,na.rm=TRUE),
  AvgOfp_COCG=mean(p_SteadyScopeOptionGrowthAlone,na.rm=TRUE))


#Step 4 Change Order Rescisions  
opt_preclean$n_OptGrowth_test <- opt_preclean$SteadyScopeOptionGrowthAlone +
  ifelse(opt_preclean$SteadyScopeOptionRescision+opt_preclean$AdminOptionModification+
           opt_preclean$SteadyScopeOptionGrowthMixed<0,
         opt_preclean$SteadyScopeOptionRescision+opt_preclean$AdminOptionModification+
           opt_preclean$SteadyScopeOptionGrowthMixed,0)

opt_preclean$p_OptGrowth_test <- opt_preclean$n_OptGrowth_test/ifelse(opt_preclean$UnmodifiedBase>0,
                                                    opt_preclean$UnmodifiedBase,NA)

opt_preclean$qp_OptGrowth <-Hmisc::cut2(opt_preclean$p_OptGrowth_test,c(0,1,5,10))
opt_preclean$qp_OptGrowth<-factor(opt_preclean$qp_OptGrowth,levels=c(levels(opt_preclean$qp_OptGrowth),"W912UM"))
opt_preclean$qp_OptGrowth[opt_preclean$Office=="W912UM"]<-"W912UM"

opt_preclean %>% group_by(qp_OptGrowth) %>% dplyr::summarise(
  nContract=length(CSIScontractID),
  OblOverBase=sum(ifelse(Action_Obligation>UnmodifiedBase,1,0)/length(CSIScontractID)),
  AvgOblToBase=mean(Action_Obligation/UnmodifiedBase,na.rm=TRUE),
  # MaxOfSteadyScopeOptionGrowthAlone=max(SteadyScopeOptionGrowthAlone),
  OblM=sum(Action_Obligation)/1000000,
  SumOfn_OptGrowthM=sum(n_OptGrowth_test)/1000000,
  SumOfCOCGM=sum(SteadyScopeOptionGrowthAlone)/1000000,
  AvgOfp_OptGrowth=mean(p_OptGrowth_test,na.rm=TRUE),
  AvgOfp_COCG=mean(p_SteadyScopeOptionGrowthAlone,na.rm=TRUE))

write.csv(file="..\\Data\\semi_clean\\p_opt_outliers_post_cleaning.csv",opt_preclean %>% filter((p_SteadyScopeOptionGrowthAlone-1)>10),row.names = FALSE)
write.csv(file="..\\Data\\semi_clean\\n_opt_outliers_post_cleaning.csv",opt_preclean %>% filter(SteadyScopeOptionGrowthAlone>=2.5e8),row.names = FALSE)
```
After examining the range of results, clearly the adjustment metric that comes closest to the alternate measure of OblOverBase is to adjust SteadyScopeOptionAlone with the sum of SteadyScopeOptionMix, SteadyScopeOptionRecision, and SteadyScopeOtherAdmin. Adding the always >=0 SteadyScopeOptionMix seems to help greatly, likely because many of the rescisions in steady scope or admin are adjusting for mix changes.


### Implementing the change
```{r ImplementingChange}
opt_preclean$n_OptGrowth <- opt_preclean$SteadyScopeOptionGrowthAlone +
  ifelse(opt_preclean$SteadyScopeOptionRescision+opt_preclean$AdminOptionModification+
           opt_preclean$SteadyScopeOptionGrowthMixed<0,
         opt_preclean$SteadyScopeOptionRescision+opt_preclean$AdminOptionModification+
           opt_preclean$SteadyScopeOptionGrowthMixed,0)+1
opt_preclean$n_OptGrowth[opt_preclean$n_OptGrowth<=1 & opt_preclean$SteadyScopeOptionGrowthAlone>0]<-NA
summary(opt_preclean$n_OptGrowth)

opt_preclean$p_SteadyScopeOptionGrowthAlone <- opt_preclean$n_OptGrowth/ifelse(opt_preclean$UnmodifiedBase>0,
                                                    opt_preclean$UnmodifiedBase,NA)+1
summary(opt_preclean$p_SteadyScopeOptionGrowthAlone)

inspect250<-opt_preclean %>% filter(!Why_Outlier %in% 
                                       c("Obligations at least half Base+Opt","Korean Office W912UM") &
                                       n_OptGrowth >= 2.5e8)
nrow(inspect250)

```




# Cleaning


After examination, checking the net steady scope and administrative modifications and, when negative, reducing exercised options by that amount seams to do a reasonable job of seperating those contracts that have genuinely expxerienced real cost overruns from those that may have had an administrative error that wildly overinflated the size of the exercised options This adjustment isn't ideal as it does result in $16 billion of options growth contracts that no longer have a net increase and thus will need to be excluded from the sample, but it also addresses the majority of the 250M plus exercised options algorithmically, which is important as it is  outside the capabilities  of  the studyteam to manually inspect the hordes of smaller contracts.

## Validate Transformed_Dataset
This is a quick inspection to make sure that the version of the transformed dataset to be used is current, focusing on base and steady state options growth.

```{r validate_transformed_dataset}

load(file="../Data/Clean/transformed_def_serv.Rdata")
#Overrides
def_serv<-read_and_join_experiment( def_serv,
                               "CSIS_contract_inspection.csv",
                               path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                               directory="contract/",
                               by=c("CSIScontractID"),
                               # add_var=c("EntityID","UnmodifiedEntityID"),
                               new_var_checked=FALSE,
                               create_lookup_rdata=FALSE
)

#Making sure the transformed dataset has been set to NA 
if(any(!is.na(def_serv$UnmodifiedBase[
  def_serv$override_unmodified_base==TRUE]))){
  stop("Unmodified Base set to be overiden have not been set to NA. Rerun Create_Dataset.R")
}

if(any(!is.na(def_serv$n_OptGrowth_OMB20_GDP18[
  def_serv$override_exercised_growth==TRUE]))){
  stop("Exercised Options set to be overiden have not been set to NA. Rerun Create_Dataset.R")
}


```

# Examining Outliers

```{r OptionsOutlier_post}


grouped_barplot("Opt", def_serv,value_col="Action_Obligation_Then_Year")
statsummary_discrete(c("Opt"), def_serv,value_col="Action_Obligation_Then_Year")
opt<-def_serv %>% filter(b_CBre==1)
opt$qp_OptGrowth<-Hmisc::cut2(opt$p_OptGrowth-1,c(1,10))

highroundedcutoffs<-c(15000,100000,1000000,10000000,75000000)
opt$qHighBase <- Hmisc::cut2(opt$UnmodifiedBase_Then_Year,cuts=highroundedcutoffs)
rm(highroundedcutoffs)#lowroundedcutoffs,


if (all(levels(opt$qHighBase)[1:5]==c("[0.00e+00,1.50e+04)",
                                               "[1.50e+04,1.00e+05)",
                                               "[1.00e+05,1.00e+06)",
                                               "[1.00e+06,1.00e+07)",
                                               "[1.00e+07,7.50e+07)"))|
    all(levels(opt$qHighBase)[1:5]==c("[0.0e+00,1.5e+04)",
                                               "[1.5e+04,1.0e+05)",
                                               "[1.0e+05,1.0e+06)",
                                               "[1.0e+06,1.0e+07)",
                                               "[1.0e+07,7.5e+07)"))
){
  opt$qHighBase<-factor(opt$qHighBase,
                                 
                                 levels=levels(opt$qHighBase),
                                 labels=c("[0,15k)",
                                          "[15k,100k)",
                                          "[100k,1m)",
                                          "[1m,10m)",
                                          "[10m,75m)",
                                          "[75m+]"),
                                 ordered=TRUE
  )
}



opt$Why_Outlier<-NA
opt$Why_Outlier[is.na(opt$UnmodifiedBase_Then_Year)]<-"No Unmodified Base"
opt$Why_Outlier[is.na(opt$Why_Outlier)&
                   opt$Action_Obligation_Then_Year*2>=opt$UnmodifiedBase_Then_Year+
                   opt$n_OptGrowth_Then_Year]<-
  "Obligations at least half Base+Opt"
opt$Why_Outlier[is.na(opt$Why_Outlier)&
                   opt$Office=="W912UM"]<-
  "Korean Office W912UM"
opt$Why_Outlier[is.na(opt$Why_Outlier)&
                   opt$n_OptGrowth_Then_Year>=2.5e8]<-
  ">=$250M, Inspect"
opt$Why_Outlier[is.na(opt$Why_Outlier)&
                   opt$p_OptGrowth-1>10]<-
  "Other Unexplained 10x Options Growth"
opt$Why_Outlier<-factor(opt$Why_Outlier,
                         levels=c(
                           "No Unmodified Base",
                           "Obligations at least half Base+Opt",
                           "Later Deobligated",
                           "Korean Office W912UM",
                           ">=$250M, Inspect",
                           "Other Unexplained 10x Options Growth"
                         ))

#Percent Growth
summary(Hmisc::cut2(opt$p_OptGrowth-1,c(1,
                                             10,
                                             100
)))
summary(Hmisc::cut2(opt$p_OptGrowth-1,c(1,
                                    10,
                                    100
)))

summary(opt$qHighBase[(opt$p_OptGrowth-1)>10])
summary(opt$qHighBase[(opt$p_OptGrowth-1)>100])


p_outlier_summary<-opt %>% filter(p_OptGrowth-1>10) %>% group_by(Why_Outlier) %>%
  dplyr::summarise(nContract=length(n_OptGrowth_Then_Year),
                   SumOfn_OptGrowth=sum(n_OptGrowth_Then_Year),
                   MaxOfn_OptGrowth=max(n_OptGrowth_Then_Year),
                   SumOfAction_Obligation_Then_Year=sum(Action_Obligation_Then_Year))

#Absolute Growth
summary(Hmisc::cut2(opt$n_OptGrowth_Then_Year,c(1e3,
                                           1e6,
                                           1e7,
                                           1e8,
                                           2.5e8,
                                           1e9,
                                           1e10,
                                           2e10
))
)
summary(Hmisc::cut2(opt$n_OptGrowth_Then_Year,c(1e3,
                                  1e6,
                                  1e7,
                                  1e8,
                                  2.5e8,
                                  1e9,
                                  1e10,
                                  2e10
))
)

summary(opt$qHighBase[opt$n_OptGrowth_Then_Year>=1e6])
summary(opt$qHighBase[opt$n_OptGrowth_Then_Year>=1e9])



n_outlier_summary<-opt %>% filter(n_OptGrowth_Then_Year>2.5e8) %>% group_by(Why_Outlier) %>%
  dplyr::summarise(nContract=length(n_OptGrowth_Then_Year),
                   SumOfn_OptGrowth=sum(n_OptGrowth_Then_Year),
                   MaxOfn_OptGrowth=max(n_OptGrowth_Then_Year),
                   SumOfAction_Obligation_Then_Year=sum(Action_Obligation_Then_Year))

```

The cleaning has cut in half the outliers with growth >=100,000,000, although the influence has been much smaller on the percentage growth outliers, reinforcing the choice to switch to absolute growth. The study team chose to set a threshold of Shifting the focus to all contracts with growth of at least 250 million, there are far fewer contracts that account for far more money.
`r knitr::kable(n_outlier_summary)`

After the cleaning, 2 categories remain relevant.

`r knitr::kable(p_outlier_summary)`
* Obligations at least half Orig+CRai: For this category, total obligations of the contract were at least half the value of the base plus options growth under alone steady scope. As before, this category accounts for the overwhelming majority of outlier spending but only a tiny fraction of change order growth.
* There are `r nrow(opt %>% dplyr::filter(Why_Outlier ==">=$250M, Inspect" ))` contracts with options growth of over $250 million that account for hundreds of billions in change order growth. These merit manual inspection.

## Graphs after Cleaning

```{r OptionsGrowthAfterCleaning}

(
  ggplot(opt, aes(x=UnmodifiedBase_Then_Year,y=p_OptGrowth-1)) +#,color=qp_OptGrowth
    geom_point(alpha=0.25,shape=".")+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()+
    #+
    geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
    # facet_wrap(~qHighBase,scales="free_y")+#+, space="free_y"
    labs(title="Distribution of Exercised Options",
         y="Percent of Growth in Exercised Options",
         x="Unmodified Contract Base")#,
  # fill="Termination Completion"
)


(
  ggplot(opt, aes(x=UnmodifiedBase_Then_Year,y=n_OptGrowth_Then_Year)) +#,color=qp_OptGrowth
    geom_point(alpha=0.25,shape=".")+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()+
    #+
    geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
    # facet_wrap(~qHighBase,scales="free_y")+#+, space="free_y"
    labs(title="Distribution of Exercised Options",
         y="Absolute Options Growth",
         x="Unmodified Contract Base")#,
  # fill="Termination Completion"
)

(
  ggplot(opt, aes(x=UnmodifiedBase_Then_Year+n_OptGrowth_Then_Year,
                   y=Action_Obligation_Then_Year)) +#,color=qp_OptGrowth
    geom_point(alpha=0.25,shape=".")+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()#+
  #+
  #   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
  # # facet_wrap(~qHighBase,scales="free_y")+#+, space="free_y"
  #   labs(title="Distribution of Exercised Options",
  #        y="Percent of Growth in Exercised Options",
  #        x="Unmodified Contract Base")#,
  #        # fill="Termination Completion"
)

(
  ggplot(opt, aes(x=n_OptGrowth_Then_Year,
                   y=Action_Obligation_Then_Year-UnmodifiedBase_Then_Year)) +#,color=qp_OptGrowth
    geom_point(alpha=0.25,shape=".")+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()#+
  #+
  #   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
  # # facet_wrap(~qHighBase,scales="free_y")+#+, space="free_y"
  #   labs(title="Distribution of Exercised Options",
  #        y="Percent of Growth in Exercised Options",
  #        x="Unmodified Contract Base")#,
  #        # fill="Termination Completion"
)

# 
(
  ggplot(opt, aes(x=p_OptGrowth-1,
                   y=Action_Obligation_Then_Year/UnmodifiedBase_Then_Year)) +#,color=qp_OptGrowth
    geom_point(alpha=0.25,shape=".")+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()#+
  #+
  #   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
  # # facet_wrap(~qHighBase,scales="free_y")+#+, space="free_y"
  #   labs(title="Distribution of Exercised Options",
  #        y="Percent of Growth in Exercised Options",
  #        x="Unmodified Contract Base")#,
  #        # fill="Termination Completion"
)

(
  ggplot(opt, aes(x=p_OptGrowth-1,fill=qp_OptGrowth)) +
    geom_histogram(bins=100)+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+
    #+
    geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
    facet_wrap(~qHighBase,scales="free_y")+#+, space="free_y"
    labs(title="Distribution of Exercised Options",
         y="Contract Count",
         x="Percent of Growth in Exercised Options")#,
  # fill="Termination Completion"
)

(
  ggplot(opt, aes(x=n_OptGrowth_Then_Year,fill=qp_OptGrowth)) +
    geom_histogram(bins=100)+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+
    #+
    geom_vline(xintercept = 1)#+geom_vline(xintercept = 0.1)+
  #facet_grid(NoPreTermObl~.,scales="free_y", space="free_y")+
  # labs(title="Distribution of Contracts with Obligations After Last termination",
  #      y="Contract Count",
  #      x="Percent of Obligations After Day of Termination",
  #      fill="Termination Completion"
)

(
  ggplot(opt, aes(x=n_OptGrowth_Then_Year,fill=qp_OptGrowth)) +
    geom_histogram(bins=100)+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+ 
    #+
    geom_vline(xintercept = 1)+
    facet_wrap(~qHighBase,scales="free_y")#+, space="free_y"
  #+geom_vline(xintercept = 0.1)+
  #facet_grid(NoPreTermObl~.,scales="free_y", space="free_y")+
  # labs(title="Distribution of Contracts with Obligations After Last termination",
  #      y="Contract Count",
  #      x="Percent of Obligations After Day of Termination",
  #      fill="Termination Completion"
)


```

# Proportion of Options Exercised
```{r OptPropSetup}
if(!exists("def_serv")) load("data/clean/transformed_def_serv.Rdata")
opt<-def_serv[def_serv$AnyUnmodifiedUnexercisedOptions==1,]

```

```{r OptProp}
#Determine original and updated space available 
opt$OptSpaceOriginal<-opt$UnmodifiedCeiling_Then_Year-opt$UnmodifiedBase_Then_Year
summary(opt$OptSpaceOriginal)

opt$OptSpaceUpdated<-opt$UnmodifiedCeiling_Then_Year+opt$ChangeOrderCeilingGrowth+
  opt$AdminCeilingModification+opt$SteadyScopeCeilingModification+opt$OtherCeilingModification-
  opt$UnmodifiedBase_Then_Year
summary(opt$OptSpaceUpdated)
#Not included in the update ceiling.
#ChangeOrderCeilingRescision
#EndingCeilingModification+
#OtherCeilingModification+
summary(opt$Opt)

# colnames(opt)[duplicated(colnames(opt))]
# opt<-opt[,-which(duplicated(colnames(opt)))]
# which(duplicated(colnames(opt)))
opt$OptSpaceUpdated[opt$OptSpaceOriginal>opt$OptSpaceUpdated] <-
  opt$OptSpaceOriginal[opt$OptSpaceOriginal>opt$OptSpaceUpdated]

if(any(colnames(opt)[duplicated(colnames(opt))])) stop("duplicte column names")
#This only works if there's just one duplicated name.
# dupe<-which(colnames(opt) %in% colnames(opt)[duplicated(colnames(opt))])
# opt<-opt[,-c(dupe[2:length(dupe)])]

ggplot(opt,aes(x=OptSpaceOriginal,y=OptSpaceUpdated))+geom_point(alpha=0.01)+scale_x_log10()+scale_y_log10()

#Proportion of options
opt$ExerOriginal<-(opt$n_OptGrowth_Then_Year-1)/opt$OptSpaceOriginal
opt$ExerOriginal[opt$ExerOriginal>1]<-1
summary(opt$ExerOriginal)
ggplot(opt, aes(x=ExerOriginal)) + stat_ecdf(geom = "step")


opt$ExerUpdate<-(opt$ChangeOrderOptionModification+
                        opt$SteadyScopeOptionGrowthAlone+
                        opt$SteadyScopeOptionGrowthMixed+
                        opt$SteadyScopeOptionRescision+
                        opt$AdminOptionModification+
                        opt$OtherOptionModification
                      )/opt$OptSpaceUpdated
opt$ExerUpdate[opt$ExerUpdate>1]<-1
opt$ExerUpdate[opt$ExerUpdate<0]<-0
summary(opt$ExerUpdate)
ggplot(opt, aes(x=ExerUpdate)) + stat_ecdf(geom = "step")

#Excludes opt$EndingOptionModification+
    
opt$Exer<-ifelse(opt$ExerUpdate>opt$ExerOriginal,opt$ExerUpdate,opt$ExerOriginal)
summary(opt$Exer)
ggplot(opt, aes(x=Exer)) + stat_ecdf(geom = "step")

serv_opt_long<-tidyr::gather(opt,OptMeasure,OptGrowth,c(ExerOriginal,ExerUpdate,Exer),factor_key=TRUE)
ggplot(serv_opt_long, aes(x=OptGrowth,color=OptMeasure)) + stat_ecdf(geom = "step")+
  geom_vline(xintercept =c(0.5,0.95),linetype=2)#,0.975

nrow(opt[opt$Exer<=0.000001,])
nrow(opt[opt$n_OptGrowth_Then_Year==0,])
```

Of the two different measures, strictly defined option growth over the original gap between base and ceiling is clearly the more conservative. The first way of measuring outcomes is to allow either measure for reaching All, but only the stricter measure of growth for reaching some. 

The choice to set the maximum threshold at above 0.95 rather than simply 100% is driven by the upward curve near the end of the cumulative distribution function. Because those contracts do appear to stand apart, rounding up seems a reasonable step. Similar approaches are taken for other variables, primarily pricing, where a contract that has the vast majority of obligations under one particular type can still qualify with the cut off for vast majority at that final uptick point.

```{r OptOutcome}

opt$b_AllOpt<-ifelse(opt$Exer>0.95,1,0)
summary(opt$b_AllOpt)
opt$b_SomeOpt_Strict<-ifelse(opt$n_OptGrowth_Then_Year>1,1,0)
summary(opt$b_SomeOpt_Strict)

serv_opt_long<-tidyr::gather(opt,OptMeasure,OptGrowth,c(ExerOriginal,ExerUpdate,Exer),factor_key=TRUE)
ggplot(serv_opt_long, aes(x=OptGrowth,color=OptMeasure)) + stat_ecdf(geom = "step")+
  geom_vline(xintercept =c(0.5,0.95),linetype=2)+facet_wrap(~b_SomeOpt_Strict)



```
The observation that around 10% of contracts that never have any strictly defined option growth. That said, for those graphs that don't meet the strict exercised option standard, it could easily be that the contract ceiling grew by more than the total options exercised did, which could be more indicative of cost growth than the positive options growth this paper seeks to focus on. 

```{r AlternateSomeCriteria}
opt$CeilGrowth<-opt$OptSpaceUpdated-opt$OptSpaceOriginal
opt$b_SomeOpt<-opt$b_SomeOpt_Strict
opt$b_SomeOpt[opt$ChangeOrderOptionModification+
                        opt$SteadyScopeOptionGrowthAlone+
                        opt$SteadyScopeOptionGrowthMixed+
                        opt$SteadyScopeOptionRescision+
                        opt$AdminOptionModification+
                        opt$OtherOptionModification>opt$CeilGrowth]<-1
summary(opt$b_SomeOpt)
summary(opt$b_SomeOpt_Strict)

serv_opt_long<-tidyr::gather(opt,OptMeasure,OptGrowth,c(ExerOriginal,ExerUpdate,Exer),factor_key=TRUE)
ggplot(serv_opt_long, aes(x=OptGrowth,color=OptMeasure)) + stat_ecdf(geom = "step")+
  geom_vline(xintercept =c(0.5,0.95),linetype=2)+facet_wrap(~b_SomeOpt)

if(any(opt$b_SomeOpt==0 & opt$Exer>=1))
   stop("Somehow a contract that does not meet the some criteria has reach 100% exercised.")
opt$b_AllOpt[opt$b_SomeOpt==0]<-0

```
There is now only a tiny minority of contracts (`r nrow(opt[opt$b_SomeOpt==0 & opt$Exer>0.95,])/nrow(opt)`) that meet the criteria for all options exercised without meeting the criteria for some exercised. These contracts are set as not qualify for the all criteria despite having 95% growth.
