---
title: "empty_model_multilevel_check"
author: "Greg Sanders"
date: "August 15, 2018"
output: html_document
---


# Setup
```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(arm)
library(R2WinBUGS)
library(Hmisc)
library(sjstats)
source("https://raw.githubusercontent.com/CSISdefense/Vendor/master/DIIGstat.r")
source("https://raw.githubusercontent.com/CSISdefense/Vendor/master/NAICS.r")

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40


```

## Load in data
```{r Sample}
 load(file="..//data//clean//def_sample.Rdata")
# save(serv_smp,smp1m,file="../data//def_sample.Rdata")



# complete<-!is.na(def$b_Term)&
#   !is.na(def$b_CBre)&
#   !is.na(def$n_Comp)&
#   !is.na(def$l_Ceil)&
#   !is.na(def$l_Days)&
#   !is.na(def$Veh) &
#   !is.na(def$n_Fixed)&
#   !is.na(def$b_Intl)&
#   !is.na(def$b_UCA)&
#   !is.na(def$NAICS)&
#   !is.na(def$NAICS2)&
#   !is.na(def$cl_def6_HHI_lag1)&
#   !is.na(def$US6_avg_sal_lag1)
# # 
# serv_smp<-def[complete,]
# #8818392  to 8818392
# 13057769 to 8335209
# nrow(def[!complete,])/nrow(def)
# sum(def[!complete,]$Action.Obligation,na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
# 
# smp1m<-serv_smp[sample(nrow(serv_smp),1000000),]
# serv_smp<-serv_smp[sample(nrow(serv_smp),250000),]
# save(file="data//def_sample.Rdata",serv_smp,smp1m)

# levels(serv_smp$Intl)<- list("Just U.S."=c("Just U.S."), 
#                                 "Any Intl."=c("Any International"))
# levels(smp1m$Intl)<- list("Just U.S."=c("Just U.S."), 
#                                 "Any Intl."=c("Any International"))


```

#ICC Testing
## NAICS
### NAICS level 6
```{r NAICSlevel6}
load(file="..//data//clean//naics_empty_models.rdata")

if(!exists("naics06_term"))
naics06_term <- glmer(data=serv_smp,
                 b_Term ~ (1 | NAICS)
                  , family=binomial(link="logit"))
get_icc(display=TRUE,naics06_term)

if(!exists("naics06_cbre"))
naics06_cbre <- glmer(data=serv_smp,
                 b_CBre ~ (1 | NAICS)
                  , family=binomial(link="logit"))
get_icc(display=TRUE,naics06_cbre)

if(!exists("naics06_comp"))
naics06_comp <- glmer(data=serv_smp,
                 b_Comp ~ (1 | NAICS)
                  , family=binomial(link="logit"))
get_icc(display=TRUE,naics06_comp)

```

### NAICS level 3
```{r NAICSlevel3}

if(!exists("naics03_term"))
  naics03_term <- glmer(data=serv_smp,
                        b_Term ~ (1 | NAICS3)
                        , family=binomial(link="logit"))
get_icc(display=TRUE,naics03_term)

if(!exists("naics03_cbre"))
  naics03_cbre <- glmer(data=serv_smp,
                        b_CBre ~ (1 | NAICS3)
                        , family=binomial(link="logit"))
get_icc(display=TRUE,naics03_cbre)

if(!exists("naics03_comp"))
  naics03_comp <- glmer(data=serv_smp,
                        b_Comp ~ (1 | NAICS3)
                        , family=binomial(link="logit"))
get_icc(display=TRUE,naics03_comp)
```


### NAICS 3/6
```{r NAICSlevel36}

if(!exists("naics36_term"))
  naics36_term <- glmer(data=serv_smp,
                        b_Term ~ (1 | NAICS3/NAICS)
                        , family=binomial(link="logit"))
get_icc(display=TRUE,naics36_term)

if(!exists("naics36_cbre"))
  naics36_cbre <- glmer(data=serv_smp,
                        b_CBre ~ (1 | NAICS3/NAICS)
                        , family=binomial(link="logit"))
get_icc(display=TRUE,naics36_cbre)

if(!exists("naics36_comp"))
  naics36_comp <- glmer(data=serv_smp,
                        b_Comp ~ (1 | NAICS3/NAICS)
                        , family=binomial(link="logit"))
get_icc(display=TRUE,naics36_comp)
```




### Compare NAICS

```{r Empty_Compare_CBre}

save(naics03_cbre,naics03_term,naics03_comp,
     naics06_cbre,naics06_term,naics06_comp,
     naics36_cbre,naics36_term,naics36_comp,
     file="../data//clean//naics_empty_models.rdata")


get_icc(naics03_cbre)
get_icc(naics06_cbre)
get_icc(naics36_cbre)
```
NAICS6 alone explains the most variance. However, Combining NAICS 3 and NAICS 6 seems has similar value and  offer the most balance. For CBre, the three level options are unhelpful.
```{r Empty_Compare_Term}
get_icc(naics03_term)
get_icc(naics06_term)
get_icc(naics36_term)
```
For termination a largely similar patern holds, but instead it's instead levels 4 and 6 that provide the best balance, but 3 and 6 isn't far behind.
```{r Empty_Compare_Comp}
get_icc(naics03_comp)
get_icc(naics06_comp)
get_icc(naics36_comp)

```
The ideal levels varies some depending on the output variable. On the whole NAICS 3 and NAICS 6 combined seem to explain comparatively high levels of variance when summed and are reasonably balanced between the two levels.

Fiscal year generally has more explanatory power than calendar year.

## Product Or Service Codes
### Product Or Service Code
```{r ProdServ}
# load(file="../data/clean/psc_empty_models.rdata")


if(!exists("psc_cbre"))
psc_cbre <- glmer(data=serv_smp,
                 b_CBre ~ (1 | ProdServ)
                  , family=binomial(link="logit"))
get_icc(display=TRUE,psc_cbre)


if(!exists("psc_term"))
psc_term <- glmer(data=serv_smp,
                 b_Term ~ (1 | ProdServ)
                  , family=binomial(link="logit"))
get_icc(display=TRUE,psc_term)


```
34% for Ceiling Breaches and 22% for Terminations, not a bad start.

### Crisis Product Or Service Area
```{r CrisisProductOrServiceArea}
serv_smp$CrisisProductOrServiceArea
if(!exists("cpsa_cbre"))
cpsa_cbre <- glmer(data=serv_smp,
                 b_CBre ~ (1 | CrisisProductOrServiceArea)
                  , family=binomial(link="logit"))
get_icc(display=TRUE,cpsa_cbre)

if(!exists("cpsa_term"))
cpsa_term <- glmer(data=serv_smp,
                 b_Term ~ (1 | CrisisProductOrServiceArea)
                  , family=binomial(link="logit"))
get_icc(display=TRUE,cpsa_term)




# 
# 
#   if("ProdServ" %in% colnames(serv_smp)){
#     serv_smp$ProdServ[serv_smp$ProdServ==""]<-NA
#     serv_smp$ProductOrServiceCode<-as.character(serv_smp$ProdServ)
#   }
# 
#   if("ProductOrServiceCode" %in% colnames(serv_smp)){
#     serv_smp<-read_and_join( serv_smp,
#                                       "ProductOrServiceCodes.csv",
#                                       path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
#                                       directory="",
#                                       by="ProductOrServiceCode",
#                                       add_var=c("Simple",
#                                                 "ProductServiceOrRnDarea",
#                                                 "ProductOrServiceArea",
#                                                 "HostNation3Category",
#                                                 "CrisisProductOrServiceArea",
#                                                 "ProductOrServiceCodeText"
#                                       ),
#                                       new_var_checked=FALSE)
# 
#     serv_smp$ProductServiceOrRnDarea<-factor(serv_smp$ProductServiceOrRnDarea)
#     serv_smp$ProductOrServiceArea<-factor(serv_smp$ProductOrServiceArea)
#     serv_smp$HostNation3Category<-factor(serv_smp$HostNation3Category)
#     serv_smp$CrisisProductOrServiceArea<-factor(serv_smp$CrisisProductOrServiceArea)
#     serv_smp$ProductOrServiceCodeText<-factor(serv_smp$ProductOrServiceCodeText)
#     
  # }


```
23% for Ceiling Breaches and 18% for Terminations. In particular for terminations, these high level categories seem to capture much of the differences without needing as much detail.

### Service / Commdity / Construction
```{r PSR}
serv_smp$ServCommCons<-serv_smp$HostNation3Category




if(!exists("ServCommCons_cbre"))
ServCommCons_cbre <- glmer(data=serv_smp,
                 b_CBre ~ (1 | ServCommCons)
                  , family=binomial(link="logit"))
get_icc(display=TRUE,ServCommCons_cbre)


if(!exists("ServCommCons_term"))
ServCommCons_term <- glmer(data=serv_smp,
                 b_Term ~ (1 | ServCommCons)
                  , family=binomial(link="logit"))
get_icc(display=TRUE,ServCommCons_term)


```





### CPSA/ProdServ
Three levels
```{r Area_Code}


if(!exists("cpsa_psc_cbre"))
cpsa_psc_cbre <- glmer(data=serv_smp,
                 b_CBre ~ (1 | CrisisProductOrServiceArea/ProdServ)
                  , family=binomial(link="logit"))
get_icc(display=TRUE,cpsa_psc_cbre)


if(!exists("cpsa_psc_term"))
cpsa_psc_term <- glmer(data=serv_smp,
                 b_Term ~ (1 | CrisisProductOrServiceArea/ProdServ)
                  , family=binomial(link="logit"))
get_icc(display=TRUE,cpsa_psc_term)


```
Oddly, crisis product or service area just doesn't seem to add anything to the 


### Compare ProdServ

```{r Empty_Compare_CBre}




save(psc_cbre,psc_term,
     cpsa_cbre,cpsa_term,
     ServCommCons_cbre,ServCommCons_term,
     cpsa_psc_cbre,cpsa_psc_term,
     # ssc_psc_cbre,ssc_psc_term,
     file="..//data//clean//psc_empty_models.rdata")


get_icc(psc_cbre)
get_icc(cpsa_cbre)
get_icc(ServCommCons_cbre)
get_icc(cpsa_psc_cbre)

      stargazer::stargazer(psc_cbre,cpsa_cbre,ServCommCons_cbre,
                           cpsa_psc_cbre,type="text",
                     digits=2)
```
ServCommCons/ProductServiceCode easily explains the most about the model.
```{r Empty_Compare_Term}
get_icc(psc_term)
get_icc(cpsa_term)
get_icc(ServCommCons_term)
get_icc(cpsa_psc_term)

      stargazer::stargazer(psc_term,cpsa_term,ServCommCons_term,
                           cpsa_psc_term,type="text",
                     digits=2)


```
CrisisProductOrSericeArea doesn't add much value versus ProdServ alone but ServCommCons adds none.


Proceeding with CrisisProductOrServiceArea/ProdServ for Term and CrisisProductOrServiceArea/ProdServ for CBre


The ideal levels varies some depending on the output variable. On the whole ProdServ 3 and ProdServ 6 combined seem to explain comparatively high levels of variance when summed and are reasonably balanced between the two levels.

Fiscal year generally has more explanatory power than calendar year.

## Combining PSC and NAICS
### NAICS 3/6 + CPSA/ProdServ
```{r NAICSlevel36_and_CPSAprodserv}

if(!exists("naics36_plus_cpsa_psc_term"))
  naics36_plus_cpsa_psc_term <- glmer(data=serv_smp,
                        b_Term ~ (1 | NAICS3/NAICS) +(1| CrisisProductOrServiceArea/ProdServ)
                        , family=binomial(link="logit"))
get_icc(display=TRUE,naics36_plus_cpsa_psc_term)

if(!exists("naics36_plus_cpsa_psc_cbre"))
  naics36_plus_cpsa_psc_cbre<- glmer(data=serv_smp,
                        b_CBre ~ (1 | NAICS3/NAICS) +(1| CrisisProductOrServiceArea/ProdServ)
                        , family=binomial(link="logit"))
get_icc(display=TRUE,naics36_plus_cpsa_psc_cbre)

if(!exists("naics36_plus_cpsa_psc_comp"))
  naics36_plus_cpsa_psc_comp <- glmer(data=serv_smp,
                        b_Comp ~ (1 | NAICS3/NAICS) +(1| CrisisProductOrServiceArea/ProdServ)
                        , family=binomial(link="logit"))
get_icc(display=TRUE,naics36_plus_cpsa_psc_comp)
```


### NAICS 3/6 / CPSA
```{r NAICSlevel36_CPSA}

if(!exists("naics36_cpsa_term"))
  naics36_cpsa_term<- glmer(data=serv_smp,
                        b_Term ~ (1 | NAICS3/NAICS/CrisisProductOrServiceArea)
                        , family=binomial(link="logit"))
get_icc(display=TRUE,naics36_cpsa_term)

if(!exists("naics36_cpsa_cbre"))
  naics36_cpsa_cbre<- glmer(data=serv_smp,
                        b_CBre ~ (1 | NAICS3/NAICS/CrisisProductOrServiceArea)
                        , family=binomial(link="logit"))
get_icc(display=TRUE,naics36_cpsa_cbre)

if(!exists("naics36_cpsa_comp"))
  naics36_cpsa_comp <- glmer(data=serv_smp,
                        b_Comp ~ (1 | NAICS3/NAICS/CrisisProductOrServiceArea)
                        , family=binomial(link="logit"))
get_icc(display=TRUE,naics36_cpsa_comp)
```


### CPSA /PSC / NAICS 3
```{r Area_Code}


if(!exists("cpsa_psc_naices3_cbre"))
cpsa_psc_naices3_cbre <- glmer(data=serv_smp,
                 b_CBre ~ (1 | CrisisProductOrServiceArea/ProdServ/NAICS3)
                  , family=binomial(link="logit"))
get_icc(display=TRUE,cpsa_psc_naices3_cbre)


if(!exists("cpsa_psc_naics3_term "))
cpsa_psc_naics3_term  <- glmer(data=serv_smp,
                 b_Term ~ (1 | CrisisProductOrServiceArea/ProdServ/NAICS3)
                  , family=binomial(link="logit"))
get_icc(display=TRUE,cpsa_psc_naics3_term)


```

### Compare NAICS and ProdServ

```{r Empty_Compare_CBre}




save(naics36_plus_cpsa_psc_term,naics36_plus_cpsa_psc_cbre,naics36_plus_cpsa_psc_comp,
     naics36_cpsa_term,naics36_cpsa_cbre,naics36_cpsa_comp,
     cpsa_psc_naices3_cbre,cpsa_psc_naics3_term,
     file="..//data//clean//psc_naics_empty_models.rdata")


get_icc(naics36_cbre)
get_icc(cpsa_psc_cbre)
get_icc(naics36_plus_cpsa_psc_cbre)
get_icc(naics36_cpsa_cbre)
get_icc(cpsa_psc_naices3_cbre)


      stargazer::stargazer(naics36_cbre,
                           cpsa_psc_cbre,
                           naics36_plus_cpsa_psc_cbre,
                           naics36_cpsa_cbre,
                           cpsa_psc_naices3_cbre,
                           type="text",
                     digits=2)
```

For ceiling breaches, NAICS does much better and including product or service codes as a seperate set degrades the performance fo the model.

```{r Empty_Compare_term}


get_icc(naics36_term)
get_icc(cpsa_psc_term)
get_icc(naics36_plus_cpsa_psc_term)
get_icc(naics36_cpsa_term)
get_icc(cpsa_psc_naics3_term)



      stargazer::stargazer(naics36_term,
                           cpsa_psc_term,
                           naics36_plus_cpsa_psc_term,
                           naics36_cpsa_term,
                           cpsa_psc_naics3_term,type="text",
                     digits=2)
```
For termination, adding PSC slightly improves the performance of the model,. 

\

## Start Year

### Calendar Year
```{r StartCY}
# load(file="../data//clean//when_empty_models.rdata")

if(!exists("StartCY_term"))
  StartCY_term <- glmer(data=serv_smp,
                        b_Term ~ (1 | StartCY)
                        , family=binomial(link="logit"))
get_icc(display=TRUE,StartCY_term)

if(!exists("StartCY_cbre"))
  StartCY_cbre <- glmer(data=serv_smp,
                        b_CBre ~ (1 | StartCY)
                        , family=binomial(link="logit"))
get_icc(display=TRUE,StartCY_cbre)

if(!exists("StartCY_comp"))
  StartCY_comp <- glmer(data=serv_smp,
                        b_Comp ~ (1 | StartCY)
                        , family=binomial(link="logit"))
get_icc(display=TRUE,StartCY_comp)

```

The ICC is highest for ceiling breaches and is backloaded, with 2015 and 2016 having lower than usual odds. This is likely an artifact of those years having fewer completed longer contracts. That said, this should be largely compensated for with the inclusion of initial duration. If this proves challenges to manage, it may be worth considering dropping 2016. 



### NAICS and Calendar Year
```{r NAICS_StartCY}

if(!exists("NAICS_StartCY_term"))
  NAICS_StartCY_term <- glmer(data=serv_smp,
                              b_Term ~  (1 | NAICS3/NAICS) + (1 | StartCY)
                              , family=binomial(link="logit"))
get_icc(display=TRUE,NAICS_StartCY_term)

if(!exists("NAICS_StartCY_cbre"))
  NAICS_StartCY_cbre <- glmer(data=serv_smp,
                              b_CBre ~  (1 | NAICS3/NAICS) + (1 | StartCY)
                              , family=binomial(link="logit"))
get_icc(display=TRUE,NAICS_StartCY_cbre)

if(!exists("NAICS_StartCY_comp"))
  NAICS_StartCY_comp <- glmer(data=serv_smp,
                              b_Comp ~  (1 | NAICS3/NAICS) + (1 | StartCY)
                              , family=binomial(link="logit"))
get_icc(display=TRUE,NAICS_StartCY_comp)

```

### Compare Signed Dates
```{r Empty_Compare_When}

save(StartCY_cbre,StartCY_term,StartCY_comp,
     # SignedMonth_cbre,SignedMonth_term,SignedMonth_comp,
     # NestedMonth_cbre,NestedMonth_term,NestedMonth_comp,
     NAICS_StartCY_cbre,NAICS_StartCY_term,NAICS_StartCY_comp,
     file="../data//clean//when_empty_models.rdata")

get_icc(naics36_cbre)
get_icc(StartCY_cbre)
# get_icc(SignedMonth_cbre)
# get_icc(NestedMonth_cbre)
get_icc(NAICS_StartCY_cbre)

get_icc(naics36_term)
get_icc(StartCY_term)
# get_icc(SignedMonth_term)
# get_icc(NestedMonth_term)
get_icc(NAICS_StartCY_term)

get_icc(naics36_comp)
get_icc(StartCY_comp)
# coef(StartCY_comp)
# get_icc(SignedMonth_comp)
# get_icc(NestedMonth_comp)
get_icc(NAICS_StartCY_comp)

```

Start year adds little. Leaving it out.

##Customer
### Office
```{r Office}
# load(file="../data//clean//who_empty_models.rdata")
if(!exists("Office_term"))
  Office_term <- glmer(data=serv_smp,
                       b_Term ~ (1 | Agency:Office)
                       , family=binomial(link="logit"))
get_icc(display=TRUE,Office_term)

if(!exists("Office_cbre"))
  Office_cbre <- glmer(data=serv_smp,
                       b_CBre ~ (1 | Agency:Office)
                       , family=binomial(link="logit"))
get_icc(display=TRUE,Office_cbre)

if(!exists("Office_comp"))
  Office_comp <- glmer(data=serv_smp,
                       b_Comp ~ (1 | Agency:Office)
                       , family=binomial(link="logit"))
get_icc(display=TRUE,Office_comp)

```

### Agency
```{r Agency}
if(!exists("Agency_term"))
  Agency_term <- glmer(data=serv_smp,
                       b_Term ~ (1 | Agency)
                       , family=binomial(link="logit"))
get_icc(display=TRUE,Agency_term)

if(!exists("Agency_cbre"))
  Agency_cbre <- glmer(data=serv_smp,
                       b_CBre ~ (1 | Agency)
                       , family=binomial(link="logit"))
get_icc(display=TRUE,Agency_cbre)

if(!exists("Agency_comp"))
  Agency_comp <- glmer(data=serv_smp,
                       b_Comp ~ (1 | Agency)
                       , family=binomial(link="logit"))
get_icc(display=TRUE,Agency_comp)

```


### Nested Office
```{r NestedOffice}
if(!exists("NestedOffice_term"))
  NestedOffice_term <- glmer(data=serv_smp,
                             b_Term ~ (1 | Agency/Office)
                             , family=binomial(link="logit"))
get_icc(display=TRUE,NestedOffice_term)

if(!exists("NestedOffice_cbre"))
  NestedOffice_cbre <- glmer(data=serv_smp,
                             b_CBre ~ (1 | Agency/Office)
                             , family=binomial(link="logit"))
get_icc(display=TRUE,NestedOffice_cbre)

if(!exists("NestedOffice_comp"))
  NestedOffice_comp <- glmer(data=serv_smp,
                             b_Comp ~ (1 | Agency/Office)
                             , family=binomial(link="logit"))
get_icc(display=TRUE,NestedOffice_comp)

```


### NAICS 36 Office
```{r naics36_serv_smpOffice}
if(!exists("naics 36_Office_term"))
  naics36_Office_term <- glmer(data=serv_smp,
                             b_Term ~  (1 | NAICS3/NAICS) +  (1 | Agency/Office)
                             , family=binomial(link="logit"))
get_icc(display=TRUE,naics36_Office_term)
# 
if(!exists("naics36_Office_cbre"))
  naics36_Office_cbre <- glmer(data=serv_smp,
                             b_CBre ~  (1 | NAICS3/NAICS)+  (1 | Agency/Office)
                             , family=binomial(link="logit"))
get_icc(display=TRUE,naics36_Office_cbre)

if(!exists("naics36_Office_comp"))
  naics36_Office_comp <- glmer(data=serv_smp,
                             b_Comp ~  (1 | NAICS3/NAICS)+ (1 | Agency/Office)
                             , family=binomial(link="logit"))
get_icc(display=TRUE,naics36_Office_comp)

```

### NAICS 36 When Office
```{r naics36_When_Office}
if(!exists("naics 36_When_Office_term"))
  naics36_When_Office_term <- glmer(data=serv_smp,
                             b_Term ~  (1 | NAICS3/NAICS) + (1 | StartCY) + (1 | Agency/Office)
                             , family=binomial(link="logit"))
get_icc(display=TRUE,naics36_When_Office_term)
# 
if(!exists("naics36_When_Office_cbre"))
  naics36_When_Office_cbre <- glmer(data=serv_smp,
                             b_CBre ~  (1 | NAICS3/NAICS)+ (1 | StartCY) + (1 | Agency/Office)
                             , family=binomial(link="logit"))
get_icc(display=TRUE,naics36_When_Office_cbre)

if(!exists("naics36_When_Office_comp"))
  naics36_When_Office_comp <- glmer(data=serv_smp,
                             b_Comp ~  (1 | NAICS3/NAICS)+ (1 | StartCY) + (1 | Agency/Office)
                             , family=binomial(link="logit"))
get_icc(display=TRUE,naics36_When_Office_comp)

```

### Compare Who
```{r Empty_Compare_Who_Term}

save(Office_cbre,Office_term,Office_comp,
     Agency_cbre,Agency_term,Agency_comp,
     NestedOffice_cbre,NestedOffice_term,NestedOffice_comp,
     naics36_Office_cbre,naics36_Office_term,naics36_Office_comp,
     naics36_When_Office_cbre,naics36_When_Office_term,naics36_When_Office_comp,
     
     file="../data//clean//who_empty_models.rdata")

get_icc(naics36_term)
get_icc(Office_term)
get_icc(Agency_term)
get_icc(NestedOffice_term)
get_icc(naics36_When_Office_term)
# get_icc(naics06_When_Office_term)


debug(summary_residual_compare)
summary_residual_compare(naics36_Office_term,naics46_Office_term,naics36_Office_cbre,naics46_Office_cbre,bins=10,suppress_vif=TRUE)
summary_residual_compare(naics06_Office_term,naics36_Office_term,naics06_Office_cbre,naics36_Office_cbre,bins=10,suppress_vif=TRUE)
summary_residual_compare(naics36_term,naics36_Office_term,naics36_cbre,naics36_Office_cbre,bins=10,suppress_vif=TRUE)
summary_residual_compare(naics36_term,naics236_term,naics36_cbre,naics236_cbre,bins=10,suppress_vif=TRUE)
summary_residual_compare(naics36_term,naics36_Office_term,naics36_cbre,naics36_Office_cbre,bins=10,suppress_vif=TRUE)
```


```{r Empty_Compare_Who_CBre}

get_icc(naics36_cbre)
get_icc(Office_cbre)
get_icc(Agency_cbre)
get_icc(NestedOffice_cbre)
get_icc(naics36_Office_cbre)
# get_icc(naics36_When_Office_cbre)
```

```{r Empty_Compare_Who_Comp}
get_icc(naics36_comp)
get_icc(Office_comp)
get_icc(Agency_comp)
get_icc(NestedOffice_comp)
get_icc(naics36_Office_comp)
# get_icc(naics36_When_Office_comp)
get_icc(naics06_When_Office_comp)
```
There is some contradiction in which model best serves this category. For Comp, the nested office has the largest summed ICC, but for term this results in an failure to converge and a 0 ICC for agency. Agency:Office alone is respectable for all three so that is used in the combination attempt.




## Where

### Place
```{r PlaceCountry}
# load(file="Output//where_empty_models.rdata")




# if(!exists("PlaceCountry_cbre"))
  PlaceCountry_cbre <- glmer(data=large_crisis_smp,
                       b_CBre ~ (1 | PlaceCountryISO3)
                       , family=binomial(link="logit"),
     control = glmerControl(optimizer = "optimx", calc.derivs = FALSE,
     optCtrl = list(method = "nlminb", starttests = FALSE, kkt = FALSE)))

get_icc(display=TRUE,Place_theater_Country_offplace_theater_cbre)
get_icc(display=TRUE,PlaceCountry_cbre)

# if(!exists("PlaceCountry_term"))
  PlaceCountry_term <- glmer(data=large_crisis_smp,
                       b_Term ~ (1 | PlaceCountryISO3)
                       , family=binomial(link="logit"),
     control = glmerControl(optimizer = "optimx", calc.derivs = FALSE,
     optCtrl = list(method = "nlminb", starttests = FALSE, kkt = FALSE)))

get_icc(display=TRUE,Place_theater_Country_offplace_theater_cbre)
get_icc(display=TRUE,PlaceCountry_term)
```



### Place
```{r PlaceCountry}
# load(file="Output//where_empty_models.rdata")




# if(!exists("PlaceCountry_cbre"))
  PlaceCountry_cbre <- glmer(data=large_crisis_smp,
                       b_CBre ~ (1 | PlaceCountryISO3)
                       , family=binomial(link="logit"),
     control = glmerControl(optimizer = "optimx", calc.derivs = FALSE,
     optCtrl = list(method = "nlminb", starttests = FALSE, kkt = FALSE)))

get_icc(display=TRUE,Place_theater_Country_offplace_theater_cbre)
get_icc(display=TRUE,PlaceCountry_cbre)

# if(!exists("PlaceCountry_term"))
  PlaceCountry_term <- glmer(data=large_crisis_smp,
                       b_Term ~ (1 | PlaceCountryISO3)
                       , family=binomial(link="logit"),
     control = glmerControl(optimizer = "optimx", calc.derivs = FALSE,
     optCtrl = list(method = "nlminb", starttests = FALSE, kkt = FALSE)))

get_icc(display=TRUE,Place_theater_Country_offplace_theater_cbre)
get_icc(display=TRUE,PlaceCountry_term)
```
