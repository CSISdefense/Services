---
title: "Defense Services Termination"
author: "Greg Sanders"
date: "Saturday, July 13, 2019"
output:
  html_document:
    keep_md: yes
    toc: yes
--- 

Modeling Likelihood of Contract Termination, Ceiling Breach, or Exercised Option
============================================================================

#Setup
```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(arm)
library(R2WinBUGS)
library(dplyr)
library(Hmisc)
library(stargazer)
library(optimx)
source("https://raw.githubusercontent.com/CSISdefense/Vendor/master/Scripts/DIIGstat.r")

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40


```



##Load Data
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from FPDS.

```{r ReadInData, echo = TRUE}
load(file="..//data//clean//def_sample.Rdata")

```


The sample is created by including the entirity of the ARRA and Disaster datasets, as well as 100,000 records each from the OCO datase and another 100,000 from all remaining records.

#Study Variables

##Services Complexity
Expectation: Higher service complexity would make work more demanding and thus raises the risks of negative contracting outcomes, namely the likelihood of cost ceiling breaches and terminations increases and the likelihood exercised options decraeses.

### 01A NAICS6 Salary
Expectation: Given the fact that one source for higher salaries is the difficulty of the work and the experience and education required, as average NAICS6 salary increases (decreases), the likelihood of terminations increases (decreases).

```{r Model01A}


summary_continuous_plot(serv_smp1m,"US6_avg_sal_lag1Const")
summary_continuous_plot(serv_smp1m,"US6_avg_sal_lag1Const",log=TRUE)

#Model
Term_01A <- glm (data=serv_smp,
                 b_Term ~ cln_US6sal, family=binomial(link="logit"))



stargazer::stargazer(Term_01A,type="text",
                       digits=2)


summary_residual_compare(Term_01A,skip_vif = TRUE)
```

Expectations are matched  for terminations and the results are significant at the 0.05 level.

### 01B Invoice Rate
Expectation: The invoice rate approximates how much the government is charged annually for each comparable full-time employees who are supporting the service contracts. A higher invoice rate indicates a more complex service. As invoice rate increases (decreases), the likelihood terminations increases (decreases).

```{r Model01B}
summary_continuous_plot(serv_smp1m,"CFTE_Rate_1year",log=TRUE)

#Model
Term_01B <- glm (data=serv_smp,
                 b_Term ~ cln_PSCrate, family=binomial(link="logit"))


  stargazer::stargazer(
                       Term_01A,Term_01B,
                       
                       type="text",
                       digits=2)


summary_residual_compare(Term_01B, skip_vif = TRUE)

```

When considered alone, expectations are matched for ceiling breaches and exercised options, as higher invoice rate estimates a higher risk of ceiling breaches and lower possibility of exercised options.



### 01C Services Complexity
Expectation: Collectively, the higher average salary and invoice rate (more complexity is indicated), the higher risk of ceiling breaches and terminations and the less exercised options there would be. Also we expect the result of combined model would be the same as individual models.

 
```{r Model01C}
#Model
Term_01C <- glm (data=serv_smp,
                 b_Term ~ cln_US6sal + cln_PSCrate, family=binomial(link="logit"))

glmer_examine(Term_01C)


stargazer::stargazer(
                       Term_01A,Term_01B,Term_01C,
                       
                       type="text",
                       digits=2)


  summary_residual_compare(Term_01A,Term_01C,Term_01B,Term_01C)



```

Both average salary and invoiced rate have a VI well within bounds, suggesting that the variance of the estimated coefficients is not evidently inflated and none of them are highly correlated with each other. 

Both individually and pair-wise, higher average salary and invoiced rate estimate higher possibility of cost ceiling breaches and lower likelihood of exercised options as expected. But the termination expectation is not not significant at the 0.05 level for either for two measures of service complexity resepctively when considered together.



## Office Capacity

### 02A: Performance Based Services
Expectation: Performance-based services contracting ties a portion of a contractor's payment, contract extensions, or contract renewals to the achievement of specific, measurable performance standards and requirements, which encourages better contracting results. PBSC has the potential to reduce terminations and ceiling breaches and bring more possibility of exercised options.

```{r Model02A}

summary_continuous_plot(serv_smp1m,"pPBSC")
summary_continuous_plot(serv_smp1m,"pPBSC",log=TRUE)

#Model
Term_02A <- glm (data=serv_smp,
                 b_Term ~ cp_OffPerf7, family=binomial(link="logit"))

stargazer::stargazer(Term_01C,
                       Term_02A,
                       
                       type="text",
                       digits=2)


  summary_residual_compare(Term_02A,skip_vif=TRUE,bins=20)
```

When considering PBSC alone, the expected sign was not found in terminations.


### 02B: No.Office PSC History
Expectation: The increasing share of contracting office obligations for a given service indicates high capcaity in that area, lower likelihood of cost ceiling breaches and termination and higher likelihood of exercised options are expected to be observed.

```{r Model02B}

summary_continuous_plot(serv_smp1m,"pOffPSC")
summary_continuous_plot(serv_smp1m,"pOffPSC",log=TRUE)

#Model
Term_02B <- glm (data=serv_smp,
                 b_Term ~ cp_OffPSC7, family=binomial(link="logit"))

stargazer::stargazer(Term_01C,
                       Term_02A,Term_02B,
                       
                       type="text",
                       digits=2)



summary_residual_compare(Term_02B, skip_vif = TRUE)

```

Expections were not upheldfor terminations When considering number of contracting office obligations for a given service alone.


### 02C: Office Capacity
Expectation: Collaberactively, the larger share of PBSC and contracting office obligations for a given service, the less risk of ceiling breaches and terminations and the more exercised options there would be. Also we expect the results of combined model would be the same as two individual models above. 

```{r Model02C}


#Model
Term_02C <- glm (data=serv_smp,
                 b_Term ~ cp_OffPerf7+cp_OffPSC7, family=binomial(link="logit"))

glmer_examine(Term_02C)


stargazer::stargazer(
                       Term_01C,Term_02A,Term_02B,Term_02C,
                       
                       type="text",
                       digits=2)



summary_residual_compare(Term_02A,Term_02C,Term_02B,Term_02C)


```

No high correlation is observed between PBSC and Contract Office Obligations for PSC based on the vif score.

After combining PBSC and Contract office obligations for PSC, PBSC lost significance for terminations. Contract office obligations for PSC is associate with more exercised options. PBSC is now has the expected sign but pOffPSC does not.


### 02D: Cumulative  Model
Expectation: When all the four variables are combined into one model, same expectations are applied as individual ones. Per service complexity indicator increases, higher risk of ceiling breaches and terminations and less exercised options expected. Per office capacity indicator increases, lower risk of ceiling breaches and terminations and more exercised options expected.

```{r Model02D}


#Model
Term_02D <- glm (data=serv_smp,
                 b_Term ~ cln_US6sal + cln_PSCrate+cp_OffPerf7+cp_OffPSC7, family=binomial(link="logit"))

glmer_examine(Term_02D)


stargazer::stargazer(
                       Term_01C,Term_02C,Term_02D,
                       
                       type="text",
                       digits=2)



summary_residual_compare(Term_01C,Term_02D)


```

No high correlation is observed among all of the 4 predictors (average salary, invoiced rate, PBSC and Contract Office Obligations for PSC) so far based on the vif score. When all measures for sevice complexity and office capacity are combined, per dependent variable:

Terminations: Average Salary swaps signs, counter to expectations, and becomes less significant. CFTE becomes signifianct at the .10 level.  pPBSC and pOFfPSC are largely unchanged from the prior model.


## Office-Vendor Relationship

### 03A: Pair History
Expactation: The number of past years of the relationship between the contracting office or the contractors with a single transaction in a given fiscal year enough to qualify, namely, pair history increases (decreases), the likelihood of cost ceiling breaches and terminations decreases (increases) and the exercised options increase (decrease) for that partnership.

```{r Model03A}

summary_discrete_plot(serv_smp,"office_entity_paircount_7year")

#Model
Term_03A <- glm (data=serv_smp,
                 b_Term ~ cn_PairHist7, family=binomial(link="logit"))


  stargazer::stargazer(Term_02D,
                       Term_03A,
                       
                       type="text",
                       digits=2)



summary_residual_compare(Term_03A, skip_vif = TRUE)

```

When considering pair history alone, expectations were met for terminations., though the results were not significant.

### 03B: Interaction
Expectation: As the number of contract actions a vendor has performed for an office in the past year increases (decreases), the likelihood of cost ceiling breaches and terminations decreases (increases) and that of exercised options increases (decreases) for that partnership.

```{r Model03B}
summary_continuous_plot(serv_smp1m,"office_entity_numberofactions_1year")
summary_continuous_plot(serv_smp1m,"office_entity_numberofactions_1year", log=TRUE)

#Model
Term_03B <- glm (data=serv_smp,
                 b_Term ~ cln_PairCA, family=binomial(link="logit"))

stargazer::stargazer(   Term_02D,Term_03A,Term_03B,
                       type="text",
                       digits=2)

summary_residual_compare(Term_03B, skip_vif = TRUE)

```

Expectation were not met, The patterns in the plots are complex, terminations has an negative relationship, until the number of ations grows extreme at which point the risk jumps up.

### 03C: Office-Vendor Relationship
Expectation: 
The importance of partnership, trust, and handling difficult problems and uncertainty together naturally lead into the last characteristic: the relationship between the contractor and buyer. The higher level of interaction provides the more opportunity to build a deeper relationship, the likelihood of cost ceiling breaches and terminations decreases and the exercised options increase for that partnership. Also we expect the result of combined model would be the same as individual models above.

```{r Model03C}
#Model
Term_03C <- glm (data=serv_smp,
                 b_Term ~ cn_PairHist7+cln_PairCA, family=binomial(link="logit"))

glmer_examine(Term_03C)

  stargazer::stargazer(Term_02D,
                       Term_03A,Term_03B,Term_03C,
                       
                       type="text",
                       digits=2)



summary_residual_compare(Term_03A,Term_03C,Term_03B,Term_03C)

```

When combining pair history and contract actions, magnitude of relationships with dependent variables incraesed and pairhistory is now significant in the expected direction while pair contract actions remains contrary to expectations.


### 03D: Cumulative  Model

Expectation: Under each subgroup, the predictors are expected to have similar impacts on dependent variables individually and cumulatively:
1. Higher Services Complexity: Higher likelihood of cost ceiling breaches and terminations; Less exercised options
2. Larger Office Capacity: Lower likelihood of cost ceiling breaches and terminations; More exercised options
3. Deeper Office-Vendor Relationship: Lower likelihood of cost ceiling breaches and terminations; More exercised options

```{r Model03D}

#Model
Term_03D <- glm (data=serv_smp,
                 b_Term ~ cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                   cn_PairHist7+cln_PairCA, family=binomial(link="logit"))

glmer_examine(Term_03D)

   

stargazer::stargazer(
                       Term_02D,Term_03C,Term_03D,
                       
                       type="text",
                       digits=2)

summary_residual_compare(Term_02D,Term_03D)

```

None of the predictors has high level of correlation (vif over 1.7) with each other. 
In the cumulative model, per dependent variable and independent variable:

2. Terminations:
   A. Service Complexity:
      Average salary did not match with expectation, but gained signifiance at the 0.10 level
      The result for invoice rate did matach with expectation and is now significant at 0.01 level
      Otherwise magnitudes reduced but no changes of note.
      
      

## Study Variables Alone

```{r StudyVariableAlone}



study_coef_list<-
  list("(Intercept)"="(Intercept)",
       "cln_US6sal"="Log(Det. Ind. Salary)",
       "cln_PSCrate"="Log(Service Invoice Rate)",
       "cp_OffPerf7"="Office Perf.-Based %",
       "cp_OffPSC7"="Office Service Exp. %",
       "cn_PairHist7"="Paired Years",
       "cln_PairCA"="Log(Paired Actions)"
  )


all_coef_list<-
  list("(Intercept)"="(Intercept)",
       "cln_US6sal"="Log(Det. Ind. Salary)",
       "cln_PSCrate"="Log(Service Invoice Rate)",
       "cp_OffPerf7"="Office Perf.-Based %",
       "cp_OffPSC7"="Office Service Exp. %",
       "cn_PairHist7"="Paired Years",
       "cln_PairCA"="Log(Paired Actions)",
       
       #Contract Controls
       
       "Comp1 offer"="Comp=1 offer",
       "Comp2-4 offers"="Comp=2-4 offers",
       "Comp5+ offers"="Comp=5+ offers",
       
       "CompOffr1 offer"="Comp=1 offer",
       "CompOffr2 offers"="Comp=2 offers",
       "CompOffr3-4 offers"="Comp=3-4 offers",
       "CompOffr5+ offers"="Comp=5+ offers",
       
       "cl_Ceil"="Log(Init. Ceiling)",
       "cln_Days"="Log(Init. Days)",
       "VehS-IDC"="Vehicle=S-IDC",
       "VehM-IDC"="Vehicle=M-IDC",
       "VehFSS/GWAC"="Vehicle=FSS/GWAC",
       "VehBPA/BOA"="Vehicle=BPA/BOA",
       "PricingFFP"="Pricing=FFP",
       "PricingOther FP"="Pricing=Other FP",
       "PricingIncentive"="Pricing=Incentive Fee",
       "PricingCombination or Other"="Pricing=Combination or Other",
       "PricingOther CB"="Pricing=Other CB",
       "PricingT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
       "PricingUCA"="Pricing=UCA",
       
       "PricingFeeOther FP"="Pricing=Other FP",
       "PricingFeeIncentive"="Pricing=Incentive Fee",
       "PricingFeeCombination or Other"="Pricing=Combination or Other",
       "PricingFeeOther CB"="Pricing=Other CB",
       "PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
       "b_UCA"="UCA",
       "CrisisARRA"="Crisis=ARRA",
       "CrisisDis"="Crisis=Disaster",
       "CrisisOCO"="Crisis=OCO",
       "b_Intl"="Performed Abroad",
       
       #NAICS6
       "cln_Def3HHI"="Log(Subsector HHI)",
       "cln_Def6HHI"="Log(Det. Ind. HHI)",
       "clr_Def3toUS"="Log(Subsector Ratio)",
       "cln_Def6Obl"="Log(Det. Ind. DoD Obl.)",
       "clr_Def6toUS"="Log(Det. Ind. Ratio)",
       #Office
       "cp_PairObl7"="Percent Market",
       "cln_OffObl7"="Office Volume",
       "cln_OffFocus"="Office Concentration",
       
       
       #interations
       # # "cln_Def6HHI:cln_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
       # "cln_Def6HHI:cln_Def6Obl"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
       # # "cln_Def3HHI:clr_Def3toUS"="Log(Subsector HHI):Log(Subsector Ratio)"),
       "cln_Def6HHI:b_UCA"="Log(Det. Ind. HHI):UCA",
       # "cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
       # "CompOffr1 offer:b_UCA"="Comp=1 offer:UCA",
       # "CompOffr2 offers:b_UCA"="Comp=2 offers:UCA",
       # "CompOffr3-4 offers:b_UCA"="Comp=3-4 offers:UCA",
       # "CompOffr5+ offers:b_UCA"="Comp=5+ offers:UCA"
       "VehS-IDC:b_Intl"="Vehicle=S-IDC:Performed Abroad",
       "VehM-IDC:b_Intl"="Vehicle=M-IDC:Performed Abroad",
       "VehFSS/GWAC:b_Intl"="Vehicle=FSS/GWAC:Performed Abroad",
       "VehBPA/BOA:b_Intl"="Vehicle=BPA/BOA:Performed Abroad",
       "cl_US6_avg_sal_lag1:PricingFeeOther FP"=
         "Pricing=Other FP:Log(Det. Ind. U.S. Avg. Salary)",
       "cl_US6_avg_sal_lag1:PricingFeeIncentive"=
         "Pricing=Incentive Fee:Log(Det. Ind. U.S. Avg. Salary)",
       "cl_US6_avg_sal_lag1:PricingFeeCombination or Other"=
         "Pricing=Comb./or Other:Log(Det. Ind. U.S. Avg. Salary)",
       "cl_US6_avg_sal_lag1:PricingFeeOther CB"="Pricing=Other CB:Log(Det. Ind. U.S. Avg. Salary)",
       "cl_US6_avg_sal_lag1:PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE:Log(Det. Ind. U.S. Avg. Salary)"
  )


#Terminations
stargazer::stargazer(Term_01A,Term_01B,Term_02A,Term_02B,Term_03A,Term_03B,Term_03D,
                     type="text",
                     digits=2)




texreg::htmlreg(list(Term_01A,Term_01B,Term_02A,Term_02B,Term_03A,Term_03B,Term_03D),
                file="..//Output//Term_Model.html",
                single.row = TRUE,
                # custom.model.name=c("Ceiling Breaches"),
                stars=c(0.1,0.05,0.01,0.001),
                groups = list(
                  "Services Complexity" = 2:3,
                  "Office Capacity" =4:5,
                  "Past Relationship"=6:7
                ),
                custom.coef.map=all_coef_list,
                bold=0.05,
                custom.note="%stars. Numerical inputs are rescaled.",
                caption="Table 7: Logit Bivariate Look at Study Variables and Terminations",
                caption.above=TRUE)



```

# Controls

##Contract-Level Controls
###Scope Variables
#### 04A: Cost Ceiling

Expectation: Initial Ceiling size positively estimates increasing probability of ceiling breaches and terminations and negatively estimates the option growth. Terminations and ceiling breaches simply comes down to large being associated with higher risk, while for option growth size imply makes it harder to grow proportionally.


```{r Model04A}
summary_continuous_plot(serv_smp1m,"UnmodifiedCeiling_OMB20_GDP18")
summary_continuous_plot(serv_smp1m,"UnmodifiedCeiling_OMB20_GDP18", log=TRUE)

#Frequency Plot for unlogged ceiling
summary_continuous_plot(serv_smp1m,"UnmodifiedCeiling_OMB20_GDP18",bins=1000)
summary_continuous_plot(serv_smp1m,"UnmodifiedCeiling_OMB20_GDP18",bins=50,log=TRUE)

#Model
Term_04A <- glm (data=serv_smp,
                 b_Term ~ cl_Ceil, family=binomial(link="logit"))

stargazer::stargazer(
                       Term_03D,Term_04A,
                       type="text",
                       digits=2)

summary_residual_compare(Term_04A, skip_vif = TRUE)


```

Contract ceiling has a significant relationship, high magnitude, in line with expectations, though with a bit of a sinsodial pattern in the residuals..

#### 04B: Maximum Duration

Expectation: Greater maximum duration will positively estimate the probability ceiling of  breaches and terminations. Greater growth for options is also expected, because year-on-year options may be more of a default, though the scatter plot seems to go the other way.

```{r Model04B}
#Frequency Plot for max duration
summary_continuous_plot(serv_smp1m,"UnmodifiedDays")
summary_continuous_plot(serv_smp1m,"UnmodifiedDays",log=TRUE)

#Model
Term_04B <- glm (data=serv_smp,
                 b_Term ~ cln_Days, family=binomial(link="logit"))

stargazer::stargazer(
                       Term_03D,Term_04A,Term_04B,
                       
                       type="text",
                       digits=2)



summary_residual_compare(Term_04B, skip_vif = TRUE)

```

All expections were upheld, even significant and greater magnitude than the ceiling.

####04C: Ratio Initial Base : Ceiling Ratio (Logged)

Expectation, a high ratio means that the contract has more room for adjustment and incentives without radical steps. So higher ratio of total ceiling to base are expected to be associated with a lower frequency of termination, lower frequency and size of ceiling breach. For exercised options, a higher ratio would is expected to make it more likely that some options are exercised but less likely that all options are exercised.

```{r Model04C}
summary_continuous_plot(serv_smp1m, "Base2Ceil",bins=100)
summary_continuous_plot(serv_smp1m, "Base2Ceil",log=TRUE)

#Model
Term_04C <- glm(data=serv_smp, b_Term ~ clr_Ceil2Base, family=binomial(link="logit"))


#Plot Residuals vs. Fitted
stargazer::stargazer(Term_03D,Term_04A,Term_04B,Term_04C, type="text", digits=2)



summary_residual_compare(Term_04C,bins=2)
```
Contrary to expectation, a larger base to ceil is associated with a much higher termination rate, though this may be driven by contracts with options being larger contracts, typically. 


#### 04D: Cumulative Ceiling Scope

```{r Model04D}


#Model
Term_04D <- glm (data=serv_smp,
                 b_Term ~ cl_Ceil +cln_Days+clr_Ceil2Base, family=binomial(link="logit"))

glmer_examine(Term_04D)
stargazer::stargazer(
                       Term_03D,Term_04A,Term_04B,Term_04C,Term_04D,
                       
                       type="text",
                       digits=2)



summary_residual_compare(Term_03D,Term_04D, bins=10)

```
Surprisingly ceiling loses significance but the base to ceiling ratio retains it. The expectations predicted the opposite. 

#### 04E: Base (Instead of Ceiling)
Expectation: As with initial ceiling, inital base estimates increasing probability of ceiling breaches and terminations and negatively estimates the option growth. Terminations and ceiling breaches simply comes down to large being associated with higher risk. For options growth, higher base is expected to make some options more likely, as project scale gives it more momentum, but likewise the scale is expected to make exercising all options less likely.

```{r Model04E}
summary_continuous_plot(serv_smp1m,"UnmodifiedBase_OMB20_GDP18")
summary_continuous_plot(serv_smp1m,"UnmodifiedBase_OMB20_GDP18", log=TRUE)

#Model
Term_04E <- glm (data=serv_smp,
                 b_Term ~ cln_Base, family=binomial(link="logit"))


stargazer::stargazer(
                       Term_03D,Term_04A,Term_04E,
                       
                       type="text",
                       digits=2)



summary_residual_compare(Term_04E, bins=10)

```
The relationship between base and termination is more complex, with two peaks than it is for ceiling. LIkewise it has less explanatory value. That said, the results are significant and in line with expectations.

#### 04F: Cumulative Ceiling Scope
The next step is to look at ratio of base to ceiling and initial maximum duration combined with base instead of ceiling.
```{r Model04F}


#Model
Term_04F <- glm (data=serv_smp,
                 b_Term ~ cln_Base +cln_Days+clr_Ceil2Base, family=binomial(link="logit"))

glmer_examine(Term_04F)
stargazer::stargazer(
                       Term_03D,Term_04A,Term_04B,Term_04C,Term_04D, Term_04E,Term_04F,
                       
                       type="text",
                       digits=2)



summary_residual_compare(Term_03D,Term_04F,Term_04D,Term_04F, bins=10)

```
There's marginal difference between the two, but descriptively it's easier to explain and thus likely worth using instead.

#### 04G: Cumulative  Model

```{r Model04G}

#Model
Term_04G <- glm (data=serv_smp,
                 b_Term ~ cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                   cn_PairHist7+cln_PairCA+
                   cln_Base + cln_Days+clr_Ceil2Base, family=binomial(link="logit"))
glmer_examine(Term_04G)


stargazer::stargazer(
                       Term_03D,Term_04D,Term_04F,Term_04G,Term_04G2,
                       
                       type="text",
                       digits=2)

#
summary_residual_compare(Term_03D,Term_04G2, bins=3)
summary_residual_compare(Term_04G,Term_04G2, bins=3)

```
Salary has increased in significance in the opposite direction as expection while CFTE has lost it. Ceiling/Base has regained signifiance, and other variables had small chains in magnitude. Per discussion in 04F, sticking with base as there seems to be no downside.


### Competition
#### 05A: No Competition / 1 / 2-4 / 5+ Offers
Expectations
No competition (baseline) and single offer competition  is expected to reduce willingness to terminate and increase frequency and size of terminations
all due to the absence of alternatives. For options, there is a weak expectation of fewer options exercised. 

Multioffer competition is expected to lead to more terminations, fewer and smaller ceiling breaches, abd  more options exercised for 2-4 options but fewer for 5+ as the diversity of competitors available may raise the appeal of going with a new contract rather than more options, especially if performance is below the desired level.

```{r Model05A}
summary_discrete_plot(serv_smp,"Comp")

#Model
Term_05A <- glm (data=serv_smp,
                 b_Term ~ Comp, family=binomial(link="logit"))



stargazer::stargazer(
                       Term_04G,Term_05A,
                       
                       type="text",
                       digits=2)


summary_residual_compare(Term_05A,bins=2)


```
For terminations, expectations were met for 2-4 offers and 5+ offers, but not for 1 offer. The magnitude of the relationship for 5+ offers is notable.

#### 05B: Cumulative  Model

```{r Model05B}

#Model
Term_05B <- glm (data=serv_smp,
                 b_Term ~ cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                   cn_PairHist7+cln_PairCA+
                   cln_Base + cln_Days+clr_Ceil2Base+
                   Comp, family=binomial(link="logit"))

glmer_examine(Term_05B)


stargazer::stargazer(
                       Term_04G,Term_05A,Term_05B,
                       
                       type="text",
                       digits=2)

#Plot residuals versus fitted   
summary_residual_compare(Term_04G,Term_05B)

```
Minimal effect on study variables. Otherwise some changes in magnitude but no large shifts with the partial exception of the dropping coefficient for 2-4 offers.

### Contract Vehicle

#### 06A: Def/Pur; S-IDC; M-IDC; FSS-GWAC; BPA-BOA.


Expectation: Indefinite delivery vehicles, means that the government has an existing relationship with the vendor and administration is easier. The downside is that the government may be locked into the vendor, although exit does not necessarily require outright termination, instead the government may simply cease to use a vehicle. Taken together, across the board the four categories of vehicles are expected to  negatively estimate the probability of termination. 

Ceiling breaches and excerised options are both less straightforward, are a more complex topic though the study expects a negative relationship as all forms of IDVs make it easier to use a new task order and thus may both reduce the need to exercise options and may allow new work to flow into a different contract rather than prompting a breach.


```{r Model06A}

summary_discrete_plot(serv_smp,"Veh")

#Model
Term_06A <- glm (data=serv_smp,
                 b_Term ~ Veh, family=binomial(link="logit"))


stargazer::stargazer(
                       Term_05B,Term_06A,
                       type="text",
                       digits=2)

#Plot residuals versus fitted
summary_residual_compare(Term_04G,Term_05B)

```

For terminations expectation were upheld or BPA/BOA and S-IDCs and to a lesser extent for FSS/GWAC contracts. They were not upheld for multi-award, which are not significant.



#### 06B: Cumulative  Model

```{r Model06B}

#Model
Term_06B <- glm (data=serv_smp,
                 b_Term ~ cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                   cn_PairHist7+cln_PairCA+
                   cln_Base + cln_Days+clr_Ceil2Base+
                   Comp+
                   Veh, family=binomial(link="logit"))

glmer_examine(Term_06B)



stargazer::stargazer(
                       Term_05B,Term_06A,Term_06B,
                       
                       type="text",
                       digits=2)


#Plot residuals versus fitted   
summary_residual_compare(Term_05B,Term_06B)

```
Expectations for vehicle are now upheld for both terminations. Ceiling lost significance, performance based contracting gained significance at the 0.1 level, and magnitude for other variables fluxuated.


### Type of Contract

The next step adds a measure for whether the contract was cost-based or fixed-price. 

Expectation Prior CSIS research has found that fixed-price contracts estimate a higher probability of terminations but did not find a notable relationship for ceiling breaches.

#### 07A: FFP / Other FP / Incentive / T&M/FP:LOE;LH / Other CB / Combination

Firm-fixed price contracting is expected to be associated with a high rate of options exercised, more ceiling breaches, and a strong expectation of greater levels of termination.

(Options, breach, termination)
Firm-Fixed Price (base)				+	+	++
Other Fixed Price				-	-	-
Time & Materials / Labor Hours / FP: LoE				-	+	-
Incentive Fee (both FPIF or CBIF)				+	-	-
Other Cost Based				-	-	-
Undefinitized Contract Award				--	++	++
Combination				-	+	+


```{r Model07A}
serv_smp$Pricing<-factor(serv_smp$Pricing,
                            levels=c( "FFP","Other FP","T&M/LH/FPLOE","Incentive","Other CB","UCA" ,"Combination or Other" ))
serv_opt$Pricing<-factor(serv_opt$Pricing,
                            levels=c( "FFP","Other FP","T&M/LH/FPLOE","Incentive","Other CB","UCA" ,"Combination or Other" ))
summary_discrete_plot(serv_smp,"Pricing")

#Model
Term_07A <- glm (data=serv_smp,
                 b_Term ~ Pricing, family=binomial(link="logit"))


#Plot residuals versus fitted
stargazer::stargazer(
                       Term_06B,Term_07A,
                       
                       type="text",
                       digits=2)


summary_residual_compare(Term_07A,bins=2)

```

For terminations firm fixed price (baseline), incentive, cost-based, and combination or other were in line with expectations. Fixed price other defies expectations of being lower risk and UCA and combination defy expectations by being negative.



#### 07B: Cumulative  Model

```{r Model07B}

#Model
Term_07B <- glm (data=serv_smp,
                 b_Term ~ cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                   cn_PairHist7+cln_PairCA+
                   cln_Base + cln_Days+clr_Ceil2Base+
                   Comp+
                   Veh+
                   Pricing, family=binomial(link="logit"))

glmer_examine(Term_07B)



stargazer::stargazer(
                       Term_06B,Term_07A,Term_07B,
                       
                       type="text",
                       digits=2)

#Plot residuals versus fitted   
summary_residual_compare(Term_06B,Term_07B)

```

Other fixed price loses significance.
Performance based services loses significance. CFTE gains significance in line with expectations.
Ceiling regains significance.


### Crisis Dataset
Expectation: Service Contract replying on crisis funds would have more likelihood of cost-ceiling breaches and exercised options but fewer terminations.  

#### 08A: Crisis Funding
```{r Model08A}
summary_discrete_plot(serv_smp,"Crisis")

#Model
Term_08A <- glm (data=serv_smp,
                 b_Term ~ Crisis, family=binomial(link="logit"))


stargazer::stargazer(
                       Term_07B,Term_08A,
                       
                       type="text",
                       digits=2)

#Plot residuals versus fitted
summary_residual_compare(Term_08A,bins=2)

```

ARRA and OCO were significant in line with expectations. 



#### 08B: Cumulative  Model

```{r Model08B}

#Model
Term_08B <- glm (data=serv_smp,
                 b_Term ~ cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                   cn_PairHist7+cln_PairCA+
                   cln_Base + cln_Days+clr_Ceil2Base+
                   Comp+
                   Veh+
                   Pricing+
                   Crisis, family=binomial(link="logit"))

glmer_examine(Term_08B)


stargazer::stargazer(
                       Term_07B,Term_08A,Term_08B,
                       
                       type="text",
                       digits=2)


#Plot residuals versus fitted   
summary_residual_compare(Term_07B,Term_08B)

```

Terminations for OCO and ARRA are now significant in the expected direction. Performance based and CFTE swap significance.


## Industrial Sector

### Level 6

#### Model 09A: l_def6_HHI_lag1
(Options, breach, termination)
HHI (logged, + means more consolidation)	cln_Def6HHI+	-	+	-

Expectations are  unchanged.
```{r Model09A}

summary_continuous_plot(serv_smp1m,"def6_HHI_lag1")
summary_continuous_plot(serv_smp1m,"def6_HHI_lag1",log=TRUE)


#Model
Term_09A <- glm (data=serv_smp,
                 b_Term ~ cln_Def6HHI, family=binomial(link="logit"))


#Plot residuals versus fitted
stargazer::stargazer(
                       Term_08B,Term_09A,
                       
                       type="text",
                       digits=2)


summary_residual_compare(Term_09A, skip_vif = TRUE,bin=20)

```

Not significant for terminations, though in expected direction.

#### Model 09B: Defense to Overall ratio
The higher the ratio of defense obligations to reciepts in the overall economy, the DoD holds a monosopy over a sector. Given the challenges of monosopy, the a higher ratio estimates a greater  risk of ceiling breaches.

(Options, breach, termination)
Ratio Def. obligatons : US revenue	cln_Def6Obl+		+	-	-

```{r Model09B}

summary_continuous_plot(serv_smp1m,"def6_ratio_lag1")

summary_continuous_plot(serv_smp1m,"def6_ratio_lag1",log=TRUE)

#Model
Term_09B <- glm (data=serv_smp,
                 b_Term ~ clr_Def6toUS, family=binomial(link="logit"))


#Plot residuals versus fitted
stargazer::stargazer(
                       Term_08B,Term_09A,Term_09B,
                       
                       type="text",
                       digits=2)



summary_residual_compare(Term_09B)



```
Significant, in line with expectations, and higher magnitude.

#### Model 09C: Defense Obligations
(Options, breach, termination)
Defense obligations (logged)	clr_Def6toUS+		-	-	+

```{r Model09C}

summary_continuous_plot(serv_smp1m,"def6_obl_lag1Const")

summary_continuous_plot(serv_smp1m,"def6_obl_lag1Const",log=TRUE)


#Model
Term_09C <- glm (data=serv_smp,
                 b_Term ~ cln_Def6OblConst, family=binomial(link="logit"))

stargazer::stargazer(Term_09A,Term_09B,Term_09C,
                       
                       type="text",
                       digits=2)


summary_residual_compare(Term_09C)


```

Not signicant and weakly contrary to expectation.

#### Model 09D: NAICS6 6 Combined
Consolidation at lessa nd more granular levels may have different effects. Efficiencies are often used to describe sectors, like utilities, with high barriers to entry. Many of these aspects seem like they would already be captured at less granular NAICS6 levels, e.g. power plants, rather than more specific NAICS6 levels, like solar vs. coal. As a result, consolidation for more granular NAICS6 codes should estimate higher rates of ceiling breaches compared to less granular NAICS6 code.

```{r Model09D}




#Model
Term_09D <- glm (data=serv_smp,
                 b_Term ~ cln_Def6HHI+clr_Def6toUS+cln_Def6OblConst
                 , family=binomial(link="logit"))

glmer_examine(Term_09D)

Term_09D2 <- glm (data=serv_smp,
                 b_Term ~ cln_Def6HHI+clr_Def6toUS
                 , family=binomial(link="logit"))

glmer_examine(Term_09D2)


stargazer::stargazer(Term_09A,Term_09B,Term_09C,Term_09D,Term_09D2,
                     
                       type="text",
                       digits=2)

summary_residual_compare(Term_09D,Term_09D2, bins=10)
```
Obligations is contrary to expectations and ultimately covered by office veriables. 

HHI is significant at the 0.1 level and contrary to expectations. Ratio is significant and has a large coefficient and is line with expectations.


#### Model 09E: Cumulative Model
Consolidation at less and more granular levels may have different effects. Efficiencies are often used to describe sectors, like utilities, with high barriers to entry. Many of these aspects seem like they would already be captured at less granular NAICS6 levels, e.g. power plants, rather than more specific NAICS6 levels, like solar vs. coal. As a result, consolidation for more granular NAICS6 codes should estimate higher rates of ceiling breaches compared to less granular NAICS6 code.

We'll start by adding in everything from both models and seeing what violates VIF.
```{r Model09E}


#Model
Term_09E <- glm (data=serv_smp,
                 b_Term ~ cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                   cn_PairHist7+cln_PairCA+
                   cln_Base + cln_Days+clr_Ceil2Base+
                   Comp+
                   Veh+
                   Pricing+
                   Crisis+
                   cln_Def6HHI+clr_Def6toUS, family=binomial(link="logit"))
glmer_examine(Term_09E)


stargazer::stargazer(Term_08B,Term_09D2,Term_09E,type="text",
                       digits=2)

summary_residual_compare(Term_08B,Term_09E)
```

No big changes from integration.


### Level 3
#### Model 10A: cl_def3_HHI
(Options, breaches, and terminations)
HHI (logged, + means more consolidation)	cln_Def3HHI		TRUE	-	+	++

```{r Model10A}

summary_continuous_plot(serv_smp1m,"def3_HHI_lag1")
summary_continuous_plot(serv_smp1m,"def3_HHI_lag1",log=TRUE)

#Model
Term_10A <- glm (data=serv_smp,
                 b_Term ~ cln_Def3HHI, family=binomial(link="logit"))


stargazer::stargazer(
                       Term_09A,Term_10A,
                       
                       type="text",
                       digits=2)

summary_residual_compare(Term_10A, skip_vif =  TRUE)



```

Expectations are upheld with a signicant reasult with reasonable magnitude. Level 3 HHI seems to slightly out perform level 6.


#### Model 10B: Defense to Overall ratio
(Options, breaches, and terminations)
Ratio Def. obligatons : US revenue	clr_Def3toUS+		-	+	+

```{r Model10B}

summary_continuous_plot(serv_smp1m,"capped_def3_ratio_lag1")
summary_continuous_plot(serv_smp1m,"capped_def3_ratio_lag1",log=TRUE)

#Model
Term_10B <- glm (data=serv_smp,
                 b_Term ~ clr_Def3toUS, family=binomial(link="logit"))


stargazer::stargazer(
                       Term_09B,Term_10A,Term_10B,
                       
                       type="text",
                       digits=2)

summary_residual_compare(Term_10B, skip_vif = TRUE)
```

Expectations were not upheld.


#### Model 10C: NAICS6 6 and NAICS6 3
Consolidation at lessa nd more granular levels may have different effects. Efficiencies are often used to describe sectors, like utilities, with high barriers to entry. Many of these aspects seem like they would already be captured at less granular NAICS6 levels, e.g. power plants, rather than more specific NAICS6 levels, like solar vs. coal. As a result, consolidation for more granular NAICS6 codes should estimate higher rates of ceiling breaches compared to less granular NAICS6 code.

We'll start by adding in everything from both models and seeing what violates VIF.
```{r Model10C}
#Model
Term_10C <- glm (data=serv_smp,
                 b_Term ~ cln_Def6HHI+clr_Def6toUS+
                   cln_Def3HHI+clr_Def3toUS, family=binomial(link="logit"))
glmer_examine(Term_10C)

stargazer::stargazer(
                     Term_08B,Term_09E,Term_10A,Term_10B,Term_10C,
                     
                       type="text",
                       digits=2)

summary_residual_compare(Term_08B,Term_10C,Term_09E,Term_10C)
```

HHI6 is now in line with expectations and significant. Otherwise magnitudes fluctuated.

#### Model 10D: Cumulative Model
.
```{r Model10D}



#Model
Term_10D <- glm (data=serv_smp,
                 b_Term ~ cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                   cn_PairHist7+cln_PairCA+
                   cln_Base + cln_Days+clr_Ceil2Base+
                   Comp+
                   Veh+
                   Pricing+
                   Crisis+
                   cln_Def6HHI+clr_Def6toUS+
                   cln_Def3HHI+clr_Def3toUS, family=binomial(link="logit"))

glmer_examine(Term_10D)


stargazer::stargazer(Term_09E,Term_10C,Term_10D,
                     
                       type="text",
                       digits=2)

summary_residual_compare(Term_09E,Term_10D)
```

HHi6 becomes less significant, Salary loses significance and flips sign, performance based regains significance but pair history loses it. 
## Office 
### Office and Vendor-Office Pair

#### Model 11A: Vendor Market Share
Expectation: Contracts of offices partnered with vendors who have larger market shares would be more likely to experience cost ceiling (++) breaches and exercised options, but less likely to have terminations.

```{r Model11A}

summary_continuous_plot(serv_smp1m,"pMarket")
summary_continuous_plot(serv_smp1m,"pMarket",log=TRUE)

#Model
Term_11A <- glm (data=serv_smp,
                 b_Term ~ cp_PairObl7, family=binomial(link="logit"))


stargazer::stargazer(
                      Term_11A,
                       
                       type="text",
                       digits=2)

summary_residual_compare(Term_11A)
```

Aligns with expectations on terminations.


#### Model 11B: Cumulative Model

```{r Model11B}



#Model
Term_11B <- glm (data=serv_smp,
                 b_Term ~ cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                   cn_PairHist7+cln_PairCA+
                   cln_Base + cln_Days+clr_Ceil2Base+
                   Comp+
                   Veh+
                   Pricing+
                   Crisis+
                   cln_Def6HHI+clr_Def6toUS+
                   cln_Def3HHI+clr_Def3toUS+
                   cp_PairObl7, family=binomial(link="logit"))

glmer_examine(Term_11B)


stargazer::stargazer(
                     Term_10D,Term_11A,Term_11B,
                     
                       type="text",
                       digits=2)

summary_residual_compare(Term_10D,Term_11B)

```
CFTE regains significance at the 0.05 level.  PMarket grows a little stronger.

OCO loses signifiance.

### Other Office Characteristics
#### 12A: Past Office Volume (dollars)

Expectation: Contracting offices previously had more contract volume in dollars would have more experience managing cost and preventing cost-ceiling breaches, therefore larger past office volume would lower the likelihood of cost-ceiling breaches but no substantial relationships with likelihood of terminations or exercised options.
(Option, Breach, Termination)
Past Office Volume $s	cln_OffObl7		+	-	+
From looking at data, terminations, easier for big, less dependent. - less dependenct

```{r Model12A}
summary_continuous_plot(serv_smp1m,"office_obligatedamount_7year")
summary_continuous_plot(serv_smp1m,"office_obligatedamount_7year",log=TRUE)

#Model
Term_12A <- glm (data=serv_smp,
                 b_Term ~ cln_OffObl7, family=binomial(link="logit"))


stargazer::stargazer(Term_11B,
                       Term_12A,
                       
                       type="text",
                       digits=2)


summary_residual_compare(Term_12A, skip_vif = TRUE)



```

Out of our expectation, the results also showed increasing past office volume would increase likelihood of having terminations.




#### 12B: Detailed Industry Focus

Expectation: If a office is focused on a smaller number of industries than it has a less complex set of responsibilities which would decrease the likelihood of having cost ceiling breaches and terminations, and increase the likelihood of having options exercised.

```{r Model12B}

summary_continuous_plot(serv_smp1m,"cln_OffFocus")

#Model
Term_12B <- glm (data=serv_smp,
                 b_Term ~ cln_OffFocus, family=binomial(link="logit"))



stargazer::stargazer(Term_11B,
                     Term_12A,
                       Term_12B,
                       
                       type="text",
                       digits=2)


summary_residual_compare(Term_12B, skip_vif = TRUE, bins=10)

```

When using hhi calculated based on contracting office number of contracts: considering hhi alone, termination expectations were  not met.

#### 12C: Cumulative Model

```{r Model12C}



#Model
Term_12C <- glm (data=serv_smp,
                 b_Term ~ cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                   cn_PairHist7+cln_PairCA+
                   cln_Base + cln_Days+clr_Ceil2Base+
                   Comp+
                   Veh+
                   Pricing+
                   Crisis+
                   cln_Def6HHI+clr_Def6toUS+
                   cln_Def3HHI+clr_Def3toUS+
                   cp_PairObl7+
                   cln_OffObl7+cln_OffFocus, family=binomial(link="logit"))

glmer_examine(Term_12C)


stargazer::stargazer(
                     Term_11B,Term_12A,Term_12B,Term_12C,
                     
                       type="text",
                       digits=2)

summary_residual_compare(Term_10D,Term_12C)
summary_residual_compare(Term_11B,Term_12C)
```
Pair history regains significance at the 0.05 level but HHI loses it. Both volume and focus stay significant but have their magnitude sharply reduced.
# Interactions
(Option, Breach, Termination)
Firm-Fixed Price (base)				--	+	++
Other Fixed Price				-	+	+
Time & Materials / Labor Hours / FP: LoE				-	+	+
Incentive Fee (both FPIF or CBIF)				++	--	--
Other Cost Based				+	-	-
Undefinitized Contract Award				+	-	-
Combination				+	-	-

####15A: Average U.S. Salaries (logged):Contract Pricing
Cost-based and incentive contract types may do a  better job at handling complex contracts.

```{r}
summary_continuous_plot(serv_smp1m,"cln_Base_Then_Year","Pricing",metric="cbre")

#Create the models
term_salary_pricing_15A_no_interact <- glm(data=serv_smp, b_Term ~ Pricing + cl_US6_avg_sal_lag1,
                                           family=binomial(link="logit"))
glmer_examine(term_salary_pricing_15A_no_interact)

term_salary_pricing_15A <- glm(data=serv_smp, b_Term ~ Pricing + cl_US6_avg_sal_lag1 + Pricing:cl_US6_avg_sal_lag1,
                               family=binomial(link="logit"))
glmer_examine(term_salary_pricing_15A)


#compare the models

stargazer::stargazer(term_salary_pricing_15A_no_interact, term_salary_pricing_15A, type="text", digits=2)

summary_residual_compare(term_salary_pricing_15A_no_interact, term_salary_pricing_15A, bins=10)
```
Other cost based and other fixed price are in line with expectations. UCA is strongly contrary to expectations.
####15B: Cumulative
```{r}
#Create the model
term_salary_pricing_15B <- glm(data=serv_smp, b_Term ~ cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                 cn_PairHist7+cln_PairCA +
                   cln_Base + cln_Days+ clr_Ceil2Base+
                   Comp+
                   Veh+
                   Pricing+
                   Crisis+
                   cln_Def6HHI+clr_Def6toUS+
                   cln_Def3HHI+clr_Def3toUS+
                   cp_PairObl7+
                   cln_OffObl7+cln_OffFocus + Pricing:cl_US6_avg_sal_lag1, 
                 family=binomial(link="logit"))

glmer_examine(term_salary_pricing_15B)


```
Excluded for VIF reasons.

####16A: Office Partnership:Actions
Performance based contracting should  encourage higher communication interactions and allow for more flexability, potentially increasing the benefits of regular interaction.
(Options, Breach, Terminations)
Interact: Actions	cp_OffPerf7:cln_PairCA			+	-	-
```{r}
summary_continuous_plot(serv_smp1m,"cp_OffPerf7","cln_PairCA",metric="cbre")

#Create the models
term_partnership_actions_16A_no_interact <- glm(data=serv_smp, b_Term ~ cp_OffPerf7 + cln_PairCA,
                                                family=binomial(link="logit"))
glmer_examine(term_partnership_actions_16A_no_interact)

term_partnership_actions_16A <- glm(data=serv_smp, b_Term ~ cp_OffPerf7 + cln_PairCA + cp_OffPerf7:cln_PairCA,
                                    family=binomial(link="logit"))
glmer_examine(term_partnership_actions_16A)


#compare the models

stargazer::stargazer(term_partnership_actions_16A_no_interact, term_partnership_actions_16A, type="text", digits=2)

summary_residual_compare(term_partnership_actions_16A_no_interact, term_partnership_actions_16A, bins=5)

```
Expectations are contrary to expectations.
####16B: Cumulative
```{r}

#Create the model
term_partnership_actions_16B <- glm(data=serv_smp, b_Term ~ cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                 cn_PairHist7+cln_PairCA +
                   cln_Base + cln_Days+ clr_Ceil2Base+
                   Comp+
                   Veh+
                   Pricing+
                   Crisis+
                   cln_Def6HHI+clr_Def6toUS+
                   cln_Def3HHI+clr_Def3toUS+
                   cp_PairObl7+
                   cln_OffObl7+cln_OffFocus + cp_OffPerf7:cln_PairCA,
                 family=binomial(link="logit"))

#Compare the models
stargazer::stargazer(term_partnership_actions_16B, Term_12C, type="text", digits=2)

summary_residual_compare(term_partnership_actions_16B, Term_12C, bins=5)
```
Not significant though in line with expectatiosn. Though the AIC has increased suggesting. This will not be added to the model.

####17A: Office Partnership:Market Vendor Share for that Office
Performance based contracting is thought to mitigte some of the risks of vendor  lock.
(option,breach,termination)
Interact: Market Share Vendor for that Office	cp_OffPerf7: cp_PairObl7			++	--	--

```{r}
summary_double_continuous(serv_smp1m,"cp_OffPerf7","cp_PairObl7")

#Define the models
term_partnership_share_17A_no_interact <- glm(data=serv_smp, b_Term ~ cp_OffPerf7 + cp_PairObl7,
                 family=binomial(link="logit"))
glmer_examine(term_partnership_share_17A_no_interact)

term_partnership_share_17A <- glm(data=serv_smp, b_Term ~ cp_OffPerf7 + cp_PairObl7 + cp_OffPerf7:cp_PairObl7,
                 family=binomial(link="logit"))
glmer_examine(term_partnership_share_17A)

#Compare the models
stargazer::stargazer(term_partnership_share_17A_no_interact, term_partnership_share_17A, type="text", digits=2)

summary_residual_compare(term_partnership_share_17A_no_interact, term_partnership_share_17A, bins=5)
```
Significant and contrary to expectation, small reduction in AIC.
####17B: Cumulative
```{r}
#Create the model
term_partnership_share_17B <- glm(data=serv_smp, b_Term ~ cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                 cn_PairHist7+cln_PairCA +
                   cln_Base + cln_Days+ clr_Ceil2Base+
                   Comp+
                   Veh+
                   Pricing+
                   Crisis+
                   cln_Def6HHI+clr_Def6toUS+
                   cln_Def3HHI+clr_Def3toUS+
                   cp_PairObl7+
                   cln_OffObl7+cln_OffFocus + cp_OffPerf7:cp_PairObl7,
                 family=binomial(link="logit"))
glmer_examine(term_partnership_share_17B)

#Compare the models
stargazer::stargazer(Term_12C, term_partnership_share_17B, type="text", digits=2)

summary_residual_compare(Term_12C, term_partnership_share_17B, bins=5)
```
No value added according to AIC. Leave it out.

####17C: Office Volume:Market Vendor Share for that Office
A small office heavily reliant on a single vendor may just be practical consolidation of contract. For a large office, said primacy is more noteworthy and may indicate vendor lock-in. In keeping with p_Market as a whole this may mean more options exercised and fewer terminations  given the absence of other choices. However, a greater likelihood of ceiling breaches and a greater size of ceiling breaches is the expected donside.

(option,breach,termination)
Interact: Office Volume cln_OffObl7: cp_PairObl7		+	+	-


```{r Model17C}
#Define the models


Term17C_no_interact <- glm(data=serv_smp, b_Term ~ cln_OffObl7 + cp_PairObl7, family=binomial(link="logit"))
glmer_examine(Term17C_no_interact)

Term17C <- glm(data=serv_smp, b_Term ~ cln_OffObl7 + cp_PairObl7 + cln_OffObl7:cp_PairObl7, family=binomial(link="logit"))
glmer_examine(Term17C)


#Compare the models
stargazer::stargazer(Term17C_no_interact, Term17C, type="text", digits=2)

summary_residual_compare(Term17C_no_interact, Term17C)
```
The interaction significantly estimates a greater risk of termination. This is contrary to the expectation that this interaction might capture lock-in.

####17D: Cumulative
```{r Model17D}
#Create the model
Term17D <- glm(data=serv_smp,
                        b_Term ~  cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                 cn_PairHist7+cln_PairCA+
                 cln_Base + clr_Ceil2Base + cln_Days+
                 Comp+
                   Veh+
                   Pricing+
                   Crisis+
                 cln_Def6HHI+clr_Def6toUS+
                 cln_Def3HHI+
                   clr_Def3toUS+
                 cp_PairObl7+
                   cln_OffObl7+ 
                 cln_OffFocus+cln_OffObl7:cp_PairObl7, family=binomial(link="logit"))
glmer_examine(Term17D)


#Compare the models
stargazer::stargazer(Term_12C, Term17D,type="text", digits=2)



summary_residual_compare(Term_12C, Term17D,bins=50)
```
Result is significant at the 0.1 level, estimates a higher risk of terminations contrary to expectation, and adds little to the in AIC terms model, leaving it out.

####18A: Office Partnership:Initial Contract Duration (logged)
Performance  based contracting is thought to mitigate the risks of longer time horizons and may even work  better with  them by incentivizing vendor investments.
(option, breach, term)
Interact: Initial Contract Duration (logged)	cp_OffPerf7: capped_cln_Days			++	--	--

```{r Model18A}
summary_double_continuous(serv_smp1m,"cp_OffPerf7","cln_Days")

#Create the Model
term_partnership_duration_18A_no_interact <- glm(data=serv_smp , b_Term ~ cp_OffPerf7 + cln_Days,
                 family=binomial(link="logit"))
glmer_examine(term_partnership_duration_18A_no_interact)

term_partnership_duration_18A <- glm(data=serv_smp, b_Term ~ cp_OffPerf7 + cln_Days + cp_OffPerf7: cln_Days,
                 family=binomial(link="logit"))
glmer_examine(term_partnership_duration_18A)

#Compare the models
stargazer::stargazer(term_partnership_duration_18A_no_interact, term_partnership_duration_18A, type="text", digits=2)

summary_residual_compare(term_partnership_duration_18A_no_interact, term_partnership_duration_18A, bins=5)
```
Significant and contrary to expectation.

####18B: Cumulative
```{r Model18B}
#Create the model
term_partnership_duration_18B <- glm(data=serv_smp, b_Term ~ cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                 cn_PairHist7+cln_PairCA +
                   cln_Base + cln_Days+ clr_Ceil2Base+
                   Comp+
                   Veh+
                   Pricing+
                   Crisis+
                   cln_Def6HHI+clr_Def6toUS+
                   cln_Def3HHI+clr_Def3toUS+
                   cp_PairObl7+
                   cln_OffObl7+cln_OffFocus + cp_OffPerf7:cln_Days,
                 family=binomial(link="logit"))

#Compare the models
stargazer::stargazer(Term_12C,term_partnership_duration_18B,  type="text", digits=2)

summary_residual_compare( Term_12C,term_partnership_duration_18B, bins=5)
```
Significant but contrary to expectation. Tentatively excluding.


####19A: Past Years:Contract Pricing
Positive prior relationships increase the effectiveness of cost-based contracts. T&M / LH / FP: LoE are in the middle here, so leaving  them out.

(Option, Breach,Term)
Firm-Fixed Price (base)				-	+	+
Other Fixed Price				-	+	+
Time & Materials / Labor Hours / FP: LoE						
Incentive Fee (both FPIF or CBIF)				++	--	--
Other Cost Based				+	-	-
Undefinitized Contract Award				+	-	-
Combination				+	-	-
```{r}
summary_discrete_plot(serv_smp1m,"cn_PairHist7","Pricing")

#Create the models
term_history_pricing_19A_no_interact <- glm(data=serv_smp, b_Term ~ cn_PairHist7 + Pricing,
                 family=binomial(link="logit"))
glmer_examine(term_history_pricing_19A_no_interact)

term_history_pricing_19A <- glm(data=serv_smp, b_Term ~ cn_PairHist7 + Pricing + cn_PairHist7:Pricing,
                 family=binomial(link="logit"))
glmer_examine(term_history_pricing_19A)

#Compare the models
stargazer::stargazer(term_history_pricing_19A_no_interact, term_history_pricing_19A, type="text", digits=2)

summary_residual_compare(term_history_pricing_19A_no_interact, term_history_pricing_19A, bins=5)
```
Combination in line with expectations. Others are as well, but almost nothing is significant. 
####19B: Cumulative
```{r}
#Create the model
term_history_pricing_19B <- glm(data=serv_smp, b_Term ~ cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                 cn_PairHist7+cln_PairCA +
                   cln_Base + cln_Days+ clr_Ceil2Base+
                   Comp+
                   Veh+
                   Pricing+
                   Crisis+
                   cln_Def6HHI+clr_Def6toUS+
                   cln_Def3HHI+clr_Def3toUS+
                   cp_PairObl7+
                   cln_OffObl7+cln_OffFocus + cn_PairHist7:Pricing,
                 family=binomial(link="logit"))

#Compare the models
stargazer::stargazer(Term_12C,term_history_pricing_19B,  type="text", digits=2)

summary_residual_compare(Term_12C, term_history_pricing_19B, bins=5)
```
Largely not significant and only lowers AIC a bit, but seems worth leaving in for now.

####20A: Competition:NAICS6 Detailed Industry (Level 6)
If competition is an instrument for consolidation, than it should be most effective when consolidation is lower.

(Option, Breach,Term)
No Competition (Baseline)				-	++	-
1 Offer:				-	+	-
2-4 Offers				+	-	+
5+ Offers				-	-	+
```{r}
summary_continuous_plot(serv_smp1m,"cln_Def6HHI","Comp",metric="cbre")

#Create the models
term_competition_naics_20A_no_interact <- glm(data=serv_smp, b_Term ~ Comp + cln_Def6HHI,
                 family=binomial(link="logit"))
glmer_examine(term_competition_naics_20A_no_interact)

term_competition_naics_20A <- glm(data=serv_smp, b_Term ~ Comp + cln_Def6HHI + Comp:cln_Def6HHI,
                 family=binomial(link="logit"))
glmer_examine(term_competition_naics_20A)

```
Excluded on VIF grounds.

####20B: Cumulative
```{r Model20B}
#Create the model
n_cbre_competition_naics_20B <- glm(data=serv_breach, ln_CBre_OMB20_GDP18 ~ cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                 cn_PairHist7+cln_PairCA +
                   cln_Base + clr_Ceil2Base + cln_Days
                   Comp+
                   Veh+
                   Pricing+
                   Crisis+
                   cln_Def6HHI+clr_Def6toUS+
                   cln_Def3HHI+clr_Def3toUS+
                   cp_PairObl7+
                   cln_OffObl7+cln_OffFocus + Comp:cln_Def6HHI)

#Compare the models
stargazer::stargazer(n_cbre_competition_naics_20B, n_CBre13B, type="text", digits=2)

summary_residual_compare(n_cbre_competition_naics_20B, n_CBre13B, bins=5)
```

####21A: Ratio Initial Base to Ceiling Ratio (logged):Initial Contract Ceiling (logged)
This interaction approximates has a role similar to that of contract ceiling, although due to centering and logging it isn't equivalent. Thus in essence it covers the dollars rather than merely the proportion available for options. More option  space gives more flexibility to the government and may lessen the need for ceiling breaches and terminations. Likewise, this interaction provides something like the dollar size of available  options, so naturally it can be associated with a greater spending.
(Options, Breach, Terminations)
Initial Contract Ceiling (logged)	clr_Ceil2Base:cln_Base		TRUE	++	-	-
```{r}
summary_double_continuous(serv_smp1m,"clr_Ceil2Base","cln_Base")

#Create the models
term_base2ceil_ceiling_21A_no_interact <- glm(data=serv_smp, b_Term ~ clr_Ceil2Base + cln_Base,
                 family=binomial(link="logit"))
glmer_examine(term_base2ceil_ceiling_21A_no_interact)

term_base2ceil_ceiling_21A <- glm(data=serv_smp, b_Term ~ clr_Ceil2Base + cln_Base + clr_Ceil2Base:cln_Base,
                 family=binomial(link="logit"))
glmer_examine(term_base2ceil_ceiling_21A)

#Compare the Models
stargazer::stargazer(term_base2ceil_ceiling_21A_no_interact, term_base2ceil_ceiling_21A, type="text", digits=2)

summary_residual_compare(term_base2ceil_ceiling_21A_no_interact, term_base2ceil_ceiling_21A, bins=20)
```
Not significant, no longer in line with expecations. Leaving it out.
####21B: Cumulative
```{r}
#Create the model
term_base2ceil_ceiling_21B <- glm(data=serv_smp, b_Term ~ cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                 cn_PairHist7+cln_PairCA +
                   cln_Base + cln_Days+ clr_Ceil2Base+
                   Comp+
                   Veh+
                   Pricing+
                   Crisis+
                   cln_Def6HHI+clr_Def6toUS+
                   cln_Def3HHI+clr_Def3toUS+
                   cp_PairObl7+
                   cln_OffObl7+cln_OffFocus +
                    cn_PairHist7:Pricing+ 
                   clr_Ceil2Base:cln_Base,
                 family=binomial(link="logit"))
glmer_examine(term_base2ceil_ceiling_21B)
#Compare the models
stargazer::stargazer(term_history_pricing_19B, term_base2ceil_ceiling_21B, type="text", digits=2)

summary_residual_compare(term_base2ceil_ceiling_21B, term_history_pricing_19B, bins=100)
```
In line with expectations, helps with AIC, significant, though does throw off the highest end of the fitted range.

####22A: Available Options:Initial Contract Duration (logged)
Option years are commonly associated with long contracts. This approach reduces the need for terminations and may increase the extend of options exercised as it means continuing a contract rather than including additional features. Option years may also provide more options for cost controls. and reduce ceiling breaches.
(Options, Ceiling Breach, Terminations)
++	-	-

```{r Model22A}
summary_double_continuous(serv_smp1m,"clr_Ceil2Base","cln_Days")

#Create Models
term_base2ceil_duration_22A_no_interact <- glm(data=serv_smp, b_Term ~ clr_Ceil2Base + cln_Days,
                 family=binomial(link="logit"))
glmer_examine(term_base2ceil_duration_22A_no_interact)

term_base2ceil_duration_22A <- glm(data=serv_smp, b_Term ~ clr_Ceil2Base + cln_Days + clr_Ceil2Base:cln_Days,
                 family=binomial(link="logit"))
glmer_examine(term_base2ceil_duration_22A)

#Compare the Models
stargazer::stargazer(term_base2ceil_duration_22A_no_interact, term_base2ceil_duration_22A, type="text", digits=2)

summary_residual_compare(term_base2ceil_duration_22A_no_interact, term_base2ceil_duration_22A, bins=5)
```
Significant but contrary to expectations and small AIC increase.
####22B: Cumulative
```{r}
#Create the model
term_base2ceil_duration_22B <- glm(data=serv_smp, b_Term ~ cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                 cn_PairHist7+cln_PairCA +
                   cln_Base + cln_Days+ clr_Ceil2Base+
                   Comp+
                   Veh+
                   Pricing+
                   Crisis+
                   cln_Def6HHI+clr_Def6toUS+
                   cln_Def3HHI+clr_Def3toUS+
                   cp_PairObl7+
                   cln_OffObl7+cln_OffFocus +
                    cn_PairHist7:Pricing+ 
                   clr_Ceil2Base:cln_Base +
                 clr_Ceil2Base:cln_Days,
                 family=binomial(link="logit"))
glmer_examine(term_base2ceil_duration_22B)

#Compare the models
stargazer::stargazer(term_base2ceil_ceiling_21B, term_base2ceil_duration_22B, type="text", digits=2)

summary_residual_compare( term_base2ceil_ceiling_21B, term_base2ceil_duration_22B,bins=100)
```

Contrary to expectation, does little to reduce  AIC, leaving it out.

## Pre-Multilevel Model Summary

```{r StudyVariableLevel1}


 # !is.na(def_serv$cl_US6_avg_sal_lag1)&
 #  !is.na(def_serv$cln_PSCrate)&
 #  !is.na(def_serv$cp_OffPerf7)&
 #  !is.na(def_serv$cp_OffPSC7)&
 #  !is.na(def_serv$cn_PairHist7)&
 #  !is.na(def_serv$cln_PairCA)&


#Terminations
stargazer::stargazer(Term_01A,Term_01B,Term_02A,Term_02B,Term_03A,Term_03B,Term_03D,term_history_pricing_19B,
                       type="text",
                       digits=2)




texreg::htmlreg(list(Term_01A,Term_01B,Term_02A,Term_02B,Term_03A,Term_03B,Term_03D,Term_12C),file="..//Output//Term_model_lvl1.html",
                single.row = TRUE,
                # custom.model.name=c("Ceiling Breaches"),
                stars=c(0.1,0.05,0.01,0.001),
                groups = list(
                              "Services Complexity" = 2:3,
                              "Office Capacity" =4:5,
                              "Past Relationship"=6:7
                              ),
                custom.coef.map=study_coef_list,
                bold=0.05,
                custom.note="%stars. Numerical inputs are rescaled.",
                caption="Table 7: Logit Bivariate Look at Study Variables and Terminations",
                caption.above=TRUE)





```

# Multilevel Model
####25A: 2019-08-14 First run, original multilevel.
This was created while we were still using ceiling instead of base.
```{r Term25A}
#Create the model
term25A <- glmer(data=serv_smp, b_Term ~ cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                 cn_PairHist7+cln_PairCA +
                   cln_Base + cln_Days+ clr_Ceil2Base+
                   Comp+
                   Veh+
                   Pricing+
                   Crisis+
                   cln_Def6HHI+clr_Def6toUS+
                   cln_Def3HHI+clr_Def3toUS+
                   cp_PairObl7+
                   cln_OffObl7+cln_OffFocus +
                    cn_PairHist7:Pricing+ 
                   # clr_Ceil2Base:cl_Ceil+
                   (1 | NAICS3/NAICS6/ServArea)+  
                   (1 | Agency/Office) +
                   (1 | Place)+ 
                   (1 | StartFY),
                 family=binomial(link="logit"),
               verbose=TRUE)
glmer_examine(term25A,display = TRUE)
save(term25A,file="..\\output\\term25A.rdata")

#Compare the models
stargazer::stargazer(term_base2ceil_ceiling_21B, term25A, type="text", digits=2)

summary_residual_compare( term_base2ceil_ceiling_21B, term25A,bins=100)
```

####25B: 2019-08-14 Switch to base and 1m sample.

```{r Term25B}
#Create the model
term25B <- glmer(data=serv_smp1m, b_Term ~ cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                 cn_PairHist7+cln_PairCA +
                   cln_Base + cln_Days+ clr_Ceil2Base+
                   Comp+
                   Veh+
                   Pricing+
                   Crisis+
                   cln_Def6HHI+clr_Def6toUS+
                   cln_Def3HHI+clr_Def3toUS+
                   cp_PairObl7+
                   cln_OffObl7+cln_OffFocus +
                    cn_PairHist7:Pricing+ 
                   (1 | NAICS3/NAICS6/ServArea)+  
                   (1 | Agency/Office) +
                   (1 | Place)+ 
                   (1 | StartFY),
                 family=binomial(link="logit"),
               verbose=TRUE)
glmer_examine(term25B,display = TRUE)
save(term25B,file="..\\output\\term25B.rdata")

#Compare the models
stargazer::stargazer(term_base2ceil_ceiling_21B, term25B, type="text", digits=2)

summary_residual_compare( term_base2ceil_ceiling_21B, term25B,bins=100)
```