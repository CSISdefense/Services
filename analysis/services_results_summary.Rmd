---
title: "Serices Results Summary"
output:
  html_document:
    keep_md: yes
    toc: yes
date: "Wednesday, July 11, 2019"
---

#Setup
```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(arm)
library(R2WinBUGS)
library(knitr)
library(foreign)
library(stargazer)
library(texreg)
library(reshape2)
library(tidyverse)
source("https://raw.githubusercontent.com/CSISdefense/Vendor/master/Scripts/DIIGstat.r")

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40


```


Contracts are classified using a mix of numerical and categorical variables. While the changes in numerical variables are easy to grasp and summarize, a contract may have one line item that is competed and another that is not. As is detailed in the exploration on R&D, we are only considering information available prior to contract start. The percentage of contract obligations that were competed is a valuable benchmark, but is highly influenced by factors that occured after contract start..



##Prepare Data
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from   FPDS.


###Data Transformations and Summary



```{r ReadInData, echo = TRUE}
# load(file="../data/clean/defense_contract_complete.RData")
# 
# def_serv<-def %>% filter(PSR %in% c("Services"))
# def_serv<-def_serv[def_serv$MinOfSignedDate>=as.Date("2008-01-01") & def_serv$MinOfSignedDate<=as.Date("2015-12-31"),]
# rm(def)
#   
# #****This should be in dataset building, not transform.
#     def_serv<-read_and_join_experiment( def_serv,
#                                                    "Contract.sp_ContractEntityID.txt",
#                                                    path="",
#                                                    directory="..\\data\\semi_clean\\",
#                                                    by=c("CSIScontractID"),
#                                                    add_var=c("EntityID","UnmodifiedEntityID"),
#                                                    new_var_checked=FALSE,
#                                         create_lookup_rdata=TRUE)
#     def_serv$EntityID[is.na(def_serv$EntityID)]<-
#       def_serv$UnmodifiedEntityID[is.na(def_serv$EntityID)]
# 




# load("..\\data\\clean\\fed_transformed.rdata")
# fed <- fed %>% group_by() %>% dplyr::select(CSIScontractID,PlaceCountryISO3,Crisis)
# def_serv<-left_join(def_serv,fed)
# summary(def_serv$PlaceCountryISO3)
# summary(fed$PlaceCountryISO)
# summary(factor(def_serv$Crisis))
# rm(fed)
# #About 25.4k inexplicably missing
# # summary(def_serv[is.na(def_serv$Crisis),])
# 
# debug(transform_contract)
# # # head(def_serv)
# def_serv<-transform_contract(def_serv)
# # 
# # 
# discrete_percent_plot(def_serv,"CBre")
# discrete_percent_plot(def_serv,"Term")
# 
#   summary_discrete_plot(def_serv,"Level1_Category")
# 
# 
# # summary(def_serv$Unmodifieddef_servBaseAndAllOptionsValue)
# # summary(def_serv$Action.Obligation)
# 
# 
#   
# #This should be transferred into transform contract at some point
# cal_deflator<-remove_bom(read.csv("https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/economic/Lookup_Calendar_Deflator.csv"))
# 
# #Average salary
# def_serv$CensusYear<-factor(def_serv$StartCY)
# summary(def_serv$CensusYear)
# levels(def_serv$CensusYear)<-list("2007"=c("2008","2009","2010","2011","2012"),
#                                  "2012"=c("2013","2014","2015","2016","2017"))
# def_serv$CensusYear<-as.numeric(as.character(def_serv$CensusYear))
# cal_deflator<-cal_deflator %>% dplyr::select(Calendar_Year,BEA18)
# 
# def_serv<-dplyr::left_join(def_serv, cal_deflator,
#           by=c("CensusYear"="Calendar_Year"))
# 
# def_serv$US6_avg_sal_lag1Const<-def_serv$US6_avg_sal_lag1/def_serv$BEA18
# 
# 
# def_serv$l_US6_avg_sal_lag1Const<-na_non_positive_log(def_serv$US6_avg_sal_lag1Const)
#       def_serv$cl_US6_avg_sal_lag1Const<-arm::rescale(def_serv$l_US6_avg_sal_lag1Const)
# 
# def_serv <- def_serv  %>% dplyr::select(-BEA18)  
# colnames(def_serv[colnames(def_serv)=="US6_avg_sal_lag1"])<-"US6_avg_sal_lag1_then_year"
# colnames(def_serv[colnames(def_serv)=="cl_US6_avg_sal_lag1"])<-"cl_US6_avg_sal_lag1_then_year"
# #def6_obl_lag1Const
# def_serv<-dplyr::left_join(def_serv, cal_deflator,
#           by=c("StartCY"="Calendar_Year"))
# summary(def_serv$BEA18)
# 
# def_serv$def6_obl_lag1Const<-def_serv$def6_obl_lag1/def_serv$BEA18
# def_serv$l_def6_obl_lag1Const<-na_non_positive_log(def_serv$def6_obl_lag1Const)
#       def_serv$cl_def6_obl_lag1Const<-arm::rescale(def_serv$l_def6_obl_lag1Const)
# 
# colnames(def_serv[colnames(def_serv)=="def6_obl_lag1"])<-"def6_obl_lag1_then_year"
# colnames(def_serv[colnames(def_serv)=="cl_def6_obl_lag1"])<-"cl_def6_obl_lag1_then_year"
# 
# 




# def_serv<-def_serv[!colnames(def_serv) %in% colnames(def_serv)[grep("^l_",colnames(def_serv))]]
# save(file="../data/clean/transformed_def_serv.Rdata", def_serv)
load("../data/clean/transformed_def_serv.Rdata")


#********************Still not done***************************
#Def NAICS size
#Salary
#Both require calendar year deflators

# summary(def_serv$Action.Obligation)
# ?deflate
# debug(deflate)
# def_serv<-deflate(def_serv,
#                    money_var = "Action.Obligation",
#                    deflator_var="OMB.2019",
#                   fy_var="StartFY",
#                  path="C:/Users/gsand/Repositories/Lookup-Tables/"
# )
# def_serv<-deflate(def_serv,
#                    money_var = "Ceil",
#                    deflator_var="OMB.2019",
#                   fy_var="StartFY",
#                  path="C:/Users/gsand/Repositories/Lookup-Tables/"
# )
# def_serv$l_Ceil<-na_non_positive_log(def_serv$Ceil.OMB.2019)
# def_serv$cl_Ceil<-arm::rescale(def_serv$l_Ceil)


# def_serv<-def_serv[def_serv$PSR %in% c("Services"),]
# summary(factor(def_serv$OCO_GF))
# colnames(def_serv)[colnames(def_serv)=="Office"]<-"ContractingOfficeCode"
# 
# colnames(def_serv)[colnames(def_serv)=="StartFY"]<-"fiscal_year"
# def_serv<-read_and_join_experiment( def_serv,
#                                     "Office.sp_OfficeHistoryCapacityLaggedConst.txt",
#                                     path="",
#                                     directory="..\\data\\semi_clean\\",
#                                     by=c("ContractingOfficeCode","fiscal_year"),
#                                     add_var=c("office_obligatedamount_1year",
#                                               "office_numberofactions_1year",
#                                               "office_PBSCobligated_1year",
#                                               "office_obligatedamount_7year"),
#                                     new_var_checked=FALSE)
# def_serv<-read_and_join_experiment( def_serv,
#                                           "Office.sp_ProdServOfficeHistoryLaggedConst.txt",
#                                           path="",
#                                           directory="..\\data\\semi_clean\\",
#                                           by=c("ContractingOfficeCode","fiscal_year","ProductOrServiceCode"),
#                                           add_var=c("office_psc_obligatedamount_7year"),
#                                           new_var_checked=FALSE,
#                                     col_types="ccddddc")
# def_serv<-read_and_join_experiment( def_serv,
#                                           "Office.sp_EntityIDofficeHistoryLaggedConst.txt",
#                                           path="",
#                                           directory="..\\data\\semi_clean\\",
#                                           by=c("EntityID","ContractingOfficeCode","fiscal_year"),
#                                           add_var=c("office_entity_paircount_7year","office_entity_numberofactions_1year",
#                                                     "office_entity_obligatedamount_7year"),
#                                           new_var_checked=FALSE)
# def_serv<-read_and_join( def_serv,
#                            "ProductOrServiceCode.ProdServHistoryCFTEcoalesceLaggedConst.txt",
#                            path="",
#                            directory="..\\data\\semi_clean\\",
#                            by=c("fiscal_year","OCO_GF","ProductOrServiceCode"),
#                            add_var=c("CFTE_Rate_1year"),
#                            new_var_checked=FALSE)
#   colnames(def_serv)[colnames(def_serv)=="fiscal_year"]<-"StartFY"
# colnames(def_serv)[colnames(def_serv)=="ContractingOfficeCode"]<-"Office"





# deflate <- function(
#   data,
#   money_var = "Amount",
#   fy_var = "Fiscal_Year",
#   deflator_file = "Lookup_Deflators.csv",
#   deflator_var="OMB20_GDP18",
#   path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
#   directory="economic/",
#   deflator_dropped=TRUE
# )



length(unique((def_serv$ContractingOfficeCode)))
length(unique((def_serv$Agency)))
length(unique((def_serv$NAICS)))
length(unique((def_serv$NAICS3)))


#Removing l_s just to reduce size. They can be derived easily.

# 


# load("output//naics_join.Rdata")

```


### Platform Portfolio
```{r Platform, fig.width=6.5 , fig.height=3.25}

library(readr)
annual_platform_summary<-read_csv(file="output//annual_platform_summary.csv")
colnames(annual_platform_summary)[colnames(annual_platform_summary)=="platformPortfolio"]<-"PlatformPortfolio"

platform_no_na<-subset(annual_platform_summary,!is.na(PlatformPortfolio))
labels_and_colors<-csis360::prepare_labels_and_colors(platform_no_na,"PlatformPortfolio")



platform_no_na$plat_short <-swr(platform_no_na$PlatformPortfolio,nwrap = 21)
platform_no_na<-subset(platform_no_na,Fiscal.Year>=2000 & Fiscal.Year<=2017)

 

# plat<-ggplot(platform_no_na,
#        aes(x=Fiscal.Year,y=hh_index))+#color=NAICS_Code
#   geom_line()+
#   scale_y_continuous(label=scales::comma)+ 
#   # scale_x_continuous(breaks=c(2006,2009,2011,2014))+
#   labs(x="Fiscal Year",y="Herfindahl-Herschman Index")+ 
#   geom_hline(yintercept=c(1500,2500),linetype="dotted")+
#   facet_wrap(~plat_short)
# add_preassigned_scales(plat,labels_and_colors = labels_and_colors)

# str(platform_no_na)
# summary(platform_no_na$Fiscal.Year)
#
# undebug(add_preassigned_scales)
plat<-build_plot(
  data=platform_no_na,
  chart_geom = "Line Chart",
  share = FALSE,
  x_var="Fiscal.Year",
  y_var="hh_index", #Name of variable to plot on y-axis
  color_var="PlatformPortfolio",       # name of coloration variable, as string
  facet_var="PlatformPortfolio",        # name of facet variable, as string
  legend=FALSE, #Include a legend
  caption=FALSE, #Include a source caption
  labels_and_colors=labels_and_colors,
  column_key=NULL
)


# add_preassigned_scales(plat, labels_and_colors,  var="PlatformPortfolio"

plat<-plat+geom_hline(yintercept=c(1500,2500),linetype="dotted")+
  labs(x="Fiscal Year",y="Herfindahl-Herschman Indetx")
plat
ggsave(plat+geom_line(aes(x=Fiscal.Year,y=hh_index,color=PlatformPortfolio),size=1),filename="Output//platform_hhi.png",height=3.25, width=6.5)
ggsave(plat+geom_line(aes(x=Fiscal.Year,y=hh_index)),filename="Output//platform_hhi_bw.png",height=3.25, width=6.5)
ggsave(plat+geom_line(aes(x=Fiscal.Year,y=hh_index,color=PlatformPortfolio),size=1),filename="Output//platform_hhi.eps",height=3.25, width=6.5)
ggsave(plat+geom_line(aes(x=Fiscal.Year,y=hh_index)),filename="Output//platform_hhi_bw.eps",height=3.25, width=6.5)

```


### Variable examination
```{r VarGraph}
summary(def_serv$UnmodifiedBaseandExercisedOptionsValue)
def_serv$UnmodifiedBaseandExercisedOptionsValue[def_serv$UnmodifiedBaseandExercisedOptionsValue<=0]<-NA



def_serv$l_base<-log(def_serv$UnmodifiedBaseandExercisedOptionsValue+1)
def_serv$p_OptGrowth<-def_serv$ExercisedOptions/def_serv$UnmodifiedBaseandExercisedOptionsValue+1
def_serv$lp_OptGrowth<-log(def_serv$p_OptGrowth)
def_serv$n_OptGrowth<-def_serv$ExercisedOptions+1
def_serv$ln_OptGrowth<-log(def_serv$n_OptGrowth)


def_serv$Opt<-NA
def_serv$Opt[def_serv$AnyUnmodifiedUnexercisedOptions==1& def_serv$ExercisedOptions>0]<-"Option Growth"
def_serv$Opt[(def_serv$AnyUnmodifiedUnexercisedOptions==1)& def_serv$ExercisedOptions==0]<-"No Growth"
def_serv$Opt[def_serv$AnyUnmodifiedUnexercisedOptions==0]<-"Initial Base=Ceiling"
def_serv$Opt<-factor(def_serv$Opt)


def_serv$l_pPBSC<-log(def_serv$pPBSC+1)
def_serv$l_pOffPSC<-log(def_serv$pOffPSC+1)
def_serv$l_pMarket<-log(def_serv$pMarket+1)
def_serv$l_CA<-log(def_serv$office_entity_numberofactions_1year+1)
def_serv$l_CFTE<-log(def_serv$CFTE_Rate_1year)

summary(def_serv$l_CFTE)


freq_continuous_plot(def_serv,"CFTE_Rate_1year",bins=50)
freq_continuous_plot(def_serv,"l_CFTE",bins=50)
freq_continuous_plot(def_serv,"UnmodifiedBaseandExercisedOptionsValue",bins=50)
freq_continuous_plot(def_serv,"l_base",bins=50)
freq_continuous_plot(def_serv %>%filter(AnyUnmodifiedUnexercisedOptions==1),"p_OptGrowth",bins=50)
freq_continuous_plot(def_serv %>%filter(AnyUnmodifiedUnexercisedOptions==1),"lp_OptGrowth",bins=50)



freq_continuous_plot(def_serv,"pPBSC",bins=50)
freq_continuous_plot(def_serv,"l_pPBSC",bins=50) #No real point, stick with PBSC
freq_continuous_plot(def_serv,"pOffPSC",bins=50)
freq_continuous_plot(def_serv,"l_pOffPSC",bins=50)  #No real point here either
freq_continuous_plot(def_serv,"pMarket",bins=50)
freq_continuous_plot(def_serv,"l_pMarket",bins=50)
freq_continuous_plot(def_serv,"office_entity_paircount_7year",bins=50)
freq_continuous_plot(def_serv,"office_entity_numberofactions_1year",bins=50)
freq_continuous_plot(def_serv,"l_CA",bins=50)
summary(def_serv$pMarket)

def_serv$l_pMarket<-log(def_serv$pMarket+1)


# Effplot<-freq_discrete_plot(subset(def_serv,"EffComp"))
# Effplot<-Effplot+labs(x="Effective Competition",y="Contract or Task Order Count")
# ggsave(Effplot,file="Output//EffFreq.png",width=5.5,height=5.5,dpi=600)
save(file="../data/clean/transformed_def_serv.Rdata", def_serv)
```

### Computational Sample Creation
```{r Sample}

 # load(file="data//def_sample.Rdata")

summary(def_serv$b_Term)
summary(def_serv$b_CBre)
summary(def_serv$lp_OptGrowth) #Missing
summary(def_serv$ExercisedOptions)
summary(def_serv$AnyUnmodifiedUnexercisedOptions)
#Study Variables
summary(def_serv$cl_US6_avg_sal_lag1Const)
summary(def_serv$cl_CFTE)
summary(def_serv$c_pPBSC)
summary(def_serv$c_pOffPSC)
summary(def_serv$c_pairHist)
summary(def_serv$cl_pairCA)
#Controls
summary(def_serv$CompOffr)
summary(def_serv$cl_Offr)
summary(def_serv$cl_Ceil)
summary(def_serv$capped_cl_Days)
summary(def_serv$Veh) 
summary(def_serv$PricingUCA)
summary(def_serv$PlaceCountryISO3)
summary(def_serv$NAICS)
summary(def_serv$NAICS3)
summary(def_serv$Office)
summary(def_serv$Agency)
summary(def_serv$StartCY)
summary(def_serv$cl_def3_HHI_lag1)#Missing!
summary(def_serv$cl_def3_ratio_lag1)#Missing!
summary(def_serv$cl_def6_HHI_lag1)#Missing!
summary(def_serv$cl_def6_obl_lag1)#Missing!
summary(def_serv$cl_def6_ratio_lag1)#Missing!
summary(def_serv$cl_US6_avg_sal_lag1)#Missing!
#New Controls
summary(def_serv$cl_OffCA)
summary(def_serv$cl_OffCA)
summary(def_serv$c_pMarket)
summary(def_serv$Crisis)


complete<-
  #Dependent Variables
  !is.na(def_serv$b_Term)& #summary(def_serv$b_Term)
  !is.na(def_serv$b_CBre)&
  !is.na(def_serv$lp_OptGrowth)&
  !is.na(def_serv$ExercisedOptions)&
  !is.na(def_serv$AnyUnmodifiedUnexercisedOptions)&
  #Study Variables
  !is.na(def_serv$cl_US6_avg_sal_lag1Const)&
  !is.na(def_serv$cl_CFTE)&
  !is.na(def_serv$c_pPBSC)&
  !is.na(def_serv$c_pOffPSC)&
  !is.na(def_serv$c_pairHist)&
  !is.na(def_serv$cl_pairCA)&
  #Controls
  !is.na(def_serv$CompOffr)&
  !is.na(def_serv$cl_Offr)&
  !is.na(def_serv$cl_Ceil)&
  !is.na(def_serv$capped_cl_Days)&
  !is.na(def_serv$Veh) &
  !is.na(def_serv$PricingUCA)&
  !is.na(def_serv$PlaceCountryISO3)& #New Variable
  # !is.na(def_serv$b_UCA)& No longer  used
  !is.na(def_serv$NAICS)&
  !is.na(def_serv$NAICS3)&
  !is.na(def_serv$Office)&
  !is.na(def_serv$Agency)&
  !is.na(def_serv$StartCY)&
  !is.na(def_serv$cl_def3_HHI_lag1)&
  !is.na(def_serv$cl_def3_ratio_lag1)&
  !is.na(def_serv$cl_def6_HHI_lag1)&
  !is.na(def_serv$cl_def6_obl_lag1Const)&
  !is.na(def_serv$cl_def6_ratio_lag1)&
  #New Controls
  !is.na(def_serv$cl_OffCA)& #summary(def_serv$cl_OffCA)
  !is.na(def_serv$cl_OffVol)& #summary(def_serv$cl_OffVol)
  !is.na(def_serv$c_pMarket)&  #summary(def_serv$c_pMarket)
  !is.na(def_serv$Crisis)  #summary(def_serv$c_pMarket)




summary(complete)
summary(def_serv$Action_Obligation.OMB20_GDP18)
money<-def_serv$Action_Obligation.OMB20_GDP18
any(def_serv$Action_Obligation.OMB20_GDP18<0)
money[def_serv$Action_Obligation.OMB20_GDP18<0]<-0
sum(def_serv$Action_Obligation.OMB20_GDP18[def_serv$Action_Obligation.OMB20_GDP18<0])

#Overall
length(money[!complete])/length(money)
sum(money[!complete],na.rm=TRUE)/sum(money,na.rm=TRUE)

#What portion of contracts have potential options, 
sum(money[def_serv$AnyUnmodifiedUnexercisedOptions==1],na.rm=TRUE)/
  sum(money,na.rm=TRUE)


#Missing data, how many records
nrow(def_serv[!complete,])/nrow(def_serv)
sum(def_serv[!complete,]$Action.Obligation.OMB20_GDP18,na.rm=TRUE)/sum(def_serv$Action.Obligation.OMB20_GDP18,na.rm=TRUE)

#Missing data how much money?
length(money[!complete&def_serv$AnyUnmodifiedUnexercisedOptions==1])/
  length(money[def_serv$AnyUnmodifiedUnexercisedOptions==1])
sum(money[!complete&def_serv$AnyUnmodifiedUnexercisedOptions==1],na.rm=TRUE)/
  sum(money[def_serv$AnyUnmodifiedUnexercisedOptions==1],na.rm=TRUE)



#Refreshing
load(file="../data/clean/def_sample.Rdata")

# serv_complete<-def_serv[complete,]
# serv_smp1m<-serv_complete[sample(nrow(serv_complete),1000000),]
# serv_smp<-serv_complete[sample(nrow(serv_complete),250000),]
# rm(serv_complete)
# serv_opt<-def_serv[complete&def_serv$AnyUnmodifiedUnexercisedOptions==1,]


# serv_smp<-update_sample_col_CSIScontractID(serv_smp,
#                                            def_serv[complete,],
#                                            col=NULL,
#                                            drop_and_replace=TRUE)
# 
# serv_smp1m<-update_sample_col_CSIScontractID(serv_smp1m,
#                                            def_serv[complete,],
#                                            col=NULL,
#                                            drop_and_replace=TRUE)
# 



# 
# serv_smp<-def_serv[complete,]
# # 
save(file="../data/clean/def_sample.Rdata",serv_smp,serv_smp1m,serv_opt)
# write.foreign(df=serv_smp,
#               datafile="Data//def_sample250k.dat",
#               codefile="Data//def_sample250k_code.do",
#               package = "Stata")
# write.foreign(df=serv_smp1m,
#               datafile="Data//def_sample1m.dat",
#               codefile="Data//def_sample1m_code.do",
#               package = "Stata")

# levels(serv_smp$Intl)<- list("Just U.S."=c("Just U.S."), 
#                                 "Any Intl."=c("Any International"))
# levels(serv_smp1m$Intl)<- list("Just U.S."=c("Just U.S."), 
#                                 "Any Intl."=c("Any International"))


```
# Loading Models
## Output: Offers

### Consolidation and Number of Offers

```{r Comp-Cons}
load("Output//Comp_Cons_15D.rdata")





if(!exists("Comp_Cons_15D"))
   
     Comp_Cons_15D <- lmer (data=serv_smp,
                         l_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                         # cl_US3_avg_sal_lag1+
                         cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                         cl_US6_avg_sal_lag1 + 
                         cl_Ceil+capped_cl_Days+
                         Veh+
                         PricingFee+UCA+
                         b_Intl+
                         b_UCA:cl_def6_HHI_lag1 +
                         # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                         # cl_def6_HHI_lag1:cl_def6_obl_lag1+
                         b_Intl:Veh+
                         # cl_Ceil:PricingFee+
                         # cl_US6_avg_sal_lag1:PricingFee+
                         # b_UCA:capped_cl_Days+
                         # b_UCA:cl_Ceil+
                         (1 | NAICS3/NAICS) + (1 | Agency/Office) + (1 | StartCY),
                         verbose=1)
  
  
  # save(Comp_Cons_15D,file="Output//Comp_Cons_15D.rdata")
  
   Comp_Cons_15D_1m <- lmer (data=serv_smp1m,
                         l_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                         # cl_US3_avg_sal_lag1+
                         cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                         cl_US6_avg_sal_lag1 + 
                         cl_Ceil+capped_cl_Days+
                         Veh+
                         PricingFee+UCA+
                         b_Intl+
                         b_UCA:cl_def6_HHI_lag1 +
                         # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                         # cl_def6_HHI_lag1:cl_def6_obl_lag1+
                         b_Intl:Veh+
                         # cl_Ceil:PricingFee+
                         # cl_US6_avg_sal_lag1:PricingFee+
                         # b_UCA:capped_cl_Days+
                         # b_UCA:cl_Ceil+
                         (1 | NAICS3/NAICS) + (1 | Agency/Office) + (1 | StartCY),
                         verbose=1)
   save(Comp_Cons_15D,Comp_Cons_15D_1m,file="Output//Comp_Cons_15D.rdata")



stargazer::stargazer(Comp_Cons_15D,Comp_Cons_15D_1m,type="text",
                       digits=2)

#Considering 
write.csv(exp(summary(Comp_Cons_15D_1m)$coefficients[,1])-1,file="OUtput/exp_Comp_Cons_15D_1m.csv")
Comp_Cons_15D_exp<-log_analysis(Comp_Cons_15D)

glmer_examine(Comp_Cons_15D,display=TRUE)
get_icc(Comp_Cons_15D,summary=TRUE)
```
No failure to converge.

## Output: Ceiling Breach
### Consolidation and Ceiling Breaches

```{r CBre-Cons}

# load("Output//CBre_Cons_13B.rdata") Missing
load("Output//CBre_Cons_13B_1m.rdata")
CBre_Cons_13B_1m.rdata

if(!exists("CBre_Cons_13B_1m")){
  CBre_Cons_13B_1m <- glmer (data=serv_smp1m,
                          b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                            #cl_US3_avg_sal_lag1+
                            cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                            cl_US6_avg_sal_lag1+
                            cl_Ceil + capped_cl_Days+ 
                            Veh +
                            PricingFee + b_UCA +
                            b_Intl+
                            
                            b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:cl_Ceil+
                            cl_def6_HHI_lag1:cl_def6_obl_lag1+
                            
                            (1 | NAICS3/NAICS) + 
                            (1 | Agency/Office), 
                          
                          family=binomial(link="logit"),
                          verbose=1)
  save(CBre_Cons_13B_1m,#CBre_Cons_13B,CBre_Cons_13B.restart,
       file="Output//CBre_Cons_13B_1m.rdata")
}

if(!exists("CBre_Cons_13B_1m_restart")){
  pars<-get_pars(CBre_Cons_13B_1m)
  CBre_Cons_13B_1m_restart <- update(CBre_Cons_13B_1m, 
                                     start=pars,
                                     verbose=1)
  save(CBre_Cons_13B,
       CBre_Cons_13B.restart,
       CBre_Cons_13B_1m,
       CBre_Cons_13B_1m_restart,
       file="Output//CBre_Cons_13B.rdata")
}
glmer_examine(CBre_Cons_13B_1m_restart)




save(CBre_Cons_13B,
     CBre_Cons_13B.devfun,
     CBre_Cons_13_scgrad,
     CBre_Cons_13B.restart,
     CBre_Comp_13B,
     CBre_Comp_13B.devfun,
     CBre_Comp_13B.restart,
     file="Output//CBre_Cons_13B.rdata")

source(system.file("utils", "allFit.R", package="lme4"))
CBre_Cons_13B.all <- allFit(CBre_Cons_13B)
CBre_Cons_13B_ss_cons <- summary(CBre_Cons_13B.all)





vif(CBre_Cons_13B_1m)
stargazer::stargazer(CBre_Cons_13B,CBre_Cons_13B_1m,type="text",
                       digits=2)

glmer_examine(CBre_Cons_13B.restart,display=TRUE)
odds_ratio(CBre_Cons_13B.restart,"CBre_Cons_13B")

```
"Model failed to converge with max|grad| = 0.00750942 (tol = 0.001, component 1)"


### Competition and Ceiling Breach
```{r CBre-Comp}
load(file="Output//CBre_Comp_13C.rdata")

glmer_examine(CBre_Comp_13C)


## Not Done
if(!exists("CBre_Comp_13C")){
  CBre_Comp_13C <- glmer (data=serv_smp,
                          b_CBre ~CompOffr+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                            cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                            cl_Ceil + capped_cl_Days+
                            Veh  +
                            PricingFee+
                            b_UCA +
                            b_Intl+
                            
                            b_UCA:CompOffr +
                            b_UCA:cl_Ceil+
                            
                            (1 | NAICS3/NAICS) + (1 | Agency/Office),
                          family=binomial(link="logit"),
                          verbose=1)
  
   CBre_Comp_13C_1m <- glmer (data=serv_smp1m,
                          b_CBre ~CompOffr+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                            cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                            cl_Ceil + capped_cl_Days+
                            Veh  +
                            PricingFee+
                            b_UCA +
                            b_Intl+
                            
                            b_UCA:CompOffr +
                            b_UCA:cl_Ceil+
                            
                            (1 | NAICS3/NAICS) + (1 | Agency/Office),
                          family=binomial(link="logit"),
                          verbose=1)
  
  save(CBre_Comp_13C,CBre_Comp_13C_1m,file="Output//CBre_Comp_13C.rdata")
  stargazer::stargazer(CBre_Comp_13C,CBre_Comp_13C_1m,type="text",
                       digits=2)
}

glmer_examine(CBre_Comp_13C,display=TRUE)
glmer_examine(CBre_Comp_13C_1m,display=TRUE)
odds_ratio(CBre_Comp_13C,"CBre_Comp_13C")

```
"Model failed to converge with max|grad| = 0.0209168 (tol = 0.001, component 1)"
No restart yet.
### Both and Ceiling Breach
```{r CBre-Both}
load("Output//CBre_Cons_Comp_15A.rdata")

stargazer::stargazer(CBre_Cons_Comp_15A,type="text",
                       digits=2)
if(!exists("CBre_Cons_Comp_15A")){
  CBre_Cons_Comp_15A <- glmer (data=serv_smp,
                               b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                                 #cl_US3_avg_sal_lag1+
                                 cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                                 cl_US6_avg_sal_lag1+
                                 CompOffr+
                                   cl_Ceil + capped_cl_Days+ 
                                 Veh +
                                 PricingFee + b_UCA +
                                 b_Intl+
                                 
                                 
                                 
                                 b_UCA:CompOffr +
                                 b_UCA:cl_def6_HHI_lag1 + 
                                 b_UCA:cl_Ceil+
                                 cl_def6_HHI_lag1:cl_def6_obl_lag1+
                                 
                                 (1 | NAICS3/NAICS) + 
                                 (1 | Agency/Office) ,
                               family=binomial(link="logit"),
                               verbose=1)
  
  CBre_Cons_Comp_15A_1m <- glmer (data=serv_smp1m,
                               b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                                 #cl_US3_avg_sal_lag1+
                                 cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                                 cl_US6_avg_sal_lag1+
                                 CompOffr+
                                 cl_Ceil + capped_cl_Days+ 
                                 Veh +
                                 PricingFee + b_UCA +
                                 b_Intl+
                                 
                                 
                                 
                                 b_UCA:CompOffr +
                                 b_UCA:cl_def6_HHI_lag1 + 
                                 b_UCA:cl_Ceil+
                                 cl_def6_HHI_lag1:cl_def6_obl_lag1+
                                 
                                 (1 | NAICS3/NAICS) + 
                                 (1 | Agency/Office) ,
                               family=binomial(link="logit"),
                               verbose=1)
  
  save(CBre_Cons_Comp_15A,CBre_Cons_Comp_15A_1m,file="Output//CBre_Cons_Comp_15A.rdata")
}


source(system.file("utils", "allFit.R", package="lme4"))
CBre_Cons_Comp_15A_1m.all <- allFit(CBre_Cons_Comp_15A_1m)
CBre_Cons_Comp_15A_1m_ss_cons <- summary(CBre_Cons_Comp_15A_1m.all)


glmer_examine(CBre_Cons_Comp_15A,display=TRUE)
CBre_Cons_Comp_15A_odds_ratio<-odds_ratio(CBre_Cons_Comp_15A,"CBre_Cons_Comp_15A")
get_icc(CBre_Cons_Comp_15A)
```
[1] "Model failed to converge with max|grad| = 0.0395392 (tol = 0.001, component 1)"

failure to converge in 10000 evaluationsModel failed to converge with max|grad| = 0.00901903 (tol = 0.001, component 1)

## Output: Termination

### Consolidation and Termination

```{r Term-Cons}
load("Output//Term_Cons_13E.rdata")


if(!exists("Term_Cons_13F")){
  
  Term_Cons_13F <- glmer (data=serv_smp,
                          b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                            #cl_US3_avg_sal_lag1+
                            cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                            cl_US6_avg_sal_lag1+
                            cl_Ceil + capped_cl_Days+ 
                            Veh +
                            PricingFee + b_UCA +
                            b_Intl+
                            
                            # b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:cl_Ceil+
                            cl_def6_HHI_lag1:cl_def6_obl_lag1+
                            
                               cl_def3_HHI_lag1:cl_def3_ratio_lag1+  
                            (1 | NAICS3/NAICS) + 
                            (1 | Agency/Office), 
                          family=binomial(link="logit"),
                          verbose=1)
  
  
  # save(Term_Cons_13E,file="Output//Term_Cons_13E.rdata")
  
   
    Term_Cons_13F_1m <- glmer (data=serv_smp1m,
                          b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                            #cl_US3_avg_sal_lag1+
                            cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                            cl_US6_avg_sal_lag1+
                            cl_Ceil + capped_cl_Days+ 
                            Veh +
                            PricingFee + b_UCA +
                            b_Intl+
                            
                            # b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:cl_Ceil+
                            cl_def6_HHI_lag1:cl_def6_obl_lag1+
                            
                               cl_def3_HHI_lag1:cl_def3_ratio_lag1+  
                            (1 | NAICS3/NAICS) + 
                            (1 | Agency/Office), 
                          family=binomial(link="logit"),
                          verbose=1)
    
    save(Term_Cons_13E,Term_Cons_13E_1m,file="Output//Term_Cons_13E.rdata")
  
}


glmer_examine(Term_Cons_13E,display=TRUE)
odds_ratio(Term_Cons_13E,"Term_Cons_13E")

```

"Model failed to converge with max|grad| = 0.0498057 (tol = 0.001, component 1)"

### Competition and Terminations

```{r Term-Comp}
load(file="Output//Term_Comp_13F.rdata")

if(!exists("Term_Comp_13F")){
  Term_Comp_13F <- glmer (data=serv_smp,
                          b_Term ~CompOffr+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                            cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                            cl_Ceil + capped_cl_Days+
                            Veh  +
                            PricingFee+
                            b_UCA +
                            b_Intl+
                            
                            # b_UCA:CompOffr +
                            b_UCA:cl_Ceil+
                            
                            (1 | NAICS3/NAICS) + (1 | Agency/Office),
                          family=binomial(link="logit"),
                          verbose=1)
  
  
summary(Term_Comp_13E_1m)
  
  
    Term_Comp_13F_1m <- glmer (data=serv_smp1m,
                          b_Term ~CompOffr+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                            cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                            cl_Ceil + capped_cl_Days+
                            Veh  +
                            PricingFee+
                            b_UCA +
                            b_Intl+
                            
                            # b_UCA:CompOffr +
                            b_UCA:cl_Ceil+
                            
                            (1 | NAICS3/NAICS) + (1 | Agency/Office),
                          family=binomial(link="logit"),
                          verbose=1)
  
  Term_Comp_13F<-Term_Comp_13E2
  save(Term_Comp_13F,Term_Comp_13F_1m,file="Output//Term_Comp_13F.rdata")
}
stargazer::stargazer(Term_Comp_13E,Term_Comp_13F,type="text",
                       digits=2)
glmer_examine(Term_Comp_13E2,display=TRUE)
odds_ratio(Term_Comp_13E2,"Term_Comp_13E2")
```

[1] "Model failed to converge with max|grad| = 0.046442 (tol = 0.001, component 1)"


### Both and Terminations

```{r Both-Term}
load(file="Output//Term_Cons_Comp_14C_1m.rdata") 


if(!exists("Term_Cons_Comp_14A")){
Term_Cons_Comp_14C <- glmer (data=serv_smp,
                             b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                               #cl_US3_avg_sal_lag1+
                               cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                               cl_US6_avg_sal_lag1+
                               CompOffr+
                               cl_Ceil + capped_cl_Days+ 
                               Veh +
                               PricingFee + b_UCA +
                               b_Intl+
                               
                               # cl_def6_HHI_lag1:capped_cl_Days+
                               b_UCA:cl_Ceil+
                               # b_UCA:cl_def6_HHI_lag1 +
                               # PricingFee:cl_US6_avg_sal_lag1+
                               cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                               # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                               cl_def3_HHI_lag1:cl_def3_ratio_lag1+  
                               
                               (1 | NAICS3/NAICS) + (1 | Agency/Office)
                             , family=binomial(link="logit"),verbose=1)


Term_Cons_Comp_14C_1m <- glmer (data=serv_smp1m,
                             b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                               #cl_US3_avg_sal_lag1+
                               cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                               cl_US6_avg_sal_lag1+
                               CompOffr+
                               cl_Ceil + capped_cl_Days+ 
                               Veh +
                               PricingFee + b_UCA +
                               b_Intl+
                               
                               # cl_def6_HHI_lag1:capped_cl_Days+
                               # b_UCA:cl_Ceil+
                               # b_UCA:cl_def6_HHI_lag1 +
                               # PricingFee:cl_US6_avg_sal_lag1+
                               cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                               # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                               cl_def3_HHI_lag1:cl_def3_ratio_lag1+  
                               
                               (1 | NAICS3/NAICS) + (1 | Agency/Office)
                             , family=binomial(link="logit"),verbose=1)



  save(Term_Cons_Comp_14B_1m,file="Output//Term_Cons_Comp_14B2_1m.rdata")
  source(system.file("utils", "allFit.R", package="lme4"))
Term_Cons_Comp_14B_1m.all <- allFit(Term_Cons_Comp_14B_1m)
Term_Cons_Comp_14B_1m_ss_cons <- summary(Term_Cons_Comp_14B_1m.all)

Term_Cons_Comp_14C_1m <- glmer (data=serv_smp1m,
                             b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                               #cl_US3_avg_sal_lag1+
                               cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                               cl_US6_avg_sal_lag1+
                               CompOffr+
                               cl_Ceil + capped_cl_Days+ 
                               Veh +
                               PricingFee + b_UCA +
                               b_Intl+
                               
                               # cl_def6_HHI_lag1:capped_cl_Days+
                               b_UCA:cl_Ceil+
                               # b_UCA:cl_def6_HHI_lag1 +
                               # PricingFee:cl_US6_avg_sal_lag1+
                               cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                               # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                               cl_def3_HHI_lag1:cl_def3_ratio_lag1+  
                               
                               (1 | NAICS3/NAICS) + (1 | Agency/Office)
                             , family=binomial(link="logit"),verbose=1)

  
  
stargazer::stargazer(Term_Cons_Comp_14B_1m,type="text",
                       digits=2)

# Term_Cons_Comp_14B_1m <- update(Term_Cons_Comp_14B_1m, . ~ . + b_UCA:cl_Ceil - cl_def6_HHI_lag1:capped_cl_Days)

  # save(Term_Cons_Comp_14B_1m,Term_Cons_Comp_14B2_1m,file="Output//Term_Cons_Comp_14B_1m.rdata")


  save(Term_Cons_Comp_14C_1m,file="Output//Term_Cons_Comp_14C.rdata")
  
}
glmer_examine(Term_Cons_Comp_14C)
odds_ratio(Term_Cons_Comp_14C,"Term_Cons_Comp_14C")
get_icc(Term_Cons_Comp_14C)

```
[1] "Model failed to converge with max|grad| = 0.0782055 (tol = 0.001, component 1)"

# Tables for Paper
## Competition Model
```{r Output-CBre}

# texreg::htmlreg(list(Term_Cons_08A3,
#                   CBre_Cons_08C),#CBre_Cons_08B2
#                 file="Output//ConsModel.html",single.row = TRUE,
#                 custom.model.name=c("Termination",
#                                     "Ceiling Breach"),
#                         stars=c(0.05))




texreg::htmlreg(list(Comp_Cons_15D),file="Output//Offr_Model.html",
                single.row = TRUE,
                custom.model.name=c("Concentration"),
                        stars=c(0.1,0.05,0.01,0.001),
                groups = list("Study Variables" = 2:3,
                              "NAICS Characteristics" =4:7,
                              "Contract Characteristics"=8:19,
"Interactions" = 20:24),
                custom.coef.map=list("(Intercept)"="(Intercept)",
                "cl_def3_HHI_lag1"="Log(Subsector HHI)",
"cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
"CompOffr1 offer"="Comp=1 offer",
"CompOffr2 offers"="Comp=2 offers",
"CompOffr3-4 offers"="Comp=3-4 offers",
"CompOffr5+ offers"="Comp=5+ offers",
"cl_def3_ratio_lag1"="Log(Subsector Ratio)",
"cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
"cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
"cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
"cl_Ceil"="Log(Init. Ceiling)",
"capped_cl_Days"="Log(Init. Days)",
"VehS-IDC"="Vehicle=S-IDC",
"VehM-IDC"="Vehicle=M-IDC",
"VehFSS/GWAC"="Vehicle=FSS/GWAC",
"VehBPA/BOA"="Vehicle=BPA/BOA",
"PricingFeeOther FP"="Pricing=Other FP",
"PricingFeeIncentive"="Pricing=Incentive Fee",
"PricingFeeCombination or Other"="Pricing=Combination or Other",
"PricingFeeOther CB"="Pricing=Other CB",
"PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
"b_UCA"="UCA",
"b_Intl"="Performed Abroad",
# # "cl_def6_HHI_lag1:capped_cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
# "cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
# # "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)"),
"cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
# "cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
# "CompOffr1 offer:b_UCA"="Comp=1 offer:UCA",
# "CompOffr2 offers:b_UCA"="Comp=2 offers:UCA",
# "CompOffr3-4 offers:b_UCA"="Comp=3-4 offers:UCA",
# "CompOffr5+ offers:b_UCA"="Comp=5+ offers:UCA"
"VehS-IDC:b_Intl"="Vehicle=S-IDC:Performed Abroad",
"VehM-IDC:b_Intl"="Vehicle=M-IDC:Performed Abroad",
"VehFSS/GWAC:b_Intl"="Vehicle=FSS/GWAC:Performed Abroad",
"VehBPA/BOA:b_Intl"="Vehicle=BPA/BOA:Performed Abroad",
"cl_US6_avg_sal_lag1:PricingFeeOther FP"="Pricing=Other FP:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeIncentive"="Pricing=Incentive Fee:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeCombination or Other"="Pricing=Comb./or Other:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeOther CB"="Pricing=Other CB:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE:Log(Det. Ind. U.S. Avg. Salary)"

),
                bold=0.05,
custom.note="%stars. Logged inputs are rescaled. For this model, sole source contracts and task orders are treated as having 1 offer.",
caption="Table 1: Regression Model of Log(Number of Offfers)",
caption.above=TRUE)


texreg::htmlreg(list(Comp_Cons_15D_1m),file="Output//Offr_Model_1m.html",
                single.row = TRUE,
                custom.model.name=c("Concentration"),
                        stars=c(0.1,0.05,0.01,0.001),
                groups = list("Study Variables" = 2:3,
                              "NAICS Characteristics" =4:7,
                              "Contract Characteristics"=8:20,
"Interactions" = 21:25),
                custom.coef.map=list("(Intercept)"="(Intercept)",
                "cl_def3_HHI_lag1"="Log(Subsector HHI)",
"cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
"CompOffr1 offer"="Comp=1 offer",
"CompOffr2 offers"="Comp=2 offers",
"CompOffr3-4 offers"="Comp=3-4 offers",
"CompOffr5+ offers"="Comp=5+ offers",
"cl_def3_ratio_lag1"="Log(Subsector Ratio)",
"cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
"cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
"cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
"cl_Ceil"="Log(Init. Ceiling)",
"capped_cl_Days"="Log(Init. Days)",
"VehS-IDC"="Vehicle=S-IDC",
"VehM-IDC"="Vehicle=M-IDC",
"VehFSS/GWAC"="Vehicle=FSS/GWAC",
"VehBPA/BOA"="Vehicle=BPA/BOA",
"PricingFeeOther FP"="Pricing=Other FP",
"PricingFeeIncentive"="Pricing=Incentive Fee",
"PricingFeeCombination or Other"="Pricing=Combination or Other",
"PricingFeeOther CB"="Pricing=Other CB",
"PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
"b_UCA"="UCA",
"UCAUCA"="UCA",
"b_Intl"="Performed Abroad",
# # "cl_def6_HHI_lag1:capped_cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
# "cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
# # "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)"),
"cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
# "cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
# "CompOffr1 offer:b_UCA"="Comp=1 offer:UCA",
# "CompOffr2 offers:b_UCA"="Comp=2 offers:UCA",
# "CompOffr3-4 offers:b_UCA"="Comp=3-4 offers:UCA",
# "CompOffr5+ offers:b_UCA"="Comp=5+ offers:UCA"
"VehS-IDC:b_Intl"="Vehicle=S-IDC:Performed Abroad",
"VehM-IDC:b_Intl"="Vehicle=M-IDC:Performed Abroad",
"VehFSS/GWAC:b_Intl"="Vehicle=FSS/GWAC:Performed Abroad",
"VehBPA/BOA:b_Intl"="Vehicle=BPA/BOA:Performed Abroad",
"cl_US6_avg_sal_lag1:PricingFeeOther FP"="Pricing=Other FP:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeIncentive"="Pricing=Incentive Fee:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeCombination or Other"="Pricing=Comb./or Other:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeOther CB"="Pricing=Other CB:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE:Log(Det. Ind. U.S. Avg. Salary)"

),
                bold=0.05,
custom.note="%stars. Logged inputs are rescaled. For this model, sole source contracts and task orders are treated as having 1 offer.",
caption="Table 1: Regression Model of Log(Number of Offfers)",
caption.above=TRUE)

get_icc(Comp_Cons_15D_1m)


  # OR_m1SD <- exp(fixef(FM_m1SD))
  # CI_m1SD <- exp(confint(FM_m1SD,parm="beta_")) 
  # 
  # OR_p1SD <- exp(fixef(FM_p1SD))
  # CI_p1SD <- exp(confint(FM_p1SD,parm="beta_")) 
  # 
  # OR.CI<-rbind(cbind(OR,CI), cbind(OR_m1SD,CI_m1SD)[3,], cbind(OR_p1SD,CI_p1SD)[3,])
  # rownames(OR.CI)<-c(rownames(cbind(OR,CI)), "teacher_fan_c_m1SD", "teacher_fan_c_p1SD")
  # OR.CI


gridExtra::grid.arrange(dotplot(ranef(Comp_Cons_15D, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             nrow=1)

```

## Ceiling Breach Model
```{r Output-CBre}
stargazer::stargazer(CBre_Cons_13B_1m,CBre_Comp_13C_1m,CBre_Cons_Comp_15A_1m,type="text",
                       digits=2)
# texreg::htmlreg(list(Term_Cons_08A3,
#                   CBre_Cons_08C),#CBre_Cons_08B2
#                 file="Output//ConsModel.html",single.row = TRUE,
#                 custom.model.name=c("Termination",
#                                     "Ceiling Breach"),
#                         stars=c(0.05))


# texreg::htmlreg(list(CBre_Cons_13B,CBre_Comp_13C,CBre_Cons_Comp_15A),file="Output//CBre_Model.html",single.row = TRUE,
#                 custom.model.name=c("Consolidation",
#                                     "Competition",
#                                     "Both"),
#                         stars=c(0.05,0.01,0.001))


texreg::htmlreg(list(CBre_Cons_13B.restart,CBre_Comp_13C,CBre_Cons_Comp_15A),file="Output//CBre_Model.html",
                single.row = TRUE,
                custom.model.name=c("Concentration",
                                    "Competition",
                                    "Both"),
                        stars=c(0.1,0.05,0.01,0.001),
                groups = list("Study Variables" = 2:7,
                              "NAICS Characteristics" = 8:11,
                              "Contract Characteristics"=12:24,
"Interactions" = 25:31),
                custom.coef.map=list("(Intercept)"="(Intercept)",
                "cl_def3_HHI_lag1"="Log(Subsector HHI)",
"cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
"CompOffr1 offer"="Comp=1 offer",
"CompOffr2 offers"="Comp=2 offers",
"CompOffr3-4 offers"="Comp=3-4 offers",
"CompOffr5+ offers"="Comp=5+ offers",
"cl_def3_ratio_lag1"="Log(Subsector Ratio)",
"cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
"cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
"cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
"cl_Ceil"="Log(Init. Ceiling)",
"capped_cl_Days"="Log(Init. Days)",
"VehS-IDC"="Vehicle=S-IDC",
"VehM-IDC"="Vehicle=M-IDC",
"VehFSS/GWAC"="Vehicle=FSS/GWAC",
"VehBPA/BOA"="Vehicle=BPA/BOA",
"PricingFeeOther FP"="Pricing=Other FP",
"PricingFeeIncentive"="Pricing=Incentive Fee",
"PricingFeeCombination or Other"="Pricing=Combination or Other",
"PricingFeeOther CB"="Pricing=Other CB",
"PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
"b_UCA"="UCA",
"b_Intl"="Performed Abroad",
# "cl_def6_HHI_lag1:capped_cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
"cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
# "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)"),
"cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
"cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
"CompOffr1 offer:b_UCA"="Comp=1 offer:UCA",
"CompOffr2 offers:b_UCA"="Comp=2 offers:UCA",
"CompOffr3-4 offers:b_UCA"="Comp=3-4 offers:UCA",
"CompOffr5+ offers:b_UCA"="Comp=5+ offers:UCA"
),
                bold=0.05,
custom.note="%stars. Logged inputs are rescaled.",
caption="Table 2: Logit Model Results for Ceiling Breaches",
caption.above=TRUE)



texreg::htmlreg(list(CBre_Cons_13B_1m,CBre_Comp_13C_1m,CBre_Cons_Comp_15A_1m),file="Output//CBre_Model_1m.html",
                single.row = TRUE,
                custom.model.name=c("Concentration",
                                    "Competition",
                                    "Both"),
                        stars=c(0.1,0.05,0.01,0.001),
                groups = list("Study Variables" = 2:7,
                              "NAICS Characteristics" = 8:11,
                              "Contract Characteristics"=12:24,
"Interactions" = 25:31),
                custom.coef.map=list("(Intercept)"="(Intercept)",
                "cl_def3_HHI_lag1"="Log(Subsector HHI)",
"cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
"CompOffr1 offer"="Comp=1 offer",
"CompOffr2 offers"="Comp=2 offers",
"CompOffr3-4 offers"="Comp=3-4 offers",
"CompOffr5+ offers"="Comp=5+ offers",
"cl_def3_ratio_lag1"="Log(Subsector Ratio)",
"cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
"cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
"cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
"cl_Ceil"="Log(Init. Ceiling)",
"capped_cl_Days"="Log(Init. Days)",
"VehS-IDC"="Vehicle=S-IDC",
"VehM-IDC"="Vehicle=M-IDC",
"VehFSS/GWAC"="Vehicle=FSS/GWAC",
"VehBPA/BOA"="Vehicle=BPA/BOA",
"PricingFeeOther FP"="Pricing=Other FP",
"PricingFeeIncentive"="Pricing=Incentive Fee",
"PricingFeeCombination or Other"="Pricing=Combination or Other",
"PricingFeeOther CB"="Pricing=Other CB",
"PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
"b_UCA"="UCA",
"b_Intl"="Performed Abroad",
# "cl_def6_HHI_lag1:capped_cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
"cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
# "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)"),
"cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
"cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
"CompOffr1 offer:b_UCA"="Comp=1 offer:UCA",
"CompOffr2 offers:b_UCA"="Comp=2 offers:UCA",
"CompOffr3-4 offers:b_UCA"="Comp=3-4 offers:UCA",
"CompOffr5+ offers:b_UCA"="Comp=5+ offers:UCA"
),
                bold=0.05,
custom.note="%stars. Logged inputs are rescaled.",
caption="Table 2: Logit Model Results for Ceiling Breaches",
caption.above=TRUE)




or1<-odds_ratio(CBre_Cons_13B.restart,"CBre_Cons_13B","Concentration","Ceiling Breaches")
or2<-odds_ratio(CBre_Comp_13C,"CBre_Comp_13C","Competition","Ceiling Breaches")
or3<-odds_ratio(CBre_Cons_Comp_15A,"CBre_Cons_Comp_15A","Both","Ceiling Breaches")
comp.or<-rbind(or1,or2,or3)

write.csv(get_study_variables_odds_ratio(comp.or),file="Output//ceiling_breach_study_odds_ratio.csv",row.names=FALSE)



or1<-odds_ratio(CBre_Cons_13B_1m,"CBre_Cons_13B_1m","Concentration","Ceiling Breaches")
or2<-odds_ratio(CBre_Comp_13C_1m,"CBre_Comp_13C_1m","Competition","Ceiling Breaches")
or3<-odds_ratio(CBre_Cons_Comp_15A_1m,"CBre_Cons_Comp_15A_1m","Both","Ceiling Breaches")
comp.or<-rbind(or1,or2,or3)

write.csv(get_study_variables_odds_ratio(comp.or),file="Output//ceiling_breach_study_odds_ratio_1m.csv",row.names=FALSE)
get_icc(CBre_Cons_Comp_15A_1m)

#https://www.lcampanelli.org/mixed-effects-modeling-lme4/
gridExtra::grid.arrange(dotplot(ranef(CBre_Cons_13B.restart, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             dotplot(ranef(CBre_Comp_13C, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             dotplot(ranef(CBre_Cons_Comp_15A, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             nrow=1)


```


## Terminations Model
```{r Output-CBre}

# texreg::htmlreg(list(Term_Cons_08A3,
#                   CBre_Cons_08C),#CBre_Cons_08B2
#                 file="Output//ConsModel.html",single.row = TRUE,
#                 custom.model.name=c("Termination",
#                                     "Ceiling Breach"),
#                         stars=c(0.05))



texreg::htmlreg(list(Term_Cons_13E,Term_Comp_13F,Term_Cons_Comp_14C),file="Output//Term_Model.html",
                single.row = TRUE,
                custom.model.name=c("Concentration",
                                    "Competition",
                                    "Both"
                ),
                stars=c(0.1,0.05,0.01,0.001),
                groups = list("Study Variables" = 2:7,
                              "NAICS Characteristics" = 8:11,
                              "Contract Characteristics"=12:24,
                              # "Contract Initial Scope" = 12:13,
                              # "Contract Vehicle (Baseline=def_serv. Award" = 14:18,
                              # "Contract Pricing (Baseline=FFP)" = 19:24,
                              # "Place of Performance" = 25,
                              "Interactions" = 25:27),
                custom.coef.map=list(
                  "(Intercept)"="(Intercept)",
                  
                  "cl_def3_HHI_lag1"="Log(Subsector HHI)",
                  "cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
                  
                  "CompOffr1 offer"="Comp=1 offer",
                  "CompOffr2 offers"="Comp=2 offers",
                  "CompOffr3-4 offers"="Comp=3-4 offers",
                  "CompOffr5+ offers"="Comp=5+ offers",
                  "cl_def3_ratio_lag1"="Log(Subsector Ratio)",
                  "cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
                  "cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
                  "cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_Ceil"="Log(Init. Ceiling)",
                  "cl_Days"="Log(Init. Days)",
                  "VehS-IDC"="Vehicle=S-IDC",
                  "VehM-IDC"="Vehicle=M-IDC",
                  "VehFSS/GWAC"="Vehicle=FSS/GWAC",
                  "VehBPA/BOA"="Vehicle=BPA/BOA",
                  "PricingFeeOther FP"="Pricing=Other FP",
                  "PricingFeeIncentive"="Pricing=Incentive Fee",
                  "PricingFeeCombination or Other"="Pricing=Combination or Other",
                  "PricingFeeOther CB"="Pricing=Other CB",
                  "PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
                  "b_UCA"="UCA",
                  "b_Intl"="Performed Abroad",
                  "cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
                  "cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
                  "cl_def6_HHI_lag1:cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
                  "cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
                  "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)",
                  "cl_def6_HHI_lag1:cl_def6_ratio_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. Ratio)",
                  "cl_US6_avg_sal_lag1:PricingFeeOther FP"="Pricing=Other FP:Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_US6_avg_sal_lag1:PricingFeeIncentive"="Pricing=Incentive Fee:Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_US6_avg_sal_lag1:PricingFeeCombination or Other"=
                    "Pricing=Comb./or Other:Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_US6_avg_sal_lag1:PricingFeeOther CB"="Pricing=Other CB:Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_US6_avg_sal_lag1:PricingFeeT&M/LH/FPLOE"=
                    "Pricing=T&M/LH/FP:LoE:Log(Det. Ind. U.S. Avg. Salary)"
                  
                ),
                bold=0.05,
                custom.note="%stars. Logged inputs are rescaled.",
                caption="Table 3: Logit Model Results for Terminations",
                caption.above=TRUE)

                       #  b_UCA:cl_Ceil+
                       #  b_UCA:cl_def6_HHI_lag1 +
                       # PricingFee:cl_US6_avg_sal_lag1+


# texreg::htmlreg(list(Term_Cons_13E,Term_Comp_13E2,Term_Cons_Comp_14C,Term_Cons_Comp_14C_1m),file="Output//Term_Model_1m.html",
#                 single.row = TRUE,
#                 custom.model.name=c("Concentration",
#                                     "Competition",
#                                     "Both",
#                                     "Both 1m"
texreg::htmlreg(list(Term_Cons_13E_1m,Term_Comp_13F_1m,Term_Cons_Comp_14C_1m),file="Output//Term_Model_1m.html",
                single.row = TRUE,
                custom.model.name=c("Concentration",
                                    "Competition",
                                    "Both"
                ),
                stars=c(0.1,0.05,0.01,0.001),
                groups = list("Study Variables" = 2:7,
                              "NAICS Characteristics" = 8:11,
                              "Contract Characteristics"=12:24,
                              # "Contract Initial Scope" = 12:13,
                              # "Contract Vehicle (Baseline=def_serv. Award" = 14:18,
                              # "Contract Pricing (Baseline=FFP)" = 19:24,
                              # "Place of Performance" = 25,
                              "Interactions" = 25:27),
                custom.coef.map=list(
                  "(Intercept)"="(Intercept)",
                  
                  "cl_def3_HHI_lag1"="Log(Subsector HHI)",
                  "cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
                  
                  "CompOffr1 offer"="Comp=1 offer",
                  "CompOffr2 offers"="Comp=2 offers",
                  "CompOffr3-4 offers"="Comp=3-4 offers",
                  "CompOffr5+ offers"="Comp=5+ offers",
                  "cl_def3_ratio_lag1"="Log(Subsector Ratio)",
                  "cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
                  "cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
                  "cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_Ceil"="Log(Init. Ceiling)",
                  "cl_Days"="Log(Init. Days)",
                  "VehS-IDC"="Vehicle=S-IDC",
                  "VehM-IDC"="Vehicle=M-IDC",
                  "VehFSS/GWAC"="Vehicle=FSS/GWAC",
                  "VehBPA/BOA"="Vehicle=BPA/BOA",
                  "PricingFeeOther FP"="Pricing=Other FP",
                  "PricingFeeIncentive"="Pricing=Incentive Fee",
                  "PricingFeeCombination or Other"="Pricing=Combination or Other",
                  "PricingFeeOther CB"="Pricing=Other CB",
                  "PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
                  "b_UCA"="UCA",
                  "b_Intl"="Performed Abroad",
                  "cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
                  "cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
                  "cl_def6_HHI_lag1:cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
                  "cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
                  "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)",
                  "cl_def6_HHI_lag1:cl_def6_ratio_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. Ratio)",
                  "cl_US6_avg_sal_lag1:PricingFeeOther FP"="Pricing=Other FP:Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_US6_avg_sal_lag1:PricingFeeIncentive"="Pricing=Incentive Fee:Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_US6_avg_sal_lag1:PricingFeeCombination or Other"=
                    "Pricing=Comb./or Other:Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_US6_avg_sal_lag1:PricingFeeOther CB"="Pricing=Other CB:Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_US6_avg_sal_lag1:PricingFeeT&M/LH/FPLOE"=
                    "Pricing=T&M/LH/FP:LoE:Log(Det. Ind. U.S. Avg. Salary)"
                  
                ),
                bold=0.05,
                custom.note="%stars. Logged inputs are rescaled.",
                caption="Table 3: Logit Model Results for Terminations",
                caption.above=TRUE)

                       #  b_UCA:cl_Ceil+
                       #  b_UCA:cl_def6_HHI_lag1 +
                       # PricingFee:cl_US6_avg_sal_lag1+


gridExtra::grid.arrange(dotplot(ranef(Term_Cons_13E, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             dotplot(ranef(Term_Comp_13E2, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             dotplot(ranef(Term_Cons_Comp_14A, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             nrow=1)
dotplot(ranef(Term_Cons_13E, condVar = T), strip = T, scales=list(relation='free'))$NAICS3


or1<-odds_ratio(Term_Cons_13E,"Term_Cons_13E","Concentration","Ceiling Breaches")
or2<-odds_ratio(Term_Comp_13E2,"Term_Comp_13E2","Competition","Ceiling Breaches")
or3<-odds_ratio(Term_Cons_Comp_14C,"Term_Cons_Comp_14C","Both","Ceiling Breaches")
term.or<-rbind(or1,or2,or3)

write.csv(get_study_variables_odds_ratio(term.or),file="Output//termination_study_odds_ratio.csv",row.names=FALSE)

or1<-odds_ratio(Term_Cons_13E_1m,"Term_Cons_13E_1m","Concentration","Ceiling Breaches")
  or2<-odds_ratio(Term_Comp_13E2,"Term_Comp_13F_1m","Competition","Ceiling Breaches")
or3<-odds_ratio(Term_Cons_Comp_14C_1m,"Term_Cons_Comp_14C_1m","Both","Ceiling Breaches")
term.or<-rbind(or1,or2,or3)

write.csv(get_study_variables_odds_ratio(term.or),file="Output//termination_study_odds_ratio_1m.csv",row.names=FALSE)


```

## Consolidation Odds Ratios

```{r Consolidation}
or_ceil<-odds_ratio(CBre_Cons_Comp_15A,"CBre_Cons_Comp_15A","Both","Ceiling Breaches")
or_term<-odds_ratio(Term_Cons_Comp_14B,"Term_Cons_Comp_14B","Both","Terminations")

cons.or<-rbind(or_ceil,or_term)

write.csv(get_study_variables_odds_ratio(subset(cons.or,variable %in% c("cl_def3_HHI_lag1","cl_def6_HHI_lag1"))),
          file="Output//consolidation_odds_ratio.csv",row.names=FALSE)


or_ceil<-odds_ratio(CBre_Cons_Comp_15A_1m,"CBre_Cons_Comp_15A_1m","Both","Ceiling Breaches")
or_term<-odds_ratio(Term_Cons_Comp_14C_1m,"Term_Cons_Comp_14C_1m","Both","Terminations")

cons.or<-rbind(or_ceil,or_term)

write.csv(get_study_variables_odds_ratio(subset(cons.or,variable %in% c("cl_def3_HHI_lag1","cl_def6_HHI_lag1"))),
          file="Output//consolidation_odds_ratio_1m.csv",row.names=FALSE)


# centered_description(serv_smp1m$def6_HHI_lag1,"subsector HHI score")
# centered_log_description(serv_smp1m$l_def6_HHI_lag1,"detailed industrial HHI score")
# 
# 
# centered_description(serv_smp1m$def3_HHI_lag1,"subsector HHI score")
# centered_log_description(serv_smp1m$l_def3_HHI_lag1,"detailed industrial HHI score")





```

## Competition Odds Ratios
```{r Competition}

or_ceil<-odds_ratio(CBre_Cons_Comp_15A,"CBre_Cons_Comp_15A","Both","Ceiling Breaches")
or_term<-odds_ratio(Term_Cons_Comp_14B,"CBre_Cons_Comp_15A","Both","Terminations")

comp.or<-rbind(or_ceil,or_term)

write.csv(get_study_variables_odds_ratio(subset(comp.or,!variable %in% c("cl_def3_HHI_lag1","cl_def6_HHI_lag1"))),
          file="Output//competition_odds_ratio.csv",row.names=FALSE)



or_ceil<-odds_ratio(CBre_Cons_Comp_15A_1m,"CBre_Cons_Comp_15A_1m","Both","Ceiling Breaches")
or_term<-odds_ratio(Term_Cons_Comp_14C_1m,"CBre_Cons_Comp_15A_1m","Both","Terminations")

comp.or<-rbind(or_ceil,or_term)

write.csv(get_study_variables_odds_ratio(subset(comp.or,!variable %in% c("cl_def3_HHI_lag1","cl_def6_HHI_lag1"))),
          file="Output//competition_odds_ratio_1m.csv",row.names=FALSE)



# dotplot(ranef(Term_Cons_13E, condVar = T), strip = T, scales=list(relation='free'))$NAICS3
```

## Residuals Plot


```{r Residuals, fig.width=7.5 , fig.height=8.5}

residual_cbre<-gridExtra::grid.arrange(
  binned_fitted_versus_residuals(CBre_Cons_13B.restart,bins=50)+
    labs(title="Concentration Binned Actuals",caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
  residuals_plot(CBre_Cons_13B.restart, bins=50)+labs(title="Concentration Binned Residual Plot"),
  binned_fitted_versus_residuals(CBre_Comp_13C,bins=50)+
    labs(title="Competition Binned Actuals Plot",caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
residuals_plot(CBre_Comp_13C, bins=50)+labs(title="Competition Binned Residuals Plot"),
binned_fitted_versus_residuals(CBre_Cons_Comp_15A,bins=50)+
  labs(title="Both Binned Actuals",
       caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
residuals_plot(CBre_Cons_Comp_15A, bins=50)+labs(title="Both Binned Residuals Plot"),ncol=2)

residual_cbre
ggsave(residual_cbre,file="Output//residual_cbre.png",width=7.5, height=8.5)
ggsave(residual_cbre,file="Output//residual_cbre.eps",width=7.5, height=8.5)

residual_term<-gridExtra::grid.arrange(
  binned_fitted_versus_residuals(Term_Cons_13E,bins=50)+
    labs(title="Concentration Binned Actuals",caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
  residuals_plot(Term_Cons_13E, bins=50)+labs(title="Binned Residual Plot"),
  binned_fitted_versus_residuals(Term_Cons_Comp_14B,bins=50)+
    labs(title="Competition Binned Actuals Plot",caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
residuals_plot(Term_Cons_Comp_14B, bins=50)+labs(title="Binned Residuals Plot"),
binned_fitted_versus_residuals(Term_Cons_Comp_14B,bins=50)+
  labs(title="Both Binned Actuals",
       caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
residuals_plot(Term_Cons_Comp_14B, bins=50)+labs(title="Binned Residuals Plot"),ncol=2)


residual_term
ggsave(residual_term,file="Output//residual_term.png",width=7.5, height=8.5)
ggsave(residual_term,file="Output//residual_term.eps",width=7.5, height=8.5)



# debug(residuals_plot)
gridExtra::grid.arrange(residuals_plot(Term_Cons_13E, bins=50)+labs(title="Concentration Binned Residuals Plot"),
residuals_plot(Term_Comp_13E2, bins=50)+labs(title="Competition Binned Residuals Plot"),
residuals_plot(Term_Cons_Comp_14B, bins=50)+labs(title="Both Binned Residuals Plot"),ncol=1)
```


```{r Residuals_250k, fig.width=7.5 , fig.height=8.5}

residual_cbre<-gridExtra::grid.arrange(
  binned_fitted_versus_residuals(CBre_Cons_13B_1m,bins=50)+
    labs(title="Concentration Binned Actuals",caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
  residuals_plot(CBre_Cons_13B_1m, bins=50)+labs(title="Concentration Binned Residual Plot"),
  binned_fitted_versus_residuals(CBre_Comp_13C_1m,bins=50)+
    labs(title="Competition Binned Actuals Plot",caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
residuals_plot(CBre_Comp_13C_1m, bins=50)+labs(title="Competition Binned Residuals Plot"),
binned_fitted_versus_residuals(CBre_Cons_Comp_15A_1m,bins=50)+
  labs(title="Both Binned Actuals",
       caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
residuals_plot(CBre_Cons_Comp_15A_1m, bins=50)+labs(title="Both Binned Residuals Plot"),ncol=2)

residual_cbre
ggsave(residual_cbre,file="Output//residual_cbre_1m.png",width=7.5, height=8.5)
ggsave(residual_cbre,file="Output//residual_cbre_1m.eps",width=7.5, height=8.5)

residual_term<-gridExtra::grid.arrange(
  binned_fitted_versus_residuals(Term_Cons_13E_1m,bins=50)+
    labs(title="Concentration Binned Actuals",caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
  residuals_plot(Term_Cons_13E_1m, bins=50)+labs(title="Binned Residual Plot"),
  binned_fitted_versus_residuals(Term_Comp_13F_1m,bins=50)+
    labs(title="Competition Binned Actuals Plot",caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
residuals_plot(Term_Comp_13F_1m, bins=50)+labs(title="Binned Residuals Plot"),
binned_fitted_versus_residuals(Term_Cons_Comp_14C_1m,bins=50)+
  labs(title="Both Binned Actuals",
       caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
residuals_plot(Term_Cons_Comp_14C_1m, bins=50)+labs(title="Binned Residuals Plot"),ncol=2)


residual_term
ggsave(residual_term,file="Output//residual_term_1m.png",width=7.5, height=8.5)
ggsave(residual_term,file="Output//residual_term_1m.eps",width=7.5, height=8.5)


# debug(residuals_plot)
gridExtra::grid.arrange(residuals_plot(Term_Cons_13E, bins=50)+labs(title="Concentration Binned Residuals Plot"),
residuals_plot(Term_Comp_13E2, bins=50)+labs(title="Competition Binned Residuals Plot"),
residuals_plot(Term_Cons_Comp_14B, bins=50)+labs(title="Both Binned Residuals Plot"),ncol=1)
```