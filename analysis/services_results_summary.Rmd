---
title: "Serices Results Summary"
output:
  html_document:
    keep_md: yes
    toc: yes
date: "Wednesday, July 11, 2019"
---

#Setup
```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(arm)
library(R2WinBUGS)
library(knitr)
library(foreign)
library(stargazer)
library(readr)
library(texreg)
library(reshape2)
library(tidyverse)
source("https://raw.githubusercontent.com/CSISdefense/Vendor/master/Scripts/DIIGstat.r")

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40


```


Contracts are classified using a mix of numerical and categorical variables. While the changes in numerical variables are easy to grasp and summarize, a contract may have one line item that is competed and another that is not. As is detailed in the exploration on R&D, we are only considering information available prior to contract start. The percentage of contract obligations that were competed is a valuable benchmark, but is highly influenced by factors that occured after contract start..


First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from   FPDS.


```{r ReadInData, echo = TRUE}
if(!exists("def_serv")) load("../data/clean/transformed_def_serv.Rdata")
if(!exists("serv_smp")) load(file="../data/clean/def_sample.Rdata")


```

# Pre-Model Graphs
None at present.
# Models
## Loading Models
### Exercised Options
Note that because we use the complete dataset for exercised options, there's no 1 million entry variant.
```{r Model-OptGrowth}
if(file.exists("..//Output//p_Opt_12C.rdata")) load("..//Output//p_Opt_12C.rdata")


if(!exists("p_Opt_12C")){
  p_Opt_12C <- glm (data=serv_opt,
                    lp_OptGrowth ~  cl_US6_avg_sal_lag1Const + 
                      cl_CFTE+ c_pPBSC+c_pOffPSC+
                      c_pairHist+cl_pairCA +
                      cl_Ceil + capped_cl_Days+
                      Comp1or5+
                      Veh+
                      PricingUCA+
                      Crisis+
                      cl_def6_HHI_lag1+cl_def6_ratio_lag1+
                      cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                      c_pMarket+
                      cl_OffVol+cl_office_naics_hhi_k #,
                    # verbose=1
                    )
  glmer_examine(p_Opt_12C)
  save(p_Opt_12C,file="..//Output//p_Opt_12C.rdata")
}

stargazer::stargazer(p_Opt_12C,type="text",
                     digits=2)

#Considering 
# write.csv(exp(summary(p_Opt_12C)$coefficients[,1])-1,file="../Output/exp_p_Opt_12C.csv")
# p_Opt_12C_exp<-log_analysis(p_Opt_12C)

glmer_examine(p_Opt_12C,display=TRUE)
stargazer::stargazer(p_Opt_12C,type="text",
                       digits=2)

```


### Ceiling Breach

```{r Model-CBre}
if(file.exists("..//Output//CBre25A.rda")) load("..//Output//CBre25A.rda")

if(!exists("b_CBre25A")){
  b_CBre25A <- glmer(data=serv_smp, b_CBre ~  cl_US6_avg_sal_lag1Const + 
                       cl_CFTE+ c_pPBSC+c_pOffPSC+
                       c_pairHist+cl_pairCA+
                       cl_Base + cl_Base2Ceil + cl_Days+
                       Comp1or5+
                       Veh+
                       PricingUCA+
                       Crisis+
                       cl_def6_HHI_lag1+cl_def6_ratio_lag1+
                       #cl_def3_HHI_lag1+
                       cl_def3_ratio_lag1+
                       c_pMarket+
                       cl_OffVol+ 
                       #cl_office_naics_hhi_k+ 
                       c_pPBSC:cl_pairCA+c_pPBSC:c_pMarket+
                       c_pPBSC:cl_Days+
                       cl_Base2Ceil:cl_Base+
                       (1 | NAICS3/NAICS/CrisisProductOrServiceArea)+  
                       (1 | Agency/Office) +
                       (1 | PlaceCountryISO3)+ 
                       (1 | StartFY),
                     family=binomial(link="logit"),
                     verbose=TRUE)
  
  
  n_CBre25A <- lmer(data=serv_breach, ln_CBre_OMB20_GDP18 ~ cl_US6_avg_sal_lag1Const + 
                      cl_CFTE+ c_pPBSC+c_pOffPSC+
                      c_pairHist+cl_pairCA+
                      cl_Base + cl_Base2Ceil + cl_Days+
                      Comp1or5+
                      Veh+
                      PricingUCA+
                      Crisis+
                      cl_def6_HHI_lag1+cl_def6_ratio_lag1+
                      #cl_def3_HHI_lag1+
                      cl_def3_ratio_lag1+
                      c_pMarket+
                      cl_OffVol+ 
                      #cl_office_naics_hhi_kc+
                      c_pPBSC:cl_pairCA+
                      (1 | NAICS3/NAICS/CrisisProductOrServiceArea)+  
                      (1 | Agency/Office) +
                      (1 | PlaceCountryISO3)+ 
                      (1 | StartFY),
                    verbose=TRUE)
  
  #Compare the models
  
  
  save(b_CBre25A,n_CBre25A,file="..\\output\\CBre25A.rda")
  
  # b_CBre25A_1m <- glm (data=serv_smp1m,
  #                b_CBre ~  cl_US6_avg_sal_lag1Const + 
  #                  cl_CFTE+ c_pPBSC+c_pOffPSC+
  #                c_pairHist+cl_pairCA +
  #                  cl_Ceil + capped_cl_Days+
  #                  Comp1or5+
  #                  Veh+
  #                  PricingUCA+
  #                  Crisis+
  #                  cl_def6_HHI_lag1+cl_def6_ratio_lag1+
  #                  cl_def3_HHI_lag1+cl_def3_ratio_lag1+
  #                  c_pMarket+
  #                  cl_OffVol+cl_office_naics_hhi_k , family=binomial(link="logit")#,
  #                # verbose=1
  #                )
  
  
}
glmer_examine(b_CBre25A)
glmer_examine(n_CBre25A)

# odds_ratio(b_CBre25A_1m,"b_CBre25A")

# if(!exists("b_CBre25A_restart")){
#   pars<-get_pars(b_CBre25A)
#   b_CBre25A_restart <- update(b_CBre25A, 
#                                      start=pars,
#                                      verbose=1)
#   save(b_CBre25A,
#        b_CBre25A_restart,
#        file="..//output//b_CBre25A.rdata")
# }
# glmer_examine(b_CBre25A_restart)



# 
# save(b_CBre25A,
#      b_CBre25A.devfun,
#      CBre_Cons_13_scgrad,
#      b_CBre25A.restart,
#      CBre_Comp_13B,
#      CBre_Comp_13B.devfun,
#      CBre_Comp_13B.restart,
#      file="..//output//b_CBre25A.rdata")

# source(system.file("utils", "allFit.R", package="lme4"))
# b_CBre25A.all <- allFit(b_CBre25A)
# b_CBre25A_ss_cons <- summary(b_CBre25A.all)



# glmer_examine(b_CBre25A.restart,display=TRUE)
# odds_ratio(b_CBre25A.restart,"b_CBre25A")

```
"Model failed to converge with max|grad| = 0.00750942 (tol = 0.001, component 1)"



### Termination

```{r Model-Term}
if(file.exists("..//Output//term25A.rdata")) load("..//Output//term25A.rdata")



if(!exists("term25A")){
  term25A <- glmer(data=serv_smp, b_Term ~ cl_US6_avg_sal_lag1Const + 
                     cl_CFTE+ c_pPBSC+c_pOffPSC+
                     c_pairHist+cl_pairCA +
                     cl_Base + cl_Days+ cl_Base2Ceil+
                     Comp1or5+
                     Veh+
                     PricingUCA+
                     Crisis+
                     cl_def6_HHI_lag1+cl_def6_ratio_lag1+
                     cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                     c_pMarket+
                     cl_OffVol+cl_office_naics_hhi_k +
                     c_pairHist:PricingUCA+ 
                     cl_Base2Ceil:cl_Ceil+
                     (1 | NAICS3/NAICS/CrisisProductOrServiceArea)+  
                     (1 | Agency/Office) +
                     (1 | PlaceCountryISO3)+ 
                     (1 | StartFY),
                   family=binomial(link="logit"),
                   verbose=TRUE)
  
  #   term25A <- glm (data=serv_smp1m,
  #                  b_Term ~ cl_US6_avg_sal_lag1Const + 
  #                    cl_CFTE+ c_pPBSC+c_pOffPSC+
  #                    c_pairHist+cl_pairCA+
  #                    cl_Ceil + capped_cl_Days+
  #                    Comp1or5+
  #                    Veh+
  #                    PricingUCA+
  #                    Crisis+
  #                    cl_def6_HHI_lag1+cl_def6_ratio_lag1+
  #                    cl_def3_HHI_lag1+cl_def3_ratio_lag1+
  #                    c_pMarket+
  #                    cl_OffVol+cl_office_naics_hhi_k, family=binomial(link="logit")#,
  #                  # verbose=1
  #                  )
  # glmer_examine(term25A)
  
  save(term25A,file="..\\output\\term25A.rdata")
}

glmer_examine(term25A)

```

## Tables for Conference Paper
```{r CoefficientList}
study_coef_list<-list("(Intercept)"="(Intercept)",
                      "cl_US6_avg_sal_lag1Const"="Log(Det. Ind. Salary)",
                      "cl_CFTE"="Log(Service Invoice Rate)",
                      "c_pPBSC"="Office Perf.-Based %",
                      "c_pOffPSC"="Office Service Exp. %",
                      "c_pairHist"="Paired Years",
                      "cl_pairCA"="Log(Paired Actions)"
)


all_coef_list<-list("(Intercept)"="(Intercept)",
                    "cl_US6_avg_sal_lag1Const"="Log(Det. Ind. Salary)",
                    "cl_CFTE"="Log(Service Invoice Rate)",
                    "c_pPBSC"="Office Perf.-Based %",
                    "c_pOffPSC"="Office Service Exp. %",
                    "c_pairHist"="Paired Years",
                    "cl_pairCA"="Log(Paired Actions)",
                    
                    #Contract Controls
                    
                    "Comp1or51 offer"="Comp=1 offer",
                    "Comp1or52-4 offers"="Comp=2-4 offers",
                    "Comp1or55+ offers"="Comp=5+ offers",
                    
                    "CompOffr1 offer"="Comp=1 offer",
                    "CompOffr2 offers"="Comp=2 offers",
                    "CompOffr3-4 offers"="Comp=3-4 offers",
                    "CompOffr5+ offers"="Comp=5+ offers",
                    
                    "cl_Ceil"="Log(Init. Ceiling)",
                    "cl_Base"="Log(Init. Base)",
                    "cl_Base2Ceil"="Log(Ratio Base to Ceiling)",
                    "capped_cl_Days"="Log(Init. Days)",
                    "cl_Days"="Log(Init. Days)",
                    "VehS-IDC"="Vehicle=S-IDC",
                    "VehM-IDC"="Vehicle=M-IDC",
                    "VehFSS/GWAC"="Vehicle=FSS/GWAC",
                    "VehBPA/BOA"="Vehicle=BPA/BOA",
                    "PricingUCAFFP"="Pricing=FFP",
                    "PricingUCAOther FP"="Pricing=Other FP",
                    "PricingUCAIncentive"="Pricing=Incentive Fee",
                    "PricingUCACombination or Other"="Pricing=Combination or Other",
                    "PricingUCAOther CB"="Pricing=Other CB",
                    "PricingUCAT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
                    "PricingUCAUCA"="Pricing=UCA",
                    
                    "PricingFeeOther FP"="Pricing=Other FP",
                    "PricingFeeIncentive"="Pricing=Incentive Fee",
                    "PricingFeeCombination or Other"="Pricing=Combination or Other",
                    "PricingFeeOther CB"="Pricing=Other CB",
                    "PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
                    "b_UCA"="UCA",
                    "CrisisARRA"="Crisis=ARRA",
                    "CrisisDis"="Crisis=Disaster",
                    "CrisisOCO"="Crisis=OCO",
                    "b_Intl"="Performed Abroad",

                    #NAICS
                    "cl_def3_HHI_lag1"="Log(Subsector HHI)",
                    "cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
                    "cl_def3_ratio_lag1"="Log(Subsector Ratio)",
                    "cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
                    "cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
                    #Office
                    "c_pMarket"="Percent Market",
                    "cl_OffVol"="Office Volume",
                    "cl_office_naics_hhi_k"="Office Focus",
                    
                    
                    #interations
                    # # "cl_def6_HHI_lag1:capped_cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
                    # "cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
                    # # "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)"),
                    "cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
                    # "cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
                    # "CompOffr1 offer:b_UCA"="Comp=1 offer:UCA",
                    # "CompOffr2 offers:b_UCA"="Comp=2 offers:UCA",
                    # "CompOffr3-4 offers:b_UCA"="Comp=3-4 offers:UCA",
                    # "CompOffr5+ offers:b_UCA"="Comp=5+ offers:UCA"
                    "VehS-IDC:b_Intl"="Vehicle=S-IDC:Performed Abroad",
                    "VehM-IDC:b_Intl"="Vehicle=M-IDC:Performed Abroad",
                    "VehFSS/GWAC:b_Intl"="Vehicle=FSS/GWAC:Performed Abroad",
                    "VehBPA/BOA:b_Intl"="Vehicle=BPA/BOA:Performed Abroad",
                    "cl_US6_avg_sal_lag1:PricingFeeOther FP"="Pricing=Other FP:Log(Det. Ind. U.S. Avg. Salary)",
                    "cl_US6_avg_sal_lag1:PricingFeeIncentive"="Pricing=Incentive Fee:Log(Det. Ind. U.S. Avg. Salary)",
                    "cl_US6_avg_sal_lag1:PricingFeeCombination or Other"="Pricing=Comb./Other:Log(Det. Ind. U.S. Avg. Salary)",
                    "cl_US6_avg_sal_lag1:PricingFeeOther CB"="Pricing=Other CB:Log(Det. Ind. U.S. Avg. Salary)",
                    "cl_US6_avg_sal_lag1:PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE:Log(Det. Ind. U.S. Avg. Salary)",
                    "c_pairHist:PricingUCAOther FP"="Pricing=Other FP:Log(Det. Ind. U.S. Avg. Salary)",
                    "c_pairHist:PricingUCAT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE:Log(Det. Ind. U.S. Avg. Salary)",
                    "c_pairHist:PricingUCAIncentive"="Pricing=Incentive Fee:Log(Det. Ind. U.S. Avg. Salary)",
                    "c_pairHist:PricingUCAOther CB"="Pricing=Other CB:Log(Det. Ind. U.S. Avg. Salary)",
                    "c_pairHist:PricingUCAUCA"="Pricing=UCA:Log(Det. Ind. U.S. Avg. Salary)",
                    "c_pairHist:PricingUCACombination or Other"="Pricing=Comb./Other:Log(Det. Ind. U.S. Avg. Salary)",
                    "cl_Ceil:cl_Base2Ceil"="Log(Init. Ceiling):Log(Ratio Base to Ceiling)",
                    "c_pPBSC:cl_pairCA"="Office Perf.-Based %:Log(Paired Actions)",
                    "c_pPBSC:c_pMarket"="Office Perf.-Based %:Percent Market",
                    "c_pPBSC:cl_Days"="Office Perf.-Based %:Log(Init. Days)",
                    "cl_Base:cl_Base2Ceil"="Log(Init. Base):Log(Ratio Base to Ceiling)"
                    )


```

### Study Variables Only
```{r StudyVariableSummary}

texreg::htmlreg(list(p_Opt_12C,b_CBre12C_1m,term25A),file="..//Output//study_var_model_lvl1.html",
                single.row = TRUE,
                custom.model.name=c("Exercised Option","Ceiling Breach","Termination"),
                stars=c(0.1,0.05,0.01,0.001),
                groups = list(
                              "Services Complexity" = 2:3,
                              "Office Capacity" =4:5,
                              "Past Relationship"=6:7
                              ),
                custom.coef.map=study_coef_list,
                bold=0.05,
                custom.note="%stars. Numerical inputs are rescaled.",
                caption="Table 6: Study Variables and Outcomes",
                caption.above=TRUE)

```


### All Level 1 Variables

```{r AllVariableSummary}

#Absolute Exercised Options
  stargazer::stargazer(#p_Opt_12C,
                       b_CBre12C_1m,term25A,
                       single.row = TRUE,
                custom.model.name=c("Exercised Option","Ceiling Breach","Termination"),
                stars=c(0.1,0.05,0.01,0.001),
                       type="text",
                       digits=2)


texreg::htmlreg(list(p_Opt_12C,b_CBre12C_1m,term25A),file="..//Output//all_var_model_lvl1.html",
                single.row = TRUE,
                custom.model.name=c("Exercised Option","Ceiling Breach","Termination"),
                stars=c(0.1,0.05,0.01,0.001),
                groups = list(
                              "Services Complexity" = 2:3,
                              "Office Capacity" =4:5,
                              "Past Relationship"=6:7,
                              "Contract Characteristics"=8:25,
                              "NAICS Characteristics" =26:29,
                                                            "Office Characteristics" =30:32
                              
                              ),
                custom.coef.map=all_coef_list,
                bold=0.05,
                custom.note="%stars. Numerical inputs are rescaled.",
                caption="Table 7: All Variables and Outcomes",
                caption.above=TRUE)



```
## Tables for Final Paper


### Ceiling Breach
```{r CeilingResults}

  stargazer::stargazer(#p_Opt_12C,
                       b_CBre25A,n_CBre25A,
                       single.row = TRUE,
                custom.model.name=c("Breach Frequency (Logit)","Breach Size for Breached Contracts (Regression"),
                stars=c(0.1,0.05,0.01,0.001),
                       type="text",
                       digits=2)


texreg::htmlreg(list(b_CBre25A,n_CBre25A),file="..//Output//ceiling_breaches.html",
                single.row = TRUE,
                custom.model.name=c("Likelihood\n(Logit)","Size Given Breach\n(Regression)"),
                stars=c(0.1,0.05,0.01,0.001),
                groups = list(
                              "Services Complexity" = 2:3,
                              "Office Capacity" =4:5,
                              "Past Relationship"=6:7,
                              "Contract Characteristics"=8:26,
                              "NAICS Characteristics" =27:29,
                              "Office Characteristics" =30:31,
                              "Interactions"=32:35
                              ),
                custom.coef.map=all_coef_list,
                bold=0.05,
                custom.note="%stars. Numerical inputs are rescaled.",
                caption="Table 8: Ceiling Breaches",
                caption.above=TRUE)



```

### Terminations

```{r AllVariableSummary}

#Absolute Exercised Options
  stargazer::stargazer(#p_Opt_12C,
                       term25A,
                       single.row = TRUE,
                custom.model.name=c("Termination"),
                stars=c(0.1,0.05,0.01,0.001),
                       type="text",
                       digits=2)


texreg::htmlreg(list(term25A),file="..//Output//terminations.html",
                single.row = TRUE,
                custom.model.name=c("Termination"),
                stars=c(0.1,0.05,0.01,0.001),
                groups = list(
                              "Services Complexity" = 2:3,
                              "Office Capacity" =4:5,
                              "Past Relationship"=6:7,
                              "Contract Characteristics"=8:26,
                              "NAICS Characteristics" =27:30,
                              "Office Characteristics" =31:33,
                              "Interactions"=34:40
                              ),
                custom.coef.map=all_coef_list,
                bold=0.05,
                custom.note="%stars. Numerical inputs are rescaled.",
                caption="Table 7: Terminations",
                caption.above=TRUE)



```


## Odds Ratios



### Exercised Options
```{r Odds-Opt}


comp.or<-odds_ratio(b_CBre25A,"b_CBre25A","Both","Both")
write.csv(get_study_variables_odds_ratio(comp.or),file="..//output//ceiling_breach_study_odds_ratio.csv",row.names=FALSE)
get_icc(b_CBre25A)

#https://www.lcampanelli.org/mixed-effects-modeling-lme4/
gridExtra::grid.arrange(dotplot(ranef(b_CBre25A, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             nrow=1)


```

### Ceiling Breach 
```{r Odds-Term}
comp_or<-odds_ratio(b_CBre25A,output="Breach Likelihood",rename_list=all_coef_list)
  comp_or_walds<-odds_ratio(b_CBre25A,"b_CBre25A",output="Termination Likelihood",walds=TRUE,rename_list=all_coef_list)
# save(comp.or,file="..//Output//comp.or.rdata")
write.csv(get_study_variables_odds_ratio(comp_or_walds,study="services"),file="..//output//ceiling_breach_study_odds_ratio_walds.csv",row.names=FALSE)
get_icc(b_CBre25A)

#https://www.lcampanelli.org/mixed-effects-modeling-lme4/
gridExtra::grid.arrange(dotplot(ranef(b_CBre25A, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             nrow=1)


```


### Terminations 

```{r Odds-Term}


  term_or_walds<-odds_ratio(term25A,"term25A",output="Breach Likelihood",walds=TRUE,rename_list=all_coef_list)
# save(term.or,file="..//Output//term.or.rdata")
write.csv(get_study_variables_odds_ratio(term_or_walds,study="services"),file="..//output//terminations_study_odds_ratio_walds.csv",row.names=FALSE)
get_icc(term25A)


gridExtra::grid.arrange(dotplot(ranef(term25A, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             nrow=1)
dotplot(ranef(term25A, condVar = T), strip = T, scales=list(relation='free'))$NAICS3
 

```


## Residuals Plot


```{r Residuals, fig.width=7.5 , fig.height=8.5}
# debug(binned_fitted_versus_residuals)

(
  terminations_residual<-gridExtra::grid.arrange(
    binned_fitted_versus_residuals(b_CBre25A,bins=50)+
      labs(title="Ceiling Breach Binned Actuals",caption=NULL,
           x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)")
    )
)
ceiling_breach_residual<-gridExtra::grid.arrange(
    residuals_plot(b_CBre25A, bins=50)+labs(title="Ceiling Breach Binned Residual Plot"),
    binned_fitted_versus_residuals(term25A,bins=50)+
      labs(title="Termination Binned Actuals Plot",caption=NULL,
           x="Estimated Pr(Termination)",y="Actual Pr(Termination)"))
)

options_residual<-gridExtra::grid.arrange(
    residuals_plot(term25A, bins=50)+labs(title="Termination Residuals Plot"),
    binned_fitted_versus_residuals(p_Opt_12C,bins=50)+
      labs(title="Exercised Options Actuals",
           caption=NULL,
           x="Estimated % Exercised Option Growth",y="Actual % Exercised Option Growth"),
    residuals_plot(p_Opt_12C, bins=50)+labs(title="Exercised Options Binned Residuals Plot")
    ,ncol=2)
)

ggsave(residual_logit,file="..//output//residual_logit.png",width=7.5, height=8.5)
ggsave(residual_logit,file="..//output//residual_logit.png",width=7.5, height=8.5)

```
