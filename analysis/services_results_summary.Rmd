---
title: "Serices Results Summary"
output:
  html_document:
    keep_md: yes
    toc: yes
date: "Wednesday, July 11, 2019"
---

#Setup
```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(arm)
library(R2WinBUGS)
library(knitr)
library(foreign)
library(stargazer)
library(readr)
library(texreg)
library(reshape2)
library(tidyverse)
source("https://raw.githubusercontent.com/CSISdefense/Vendor/master/Scripts/DIIGstat.r")

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40


```


Contracts are classified using a mix of numerical and categorical variables. While the changes in numerical variables are easy to grasp and summarize, a contract may have one line item that is competed and another that is not. As is detailed in the exploration on R&D, we are only considering information available prior to contract start. The percentage of contract obligations that were competed is a valuable benchmark, but is highly influenced by factors that occured after contract start..


First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from   FPDS.


```{r ReadInData, echo = TRUE}
if(!exists("def_serv")) load("../data/clean/transformed_def_serv.Rdata")
if(!exists("serv_smp")) load(file="../data/clean/def_sample.Rdata")


```

# Pre-Model Graphs
None at present.
# Models
## Loading Models
### Exercised Options
Note that because we use the complete dataset for exercised options, there's no 1 million entry variant.
```{r Model-OptGrowth}
if(file.exists("..//Output//p_Opt_12C.rdata")) load("..//Output//p_Opt_12C.rdata")


if(!exists("p_Opt_12C")){
  p_Opt_12C <- glm (data=serv_opt,
                    ln_OptGrowth ~  cl_US6_avg_sal_lag1Const + 
                      cl_CFTE+ c_pPBSC+c_pOffPSC+
                      c_pairHist+cl_pairCA +
                      cl_Ceil + capped_cl_Days+
                      Comp1or5+
                      Veh+
                      PricingUCA+
                      Crisis+
                      cl_def6_HHI_lag1+cl_def6_ratio_lag1+
                      cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                      c_pMarket+
                      cl_OffVol+cl_hh_index_k #,
                    # verbose=1
                    )
  glmer_examine(p_Opt_12C)
  save(p_Opt_12C,file="..//Output//p_Opt_12C.rdata")
}

stargazer::stargazer(p_Opt_12C,type="text",
                     digits=2)

#Considering 
# write.csv(exp(summary(p_Opt_12C)$coefficients[,1])-1,file="../Output/exp_p_Opt_12C.csv")
# p_Opt_12C_exp<-log_analysis(p_Opt_12C)

glmer_examine(p_Opt_12C,display=TRUE)
stargazer::stargazer(p_Opt_12C,type="text",
                       digits=2)

```


### Ceiling Breach

```{r Model-CBre}
if(file.exists("..//Output//b_CBre12C.rdata")) load("..//Output//b_CBre12C.rdata")

if(!exists("b_CBre12C")){
  b_CBre12C <- glm (data=serv_smp,
                 b_CBre ~  cl_US6_avg_sal_lag1Const + 
                   cl_CFTE+ c_pPBSC+c_pOffPSC+
                 c_pairHist+cl_pairCA +
                   cl_Ceil + capped_cl_Days+
                   Comp1or5+
                   Veh+
                   PricingUCA+
                   Crisis+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+
                   cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   c_pMarket+
                   cl_OffVol+cl_hh_index_k , family=binomial(link="logit")#,
                 # verbose=1
                 )
  
  
  b_CBre12C_1m <- glm (data=serv_smp1m,
                 b_CBre ~  cl_US6_avg_sal_lag1Const + 
                   cl_CFTE+ c_pPBSC+c_pOffPSC+
                 c_pairHist+cl_pairCA +
                   cl_Ceil + capped_cl_Days+
                   Comp1or5+
                   Veh+
                   PricingUCA+
                   Crisis+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+
                   cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   c_pMarket+
                   cl_OffVol+cl_hh_index_k , family=binomial(link="logit")#,
                 # verbose=1
                 )
  
  
  save(b_CBre12C,b_CBre12C_1m,#b_CBre12C,b_CBre12C.restart,
       file="..//output//b_CBre12C.rdata")
}
glmer_examine(b_CBre12C_1m,display=TRUE)
# odds_ratio(b_CBre12C_1m,"b_CBre12C")
stargazer::stargazer(b_CBre12C,b_CBre12C,type="text",
                       digits=2)


# if(!exists("b_CBre12C_restart")){
#   pars<-get_pars(b_CBre12C)
#   b_CBre12C_restart <- update(b_CBre12C, 
#                                      start=pars,
#                                      verbose=1)
#   save(b_CBre12C,
#        b_CBre12C.restart,
#        b_CBre12C,
#        b_CBre12C_restart,
#        file="..//output//b_CBre12C.rdata")
# }
# glmer_examine(b_CBre12C_restart)



# 
# save(b_CBre12C,
#      b_CBre12C.devfun,
#      CBre_Cons_13_scgrad,
#      b_CBre12C.restart,
#      CBre_Comp_13B,
#      CBre_Comp_13B.devfun,
#      CBre_Comp_13B.restart,
#      file="..//output//b_CBre12C.rdata")

# source(system.file("utils", "allFit.R", package="lme4"))
# b_CBre12C.all <- allFit(b_CBre12C)
# b_CBre12C_ss_cons <- summary(b_CBre12C.all)



# glmer_examine(b_CBre12C.restart,display=TRUE)
# odds_ratio(b_CBre12C.restart,"b_CBre12C")

```
"Model failed to converge with max|grad| = 0.00750942 (tol = 0.001, component 1)"



### Termination

```{r Model-Term}
if(file.exists("..//Output//Term_12C.rdata")) load("..//Output//Term_12C.rdata")

if(!exists("Term_12C")){
  Term_12C <- glm (data=serv_smp,
                   b_Term ~ cl_US6_avg_sal_lag1Const + 
                     cl_CFTE+ c_pPBSC+c_pOffPSC+
                     c_pairHist+cl_pairCA+
                     cl_Ceil + capped_cl_Days+
                     Comp1or5+
                     Veh+
                     PricingUCA+
                     Crisis+
                     cl_def6_HHI_lag1+cl_def6_ratio_lag1+
                     cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                     c_pMarket+
                     cl_OffVol+cl_hh_index_k, family=binomial(link="logit")#,
                   # verbose=1
                   )
  glmer_examine(Term_12C)
  
    Term_12C_1m <- glm (data=serv_smp1m,
                   b_Term ~ cl_US6_avg_sal_lag1Const + 
                     cl_CFTE+ c_pPBSC+c_pOffPSC+
                     c_pairHist+cl_pairCA+
                     cl_Ceil + capped_cl_Days+
                     Comp1or5+
                     Veh+
                     PricingUCA+
                     Crisis+
                     cl_def6_HHI_lag1+cl_def6_ratio_lag1+
                     cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                     c_pMarket+
                     cl_OffVol+cl_hh_index_k, family=binomial(link="logit")#,
                   # verbose=1
                   )
  glmer_examine(Term_12C_1m)

  save(Term_12C,Term_12C_1m,file="..//output//Term_12C.rdata")
}

glmer_examine(Term_12C_1m,display=TRUE)
# odds_ratio(Term_12C_1m,"Term_12C")
stargazer::stargazer(Term_12C,Term_12C_1m,type="text",
                       digits=2)

```

## Tables for Paper
```{r CoefficientList}
study_coef_list<-list("(Intercept)"="(Intercept)",
                      "cl_US6_avg_sal_lag1Const"="Log(Det. Ind. Salary)",
                      "cl_CFTE"="Log(Service Invoice Rate)",
                      "c_pPBSC"="Office Perf.-Based %",
                      "c_pOffPSC"="Office Service Exp. %",
                      "c_pairHist"="Paired Years",
                      "cl_pairCA"="Log(Paired Actions)"
)


all_coef_list<-list("(Intercept)"="(Intercept)",
                    "cl_US6_avg_sal_lag1Const"="Log(Det. Ind. Salary)",
                    "cl_CFTE"="Log(Service Invoice Rate)",
                    "c_pPBSC"="Office Perf.-Based %",
                    "c_pOffPSC"="Office Service Exp. %",
                    "c_pairHist"="Paired Years",
                    "cl_pairCA"="Log(Paired Actions)",
                    
                    #Contract Controls
                    
                    "Comp1or51 offer"="Comp=1 offer",
                    "Comp1or52-4 offers"="Comp=2-4 offers",
                    "Comp1or55+ offers"="Comp=5+ offers",
                    
                    "CompOffr1 offer"="Comp=1 offer",
                    "CompOffr2 offers"="Comp=2 offers",
                    "CompOffr3-4 offers"="Comp=3-4 offers",
                    "CompOffr5+ offers"="Comp=5+ offers",
                    
                    "cl_Ceil"="Log(Init. Ceiling)",
                    "capped_cl_Days"="Log(Init. Days)",
                    "VehS-IDC"="Vehicle=S-IDC",
                    "VehM-IDC"="Vehicle=M-IDC",
                    "VehFSS/GWAC"="Vehicle=FSS/GWAC",
                    "VehBPA/BOA"="Vehicle=BPA/BOA",
                    "PricingUCAFFP"="Pricing=FFP",
                    "PricingUCAOther FP"="Pricing=Other FP",
                    "PricingUCAIncentive"="Pricing=Incentive Fee",
                    "PricingUCACombination or Other"="Pricing=Combination or Other",
                    "PricingUCAOther CB"="Pricing=Other CB",
                    "PricingUCAT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
                    "PricingUCAUCA"="Pricing=UCA",
                    
                    "PricingFeeOther FP"="Pricing=Other FP",
                    "PricingFeeIncentive"="Pricing=Incentive Fee",
                    "PricingFeeCombination or Other"="Pricing=Combination or Other",
                    "PricingFeeOther CB"="Pricing=Other CB",
                    "PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
                    "b_UCA"="UCA",
                    "CrisisARRA"="Crisis=ARRA",
                    "CrisisDis"="Crisis=Disaster",
                    "CrisisOCO"="Crisis=OCO",
                    "b_Intl"="Performed Abroad",

                    #NAICS
                    "cl_def3_HHI_lag1"="Log(Subsector HHI)",
                    "cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
                    "cl_def3_ratio_lag1"="Log(Subsector Ratio)",
                    "cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
                    "cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
                    #Office
                    "c_pMarket"="Percent Market",
                    "cl_OffVol"="Office Volume",
                    "cl_hh_index_k"="Office Concentration",
                    
                    
                    #interations
                    # # "cl_def6_HHI_lag1:capped_cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
                    # "cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
                    # # "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)"),
                    "cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
                    # "cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
                    # "CompOffr1 offer:b_UCA"="Comp=1 offer:UCA",
                    # "CompOffr2 offers:b_UCA"="Comp=2 offers:UCA",
                    # "CompOffr3-4 offers:b_UCA"="Comp=3-4 offers:UCA",
                    # "CompOffr5+ offers:b_UCA"="Comp=5+ offers:UCA"
                    "VehS-IDC:b_Intl"="Vehicle=S-IDC:Performed Abroad",
                    "VehM-IDC:b_Intl"="Vehicle=M-IDC:Performed Abroad",
                    "VehFSS/GWAC:b_Intl"="Vehicle=FSS/GWAC:Performed Abroad",
                    "VehBPA/BOA:b_Intl"="Vehicle=BPA/BOA:Performed Abroad",
                    "cl_US6_avg_sal_lag1:PricingFeeOther FP"="Pricing=Other FP:Log(Det. Ind. U.S. Avg. Salary)",
                    "cl_US6_avg_sal_lag1:PricingFeeIncentive"="Pricing=Incentive Fee:Log(Det. Ind. U.S. Avg. Salary)",
                    "cl_US6_avg_sal_lag1:PricingFeeCombination or Other"="Pricing=Comb./or Other:Log(Det. Ind. U.S. Avg. Salary)",
                    "cl_US6_avg_sal_lag1:PricingFeeOther CB"="Pricing=Other CB:Log(Det. Ind. U.S. Avg. Salary)",
                    "cl_US6_avg_sal_lag1:PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE:Log(Det. Ind. U.S. Avg. Salary)"
)


```

### Study Variables Only
```{r StudyVariableSummary}

texreg::htmlreg(list(p_Opt_12C,b_CBre12C_1m,Term_12C_1m),file="..//Output//study_var_model_lvl1.html",
                single.row = TRUE,
                custom.model.name=c("Exercised Option","Ceiling Breach","Termination"),
                stars=c(0.1,0.05,0.01,0.001),
                groups = list(
                              "Services Complexity" = 2:3,
                              "Office Capacity" =4:5,
                              "Past Relationship"=6:7
                              ),
                custom.coef.map=study_coef_list,
                bold=0.05,
                custom.note="%stars. Numerical inputs are rescaled.",
                caption="Table 6: Study Variables and Outcomes",
                caption.above=TRUE)

```


### All Variables

```{r StudyVariableSummary}

#Absolute Exercised Options
  stargazer::stargazer(p_Opt_12C,b_CBre12C_1m,Term_12C_1m,
                       single.row = TRUE,
                custom.model.name=c("Exercised Option","Ceiling Breach","Termination"),
                stars=c(0.1,0.05,0.01,0.001),
                       type="text",
                       digits=2)


texreg::htmlreg(list(p_Opt_12C,b_CBre12C_1m,Term_12C_1m),file="..//Output//all_var_model_lvl1.html",
                single.row = TRUE,
                custom.model.name=c("Exercised Option","Ceiling Breach","Termination"),
                stars=c(0.1,0.05,0.01,0.001),
                groups = list(
                              "Services Complexity" = 2:3,
                              "Office Capacity" =4:5,
                              "Past Relationship"=6:7,
                              "Contract Characteristics"=8:25,
                              "NAICS Characteristics" =26:29,
                                                            "Office Characteristics" =31:33
                              
                              ),
                custom.coef.map=all_coef_list,
                bold=0.05,
                custom.note="%stars. Numerical inputs are rescaled.",
                caption="Table 7: All Variables and Outcomes",
                caption.above=TRUE)



```





```{r Table-OptGrowth}

# texreg::htmlreg(list(Term_Cons_08A3,
#                   CBre_Cons_08C),#CBre_Cons_08B2
#                 file="..//output//ConsModel.html",single.row = TRUE,
#                 custom.model.name=c("Termination",
#                                     "Ceiling Breach"),
#                         stars=c(0.05))


texreg::htmlreg(list(p_Opt_12C),file="..//output//Offr_Model.html",
                single.row = TRUE,
                custom.model.name=c("Concentration"),
                        stars=c(0.1,0.05,0.01,0.001),
                groups = list("Study Variables" = 2:3,
                              "NAICS Characteristics" =4:7,
                              "Contract Characteristics"=8:19,
"Interactions" = 20:24),
                custom.coef.map=list("(Intercept)"="(Intercept)",
                "cl_def3_HHI_lag1"="Log(Subsector HHI)",
"cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
"CompOffr1 offer"="Comp=1 offer",
"CompOffr2 offers"="Comp=2 offers",
"CompOffr3-4 offers"="Comp=3-4 offers",
"CompOffr5+ offers"="Comp=5+ offers",
"cl_def3_ratio_lag1"="Log(Subsector Ratio)",
"cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
"cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
"cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
"cl_Ceil"="Log(Init. Ceiling)",
"capped_cl_Days"="Log(Init. Days)",
"VehS-IDC"="Vehicle=S-IDC",
"VehM-IDC"="Vehicle=M-IDC",
"VehFSS/GWAC"="Vehicle=FSS/GWAC",
"VehBPA/BOA"="Vehicle=BPA/BOA",
"PricingFeeOther FP"="Pricing=Other FP",
"PricingFeeIncentive"="Pricing=Incentive Fee",
"PricingFeeCombination or Other"="Pricing=Combination or Other",
"PricingFeeOther CB"="Pricing=Other CB",
"PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
"b_UCA"="UCA",
"b_Intl"="Performed Abroad",
# # "cl_def6_HHI_lag1:capped_cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
# "cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
# # "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)"),
"cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
# "cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
# "CompOffr1 offer:b_UCA"="Comp=1 offer:UCA",
# "CompOffr2 offers:b_UCA"="Comp=2 offers:UCA",
# "CompOffr3-4 offers:b_UCA"="Comp=3-4 offers:UCA",
# "CompOffr5+ offers:b_UCA"="Comp=5+ offers:UCA"
"VehS-IDC:b_Intl"="Vehicle=S-IDC:Performed Abroad",
"VehM-IDC:b_Intl"="Vehicle=M-IDC:Performed Abroad",
"VehFSS/GWAC:b_Intl"="Vehicle=FSS/GWAC:Performed Abroad",
"VehBPA/BOA:b_Intl"="Vehicle=BPA/BOA:Performed Abroad",
"cl_US6_avg_sal_lag1:PricingFeeOther FP"="Pricing=Other FP:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeIncentive"="Pricing=Incentive Fee:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeCombination or Other"="Pricing=Comb./or Other:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeOther CB"="Pricing=Other CB:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE:Log(Det. Ind. U.S. Avg. Salary)"

),
                bold=0.05,
custom.note="%stars. Logged inputs are rescaled. For this model, sole source contracts and task orders are treated as having 1 offer.",
caption="Table 1: Regression Model of Log(Number of Offfers)",
caption.above=TRUE)


texreg::htmlreg(list(p_Opt_12C),file="..//output//Offr_Model_1m.html",
                single.row = TRUE,
                custom.model.name=c("Concentration"),
                        stars=c(0.1,0.05,0.01,0.001),
                groups = list("Study Variables" = 2:3,
                              "NAICS Characteristics" =4:7,
                              "Contract Characteristics"=8:20,
"Interactions" = 21:25),
                custom.coef.map=list("(Intercept)"="(Intercept)",
                "cl_def3_HHI_lag1"="Log(Subsector HHI)",
"cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
"CompOffr1 offer"="Comp=1 offer",
"CompOffr2 offers"="Comp=2 offers",
"CompOffr3-4 offers"="Comp=3-4 offers",
"CompOffr5+ offers"="Comp=5+ offers",
"cl_def3_ratio_lag1"="Log(Subsector Ratio)",
"cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
"cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
"cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
"cl_Ceil"="Log(Init. Ceiling)",
"capped_cl_Days"="Log(Init. Days)",
"VehS-IDC"="Vehicle=S-IDC",
"VehM-IDC"="Vehicle=M-IDC",
"VehFSS/GWAC"="Vehicle=FSS/GWAC",
"VehBPA/BOA"="Vehicle=BPA/BOA",
"PricingFeeOther FP"="Pricing=Other FP",
"PricingFeeIncentive"="Pricing=Incentive Fee",
"PricingFeeCombination or Other"="Pricing=Combination or Other",
"PricingFeeOther CB"="Pricing=Other CB",
"PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
"b_UCA"="UCA",
"UCAUCA"="UCA",
"b_Intl"="Performed Abroad",
# # "cl_def6_HHI_lag1:capped_cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
# "cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
# # "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)"),
"cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
# "cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
# "CompOffr1 offer:b_UCA"="Comp=1 offer:UCA",
# "CompOffr2 offers:b_UCA"="Comp=2 offers:UCA",
# "CompOffr3-4 offers:b_UCA"="Comp=3-4 offers:UCA",
# "CompOffr5+ offers:b_UCA"="Comp=5+ offers:UCA"
"VehS-IDC:b_Intl"="Vehicle=S-IDC:Performed Abroad",
"VehM-IDC:b_Intl"="Vehicle=M-IDC:Performed Abroad",
"VehFSS/GWAC:b_Intl"="Vehicle=FSS/GWAC:Performed Abroad",
"VehBPA/BOA:b_Intl"="Vehicle=BPA/BOA:Performed Abroad",
"cl_US6_avg_sal_lag1:PricingFeeOther FP"="Pricing=Other FP:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeIncentive"="Pricing=Incentive Fee:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeCombination or Other"="Pricing=Comb./or Other:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeOther CB"="Pricing=Other CB:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE:Log(Det. Ind. U.S. Avg. Salary)"

),
                bold=0.05,
custom.note="%stars. Logged inputs are rescaled. For this model, sole source contracts and task orders are treated as having 1 offer.",
caption="Table 1: Regression Model of Log(Number of Offfers)",
caption.above=TRUE)

get_icc(p_Opt_12C)


  # OR_m1SD <- exp(fixef(FM_m1SD))
  # CI_m1SD <- exp(confint(FM_m1SD,parm="beta_")) 
  # 
  # OR_p1SD <- exp(fixef(FM_p1SD))
  # CI_p1SD <- exp(confint(FM_p1SD,parm="beta_")) 
  # 
  # OR.CI<-rbind(cbind(OR,CI), cbind(OR_m1SD,CI_m1SD)[3,], cbind(OR_p1SD,CI_p1SD)[3,])
  # rownames(OR.CI)<-c(rownames(cbind(OR,CI)), "teacher_fan_c_m1SD", "teacher_fan_c_p1SD")
  # OR.CI


gridExtra::grid.arrange(dotplot(ranef(p_Opt_12C, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             nrow=1)

```

## Odds Ratios

### Ceiling Breach 
```{r Output-CBre}
or1<-odds_ratio(b_CBre12C.restart,"b_CBre12C","Concentration","Ceiling Breaches")
or2<-odds_ratio(CBre_Comp_13C,"CBre_Comp_13C","Competition","Ceiling Breaches")
or3<-odds_ratio(CBre_Cons_Comp_15A,"CBre_Cons_Comp_15A","Both","Ceiling Breaches")
comp.or<-rbind(or1,or2,or3)

write.csv(get_study_variables_odds_ratio(comp.or),file="..//output//ceiling_breach_study_odds_ratio.csv",row.names=FALSE)



or1<-odds_ratio(b_CBre12C,"b_CBre12C","Concentration","Ceiling Breaches")
or2<-odds_ratio(CBre_Comp_13C_1m,"CBre_Comp_13C_1m","Competition","Ceiling Breaches")
or3<-odds_ratio(CBre_Cons_Comp_15A_1m,"CBre_Cons_Comp_15A_1m","Both","Ceiling Breaches")
comp.or<-rbind(or1,or2,or3)

write.csv(get_study_variables_odds_ratio(comp.or),file="..//output//ceiling_breach_study_odds_ratio_1m.csv",row.names=FALSE)
get_icc(CBre_Cons_Comp_15A_1m)

#https://www.lcampanelli.org/mixed-effects-modeling-lme4/
gridExtra::grid.arrange(dotplot(ranef(b_CBre12C.restart, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             dotplot(ranef(CBre_Comp_13C, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             dotplot(ranef(CBre_Cons_Comp_15A, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             nrow=1)


```


### Terminations 

```{r Output-CBre}

gridExtra::grid.arrange(dotplot(ranef(Term_12C, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             dotplot(ranef(Term_Comp_13E2, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             dotplot(ranef(Term_Cons_Comp_14A, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             nrow=1)
dotplot(ranef(Term_12C, condVar = T), strip = T, scales=list(relation='free'))$NAICS3


or1<-odds_ratio(Term_12C,"Term_12C","Concentration","Ceiling Breaches")
or2<-odds_ratio(Term_Comp_13E2,"Term_Comp_13E2","Competition","Ceiling Breaches")
or3<-odds_ratio(Term_Cons_Comp_14C,"Term_Cons_Comp_14C","Both","Ceiling Breaches")
term.or<-rbind(or1,or2,or3)

write.csv(get_study_variables_odds_ratio(term.or),file="..//output//termination_study_odds_ratio.csv",row.names=FALSE)

or1<-odds_ratio(Term_12C_1m,"Term_12C_1m","Concentration","Ceiling Breaches")
  or2<-odds_ratio(Term_Comp_13E2,"Term_Comp_13F_1m","Competition","Ceiling Breaches")
or3<-odds_ratio(Term_Cons_Comp_14C_1m,"Term_Cons_Comp_14C_1m","Both","Ceiling Breaches")
term.or<-rbind(or1,or2,or3)

write.csv(get_study_variables_odds_ratio(term.or),file="..//output//termination_study_odds_ratio_1m.csv",row.names=FALSE)


```


## Residuals Plot


```{r Residuals, fig.width=7.5 , fig.height=8.5}

residual_cbre<-gridExtra::grid.arrange(
  binned_fitted_versus_residuals(b_CBre12C.restart,bins=50)+
    labs(title="Concentration Binned Actuals",caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
  residuals_plot(b_CBre12C.restart, bins=50)+labs(title="Concentration Binned Residual Plot"),
  binned_fitted_versus_residuals(CBre_Comp_13C,bins=50)+
    labs(title="Competition Binned Actuals Plot",caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
residuals_plot(CBre_Comp_13C, bins=50)+labs(title="Competition Binned Residuals Plot"),
binned_fitted_versus_residuals(CBre_Cons_Comp_15A,bins=50)+
  labs(title="Both Binned Actuals",
       caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
residuals_plot(CBre_Cons_Comp_15A, bins=50)+labs(title="Both Binned Residuals Plot"),ncol=2)

residual_cbre
ggsave(residual_cbre,file="..//output//residual_cbre.png",width=7.5, height=8.5)
ggsave(residual_cbre,file="..//output//residual_cbre.eps",width=7.5, height=8.5)

residual_term<-gridExtra::grid.arrange(
  binned_fitted_versus_residuals(Term_12C,bins=50)+
    labs(title="Concentration Binned Actuals",caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
  residuals_plot(Term_12C, bins=50)+labs(title="Binned Residual Plot"),
  binned_fitted_versus_residuals(Term_Cons_Comp_14B,bins=50)+
    labs(title="Competition Binned Actuals Plot",caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
residuals_plot(Term_Cons_Comp_14B, bins=50)+labs(title="Binned Residuals Plot"),
binned_fitted_versus_residuals(Term_Cons_Comp_14B,bins=50)+
  labs(title="Both Binned Actuals",
       caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
residuals_plot(Term_Cons_Comp_14B, bins=50)+labs(title="Binned Residuals Plot"),ncol=2)


residual_term
ggsave(residual_term,file="..//output//residual_term.png",width=7.5, height=8.5)
ggsave(residual_term,file="..//output//residual_term.eps",width=7.5, height=8.5)



# debug(residuals_plot)
gridExtra::grid.arrange(residuals_plot(Term_12C, bins=50)+labs(title="Concentration Binned Residuals Plot"),
residuals_plot(Term_Comp_13E2, bins=50)+labs(title="Competition Binned Residuals Plot"),
residuals_plot(Term_Cons_Comp_14B, bins=50)+labs(title="Both Binned Residuals Plot"),ncol=1)
```


```{r Residuals_250k, fig.width=7.5 , fig.height=8.5}

residual_cbre<-gridExtra::grid.arrange(
  binned_fitted_versus_residuals(b_CBre12C,bins=50)+
    labs(title="Concentration Binned Actuals",caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
  residuals_plot(b_CBre12C, bins=50)+labs(title="Concentration Binned Residual Plot"),
  binned_fitted_versus_residuals(CBre_Comp_13C_1m,bins=50)+
    labs(title="Competition Binned Actuals Plot",caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
residuals_plot(CBre_Comp_13C_1m, bins=50)+labs(title="Competition Binned Residuals Plot"),
binned_fitted_versus_residuals(CBre_Cons_Comp_15A_1m,bins=50)+
  labs(title="Both Binned Actuals",
       caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
residuals_plot(CBre_Cons_Comp_15A_1m, bins=50)+labs(title="Both Binned Residuals Plot"),ncol=2)

residual_cbre
ggsave(residual_cbre,file="..//output//residual_cbre_1m.png",width=7.5, height=8.5)
ggsave(residual_cbre,file="..//output//residual_cbre_1m.eps",width=7.5, height=8.5)

residual_term<-gridExtra::grid.arrange(
  binned_fitted_versus_residuals(Term_12C_1m,bins=50)+
    labs(title="Concentration Binned Actuals",caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
  residuals_plot(Term_12C_1m, bins=50)+labs(title="Binned Residual Plot"),
  binned_fitted_versus_residuals(Term_Comp_13F_1m,bins=50)+
    labs(title="Competition Binned Actuals Plot",caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
residuals_plot(Term_Comp_13F_1m, bins=50)+labs(title="Binned Residuals Plot"),
binned_fitted_versus_residuals(Term_Cons_Comp_14C_1m,bins=50)+
  labs(title="Both Binned Actuals",
       caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
residuals_plot(Term_Cons_Comp_14C_1m, bins=50)+labs(title="Binned Residuals Plot"),ncol=2)


residual_term
ggsave(residual_term,file="..//output//residual_term_1m.png",width=7.5, height=8.5)
ggsave(residual_term,file="..//output//residual_term_1m.eps",width=7.5, height=8.5)


# debug(residuals_plot)
gridExtra::grid.arrange(residuals_plot(Term_12C, bins=50)+labs(title="Concentration Binned Residuals Plot"),
residuals_plot(Term_Comp_13E2, bins=50)+labs(title="Competition Binned Residuals Plot"),
residuals_plot(Term_Cons_Comp_14B, bins=50)+labs(title="Both Binned Residuals Plot"),ncol=1)
```