---
title: "Defense Services Equations"
output:
  word_document: default
  html_document: default
---

# Setup
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from   FPDS.
```{r Libraries, echo = FALSE, message=FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(arm)
library(knitr)
library(foreign)
library(stargazer)
library(texreg)
library(reshape2)
library(tidyverse)
source("https://raw.githubusercontent.com/CSISdefense/Vendor/master/Scripts/DIIGstat.r")

```

# Options

Note that because we use the complete dataset for exercised options, there's no 1 million entry variant.
```{r Model-OptGrowth, echo = FALSE, message=FALSE}
# Deprecated
if(file.exists("..//Output//b_SomeOpt25Cv3.rda")) load("..//Output//b_SomeOpt25Cv3.rda")
# 
if(!exists("b_SomeOpt25Cv3")){
  #Create the model

  b_SomeOpt25Cv3 <- glmer(data=serv_opt, b_SomeOpt ~  cln_US6sal +
                            cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                            cn_PairHist7+cln_PairCA+
                            cln_Base + clr_Ceil2Base + cln_Days+
                            Comp+
                            Veh+
                            Pricing+
                            Crisis+
                            cln_Def6HHI+clr_Def6toUS+
                            cln_Def3HHI+
                            clr_Def3toUS+
                            cp_PairObl7+
                            cln_OffObl7+
                            cln_OffFocus+
                            cp_OffPerf7:cp_PairObl7 +
                            cp_OffPerf7:cln_PairCA +
                            cn_PairHist7:Pricing +
                            cp_PairObl7:cln_OffObl7 +
                            clr_Ceil2Base:cln_Base +
                            pOffPSC:cln_OffObl7 +
                            (1 | NAICS3/NAICS6/ServArea)+
                            (1 | Agency/Office) +
                            (1 | Place)+
                            (1 | StartFY),
                          family=binomial(link="logit"),
                          verbose=TRUE)
  save(b_SomeOpt25Cv3, file="..\\Output\\b_SomeOpt25Cv3.rda")
}


if(file.exists("..//Output//b_AllOpt26A.rda")) load("..//Output//b_AllOpt26A.rda")

if(!exists("b_AllOpt26A")){
  #Create the model
  

  b_AllOpt26A <- glmer(data=serv_exeropt,
                       b_AllOpt ~  cln_US6sal + 
                   cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                 cn_PairHist7+cln_PairCA+
                 cln_Base + clr_Ceil2Base + cln_Days+
                 Comp+
                   Veh+
                   Pricing+
                   Crisis+
                 cln_Def6HHI+clr_Def6toUS+
                 cln_Def3HHI+
                   clr_Def3toUS+
                 cp_PairObl7+
                   cln_OffObl7+ 
                 cln_OffFocus+
                   cp_OffPerf7:cp_PairObl7 + 
                  # cp_OffPerf7:cln_PairCA + 
                   cp_OffPSC7:cln_OffFocus+
                   
                   Pricing:cln_PSCrate+
                      # cp_OffPerf7:cln_Days+
                 # Pricing:cln_PSCrate+
                   cln_OffObl7:cln_OffFocus+
                      (1 | NAICS3/NAICS6/ServArea)+  
                      (1 | Agency/Office) +
                      (1 | Place)+ 
                      (1 | StartFY),
                      family=binomial(link="logit"),
                      verbose=TRUE)
  
  save(b_AllOpt26A,file="..\\output\\b_AllOpt26A.rda")

}
screenreg(list(b_SomeOpt25Cv3,b_AllOpt26A),custom.model.names = c("Some Options","All Options"))

```



## Some Options

## All Options

# Ceiling Breach

```{r Model-CBre, echo = FALSE, message=FALSE}
if(file.exists("..//Output//b_CBre29AB.rda")) load("..//Output//b_CBre29AB.rda")

if(!exists("b_CBre29B")){
  b_CBre29B <- glmer(data=serv_smp1m, b_CBre ~  cln_US6sal +
                       cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                       cn_PairHist7+cln_PairCA+
                       cln_Base + clr_Ceil2Base + cln_Days+
                       Comp+
                       Veh+
                       Pricing+
                       Crisis+
                       cln_Def6HHI+clr_Def6toUS+
                       #cln_Def3HHI+
                       clr_Def3toUS+
                       cp_PairObl7+
                       cln_OffObl7+
                       cln_OffFocus+
                       cp_OffPerf7:cln_PairCA+
                       #cp_OffPerf7:cp_PairObl7+
                       cp_OffPerf7:cln_Days+
                       # clr_Ceil2Base:cln_Base+
                       (1 | NAICS3/NAICS6/ServArea)+
                       (1 | Agency/Office) +
                       (1 | Place)+
                       (1 | StartFY),
                     family=binomial(link="logit"),
                     verbose=TRUE)

}

if(file.exists("..//Output//CBre25A.rda")) load("..//Output//CBre25A.rda")

if(!exists("n_CBre25A")){
    
  n_CBre25A <- lmer(data=serv_breach, ln_CBre ~ cln_US6sal + 
                      cln_PSCrate+ cp_OffPerf7+cp_OffPSC7+
                      cn_PairHist7+cln_PairCA+
                      cln_Base + clr_Ceil2Base + cln_Days+
                      Comp+
                      Veh+
                      Pricing+
                      Crisis+
                      cln_Def6HHI+clr_Def6toUS+
                      #cln_Def3HHI+
                      clr_Def3toUS+
                      cp_PairObl7+
                      cln_OffObl7+ 
                      #cl_office_NAICS6_hhi_kc+
                      cp_OffPerf7:cln_PairCA+
                      (1 | NAICS3/NAICS6/ServArea)+  
                      (1 | Agency/Office) +
                      (1 | Place)+ 
                      (1 | StartFY),
                    verbose=TRUE)
  
  save(n_CBre25A,file="..\\output\\n_CBre25A.rda")
}

screenreg(list(b_CBre29B,n_CBre25A),custom.model.names = c("Breach Likelihood","Breach Size"))
```

## Breach Likelihood

$Estimated~Probability(y_i = 1)~=~Logit^{-1}(α~+~α^{NAICS3}_{j[i]}~+~α^{NAICS6:NAICS3}_{k[i]}~+$

$α^{NAICS6:NAICS3:ServArea}_{l[i]}~+~α^{Agency}_{m[i]}~+~α^{Office:Agency}_{m[i]}~+α^{Place}_{n[i]}~+~α^{StartFY}_{o[i]}~+$

$β_{1}cln\_US6sal_{i}~+~β_{2}cln\_PSCrate_{i}~+~β_{3}cp\_OffPerf7_{i}~+~β_{4}cp\_OffPSC7_{i}~+$

$β_{5}cn\_PairHist7_{i}~+~β_{6}cln\_PairCA_{i}~+~β_{7}cln\_Base_{i}~+~β_{8}clr\_Ceil2Base_{i}~+$

$β_{9}cln\_Days_{i}~+~(~β_{10}1Offr_{i}~+~β_{11}2–4Offr_{i}+~β_{12}5plusOffr_{i}~)~+~(~β_{13}SIDC_{i}~+$

$β_{14}MIDC_{i}+~β_{15}FSS–GWAC_{i}+~β_{16}BPA–BOA_{i}~)~+~(~β_{17}Other\_FP_{i}~+~β_{18}Incentive_{i}~+$

$β_{19}Comb–Other_{i}~+~β_{20}Other\_CB_{i}~+~β_{21}TM–LH–FPLOE_{i}~+~β_{22}UCA_{i}~)~+$

$(~β_{23}OCO_{i}~+~β_{24}ARRA_{i}~+~β_{25}Dis_{i}~+~β_{26}clr\_Def3toUS{i}~+~β_{27}cln\_Def6HHI_{i}~+$

$β_{28}clr\_Def6toUS_{i}~+~β_{29}cp\_PairObl7_{i}~+~β_{30}cln\_OffObl7_{i}~+~β_{31}cln\_OffFocus_{i}~+$

$β_{32}cln\_OffPerf7_{i}·cln\_PairCA_{i}~+~β_{33}cln\_OffPerf7_{i}·cln\_Days_{i},$

$~~~for~i=  1~to~1,000,000$

$$a^{NAICS3}_{j}\sim~N(μ_{α},σ^{2}_{α}),~for~j= 1~to~82;$$
$$a^{NAICS3:NAICS6}_{k}\sim~N(μ_{α},σ^{2}_{α}),~for~k= 1~to~878;$$
$$a^{NAICS3:NAICS6:ServArea}_{l}\sim~N(μ_{α},σ^{2}_{α}),~for~l= 1~to~3,242;$$
$$a^{Agency}_{m}\sim~N(μ_{α},σ^{2}_{α}),~for~m= 1~to~26$$
$$a^{Agency:Office}_{n}\sim~N(μ_{α},σ^{2}_{α}),~for~n= 1~to~1,092$$
$$a^{Place}_{n}\sim~N(μ_{α},σ^{2}_{α}),~~~~for~n= 1~to~186$$
$$a^{StartFY}_{o}\sim~N(μ_{α},σ^{2}_{α}),~for~o= 1~to~9$$

## Breach Size

$Estimated~Log(y_i)~=~α~+~α^{NAICS3}_{j[i]}~+~α^{NAICS6:NAICS3}_{k[i]}~+~α^{NAICS6:NAICS3:ServArea}_{l[i]}~+$

$α^{Agency}_{m[i]}~+~α^{Office:Agency}_{m[i]}~+~α^{Place}_{n[i]}~+~α^{StartFY}_{o[i]}~+~β_{1}cln\_US6sal_{i}~+$

$β_{2}cln\_PSCrate_{i}~+~β_{3}cp\_OffPerf7_{i}~+~β_{4}cp\_OffPSC7_{i}~+~β_{5}cn\_PairHist7_{i}~+$

$β_{6}cln\_PairCA_{i}~+~β_{7}cln\_Base_{i}~+~β_{8}clr\_Ceil2Base_{i}~+~β_{9}cln\_Days_{i}~+$

$(~β_{10}1Offr_{i}~+~β_{11}2–4Offr_{i}+~β_{12}5plusOffr_{i}~)~+~(~β_{13}SIDC_{i}~+~β_{14}MIDC_{i}~+~$

$β_{15}FSS–GWAC_{i}+~β_{16}BPA–BOA_{i}~)~+~(~β_{17}Other\_FP_{i}~+~β_{18}Incentive_{i}~+$

$β_{19}Comb–Other_{i}~+~β_{20}Other\_CB_{i}~+~β_{21}TM–LH–FPLOE_{i}~+~β_{22}UCA_{i}~)~+$

$(~β_{23}OCO_{i}~+~β_{24}ARRA_{i}~+~β_{25}Dis_{i}~+~β_{26}clr\_Def3toUS{i}~+~β_{27}cln\_Def6HHI_{i}~+$

$β_{28}clr\_Def6toUS_{i}~+~β_{29}cp\_PairObl7_{i}~+~β_{30}cln\_OffObl7_{i}~+$

$β_{32}cp\_OffPerf7_{i}·cln\_PairCA_{i}, for~i=  1~to~1,000,000$

$$a^{NAICS3}_{j}\sim~N(μ_{α},σ^{2}_{α}),~~~~for~j=1~to~75$$
$$a^{NAICS6:NAICS3}_{k}\sim~N(μ_{α},σ^{2}_{α}),~~~~for~k= 1~to~557$$
$$a^{ServArea:NAICS6:NAICS3}_{k}\sim~N(μ_{α},σ^{2}_{α}),~~~~for~l= 1~to~1,292$$
$$a^{Agency}_{l}\sim~N(μ_{α},σ^{2}_{α}),~~~~for~l= 1~to~24$$
$$a^{Office:Agency}_{m}\sim~N(μ_{α},σ^{2}_{α}),~~~~for~m= 1~to~656$$
$$a^{Place}_{n}\sim~N(μ_{α},σ^{2}_{α}),~~~~for~n= 1~to~123$$
$$a^{StartFY}_{o}\sim~N(μ_{α},σ^{2}_{α}),~~~~for~o= 1~to~9$$


#Terminations

```{r Model-Term, echo = FALSE, message=FALSE}
if(file.exists("..//Output//term25B.rdata")) load("..//Output//term25B.rdata")

if(!exists("term25B")){

  term25B <- glmer(data=serv_smp1m, b_Term ~ cl_US6_avg_sal_lag1Const + 
                     cl_CFTE+ c_pPBSC+c_pOffPSC+
                     c_pairHist+cl_pairCA +
                     cl_Base + cln_Days+ cl_Base2Ceil+
                     Comp+
                     Veh+
                     Pricing+
                     Crisis+
                     cl_def6_HHI_lag1+cl_def6_ratio_lag1+
                     cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                     c_pMarket+
                     cl_OffVol+cl_office_naics_hhi_k +
                     c_pairHist:Pricing+ 
                     (1 | NAICS3/NAICS/CrisisProductOrServiceArea)+  
                     (1 | Agency/Office) +
                     (1 | PlaceCountryISO3)+ 
                     (1 | StartFY),
                   family=binomial(link="logit"),
                   verbose=TRUE)
  
  save(term25A,term25B,file="..\\output\\term25AB.rdata")
}

screenreg(term25B,custom.model.names = c("Termination Likelihood"))




```

$Estimated~Probability(y_i = 1)~=~Logit^{-1}(α~+~α^{NAICS3}_{j[i]}~+~α^{NAICS6:NAICS3}_{k[i]}~+$

$α^{NAICS6:NAICS3:ServArea}_{l[i]}~+~α^{Agency}_{m[i]}~+~α^{Office:Agency}_{m[i]}~+α^{Place}_{n[i]}~+~α^{StartFY}_{o[i]}~+$

$β_{1}cln\_US6sal_{i}~+~β_{2}cln\_PSCrate_{i}~+~β_{3}cp\_OffPerf7_{i}~+~β_{4}cp\_OffPSC7_{i}~+$

$β_{5}cn\_PairHist7_{i}~+~β_{6}cln\_PairCA_{i}~+~β_{7}cln\_Base_{i}~+~β_{8}clr\_Ceil2Base_{i}~+$

$β_{9}cln\_Days_{i}~+~(~β_{10}1Offr_{i}~+~β_{11}2–4Offr_{i}+~β_{12}5plusOffr_{i}~)~+~(~β_{13}SIDC_{i}~+$

$β_{14}MIDC_{i}+~β_{15}FSS–GWAC_{i}+~β_{16}BPA–BOA_{i}~)~+~(~β_{17}Other\_FP_{i}~+~β_{18}Incentive_{i}~+$

$β_{19}Comb–Other_{i}~+~β_{20}Other\_CB_{i}~+~β_{21}TM–LH–FPLOE_{i}~+~β_{22}UCA_{i}~)~+$

$(~β_{23}OCO_{i}~+~β_{24}ARRA_{i}~+~β_{25}Dis_{i}~+~β_{26}clr\_Def3toUS{i}~+~β_{27}cln\_Def6HHI_{i}~+$

$β_{28}clr\_Def6toUS_{i}~+~β_{29}cp\_PairObl7_{i}~+~β_{30}cln\_OffObl7_{i}~+~β_{31}cln\_OffFocus_{i}~+$

$(β_{32}cln\_Base_{i}·Other\_FP_{i}~+~β_{33}cln\_Base_{i}·Incentive_{i}~+$

$β_{34}cln\_Base_{i}·Comb–Other_{i}~+~β_{35}cln\_Base_{i}·Other\_CB_{i}~+$

$β_{36}cln\_Base_{i}·TM–LH–FPLOE_{i}~+~β_{37}cln\_Base_{i}·UCA_{i}~),~~~~for~i=1~to~1,000,000$

$$a^{NAICS3}_{j}\sim~N(μ_{α},σ^{2}_{α}),~~~~for~j=1~to~82$$
$$a^{NAICS6:NAICS3}_{k}\sim~N(μ_{α},σ^{2}_{α}),~~~~for~k= 1~to~878$$
$$a^{ServArea:NAICS6:NAICS3}_{k}\sim~N(μ_{α},σ^{2}_{α}),~~~~for~l= 1~to~3,242$$
$$a^{Agency}_{l}\sim~N(μ_{α},σ^{2}_{α}),~~~~for~l= 1~to~26$$
$$a^{Office:Agency}_{m}\sim~N(μ_{α},σ^{2}_{α}),~~~~for~m= 1~to~1,092$$
$$a^{Place}_{n}\sim~N(μ_{α},σ^{2}_{α}),~~~~for~n= 1~to~186$$
$$a^{StartFY}_{o}\sim~N(μ_{α},σ^{2}_{α}),~~~~for~o= 1~to~9$$

